<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VVIP25</title>
  <link rel="icon" type="image/png" sizes="64x64" href="/favicon-64.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon-192.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" href="/favicon.ico?v=3">
  <meta name="theme-color" content="#0b0b0c"/>
  <style>
    :root{--bg:#0b0b0c;--fg:#eceff4;--muted:#9aa0a6;--card:#141416;--border:#26272b;--accent:#6ee7b7}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 -apple-system,BlinkMacSystemFont,"Helvetica Neue",Helvetica,Arial,"Segoe UI",Roboto,Inter,system-ui,sans-serif}
    .wrap{max-width:920px;margin:0 auto;padding:16px}

    html{-webkit-text-size-adjust:100%}
    input,select,button{font-size:16px}
    @media (max-width:560px){
      body{font-size:15px}
      header{gap:8px}
      #site-title{font-size:44px;-webkit-text-stroke:1.5px #fdf6d0}
      .wrap{padding:12px}
      .row{grid-template-columns:auto 1fr auto;padding:8px 10px;min-height:64px}
      .badge .pill{padding:3px 8px;font-size:11px}
    }

    header{display:flex;align-items:center;justify-content:space-between;gap:12px;position:relative}
    #site-title{margin:0;font-size:56px;font-weight:bold;font-family:"Helvetica Neue",Helvetica,Arial,sans-serif;color:transparent;-webkit-text-fill-color:transparent;-webkit-text-stroke:2px #fdf6d0}

    .player{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(11,11,12,.97),rgba(11,11,12,.92));backdrop-filter:saturate(120%) blur(8px);border-bottom:1px solid var(--border)}
    .now{display:grid;grid-template-columns:auto 1fr auto;gap:12px;align-items:center;padding:12px 0}
    .cover{width:56px;height:56px;border-radius:8px;background:#1e1f24;display:grid;place-items:center;color:var(--muted);font-weight:700;border:1px solid var(--border)}
    .meta{min-width:0}
    .title{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .sub{color:var(--muted);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .controls{display:flex;align-items:center;gap:8px}
    button{appearance:none;background:var(--card);color:var(--fg);border:1px solid var(--border);border-radius:10px;padding:8px 12px;cursor:pointer}
    button:disabled{opacity:.55;cursor:not-allowed}
    .range{display:flex;align-items:center;gap:8px}
    input[type="range"]{width:160px}
    .list{margin:12px 0 40px;border:1px solid var(--border);border-radius:14px;overflow:hidden}
    .row{display:grid;grid-template-columns:56px 1fr auto;gap:12px;align-items:center;padding:10px 12px;border-top:1px solid var(--border);background:var(--card);min-height:78px}
    .row:first-child{border-top:0}
    .row:hover{background:#17171b}
    .badge{display:flex;gap:10px;align-items:center;font-size:12px;justify-self:end}
    .badge a{color:var(--fg);text-decoration:none;border:1px solid var(--border);padding:4px 8px;border-radius:8px}
    .badge .muted{color:var(--muted)}
    .kbd{font:12px/1.2 ui-monospace,Menlo,Consolas;background:#1b1c20;border:1px solid #2a2b30;border-radius:6px;padding:2px 6px;color:#d7dae0}

    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    select{background:var(--card);color:var(--fg);border:1px solid var(--border);border-radius:10px;padding:8px 10px}
    .tog,.btn{
      display:inline-flex;align-items:center;justify-content:center;
      height:36px;min-width:36px;padding:0 10px;
      border-radius:10px;border:1px solid var(--border);background:var(--card);
      text-decoration:none;color:var(--fg);line-height:1
    }
    .tog{opacity:.6;transition:opacity .15s, box-shadow .15s}
    .tog.on{opacity:1;box-shadow:0 0 0 2px var(--accent) inset}

    details.menu{position:static}
    details.menu>summary{cursor:pointer;list-style:none;background:var(--card);border:1px solid var(--border);padding:8px 12px;border-radius:10px;user-select:none}
    .sheet{position:absolute;top:calc(100% + 8px);right:0;z-index:20;width:min(420px,calc(100vw - 32px));background:var(--card);border:1px solid var(--border);border-radius:10px;padding:10px;display:none;box-shadow:0 10px 24px rgba(0,0,0,.35)}
    details.menu[open]>.sheet{display:block}
    details.menu[open]>summary{border-bottom-left-radius:10px;border-bottom-right-radius:10px}

    @supports (-webkit-touch-callout:none){.range[title="Volume"]{display:none !important}}

    /* Light mode theme */
    body.light{--bg:#f7f7f8;--fg:#111;--muted:#4b5563;--card:#ffffff;--border:#d1d5db;--accent:#2563eb}
    body.light .player{background:linear-gradient(180deg,rgba(255,255,255,.96),rgba(255,255,255,.92))}
    body.light #site-title{-webkit-text-stroke:2px #111}

    @media (max-width:560px){
      .now{grid-template-columns:1fr;gap:8px}
      .cover{display:none}
      .controls{flex-wrap:wrap}
      .range input[type="range"]{width:120px}
      .row{grid-template-columns:1fr auto}
    }
  </style>
</head>
<body>
  <!-- Sticky player/header -->
  <div class="player">
    <div class="wrap">
      <header>
        <h1 id="site-title">VVIP25</h1>
        <details class="menu" id="menu">
          <summary>â˜° Menu</summary>
          <div class="sheet">
            <div class="toolbar" id="toolbar">
              <select id="sort" title="Sort">
                <option value="date_desc">Newest</option>
                <option value="date_asc">Oldest</option>
                <option value="bpm_desc">BPM â†“</option>
                <option value="bpm_asc">BPM â†‘</option>
                <option value="len_desc">Longest</option>
                <option value="len_asc">Shortest</option>
              </select>
              <button class="tog on" id="togTitles" title="Song Titles (on/off)">ğŸ“</button>
              <button class="tog" id="togWav" title="Show WAV buttons">ğŸšï¸</button>
              <button class="tog" id="togMov" title="Show MOV buttons">ğŸ¬</button>
              <button class="tog" id="togTrk" title="Show Trinkets">ğŸ’</button>
              <button class="tog" id="togLight" title="Light mode">ğŸŒ</button>
              <button class="btn" id="btnAbout" title="About">â„¹ï¸</button>
              <a class="btn" id="btnShop" href="/shoppe/" title="Shop">ğŸ›ï¸</a>
            </div>
          </div>
        </details>
      </header>

      <div class="now">
        <div class="cover" id="cover">V25</div>
        <div class="meta">
          <div class="title" id="now-title">â€”</div>
          <div class="sub" id="now-sub">Ready</div>
        </div>
        <div class="controls">
          <button id="prev" aria-label="Previous">â®ï¸</button>
          <button id="toggle" aria-label="Play/Pause">â–¶ï¸</button>
          <button id="next" aria-label="Next">â­ï¸</button>
          <div class="range">
            <span id="tcur">0:00</span>
            <input id="seek" type="range" min="0" max="100" value="0" step="1" aria-label="Seek" />
            <span id="tdur">0:00</span>
          </div>
          <div class="range" title="Volume">
            <span>ğŸ”Š</span>
            <input id="vol" type="range" min="0" max="1" step="0.01" />
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Page content -->
  <main id="page-root" data-page="home">
    <div class="wrap">
      <div id="list" class="list" role="list"></div>
    </div>
  </main>

  <audio id="audio" preload="metadata"></audio>

<script>
/* ===== VVIP25 â€” Home (single document) ===== */
const ASSET_VERSION = 20;
const LOGO_COLOR = '#fdf6d0';
const BASE_MP3='https://media.vvipmedia.net/ACCESS/';
const BASE_WAV='https://media.vvipmedia.net/WAV/';
const BASE_THUMB='https://media.vvipmedia.net/ACCESS/';
const BASE_VIDEO='https://media.vvipmedia.net/VIDEOS/';
const BASE_TRINKETS='https://media.vvipmedia.net/TRINKETS/';
const DEFAULT_THUMB = BASE_THUMB + 'default_thumb.jpg';

(()=>{ try{ const m=document.createElement('meta'); m.httpEquiv='Cache-Control'; m.content='no-store, max-age=0, must-revalidate'; document.head.appendChild(m);}catch(_){} })();

const $=s=>document.querySelector(s);
function fmtDur(sec){sec=+sec||0;const m=Math.floor(sec/60),s=Math.floor(sec%60);return `${m}:${String(s).padStart(2,'0')}`;}
const rawFile=s=>(String(s).split('/').pop()||''); const stripExt=s=>String(s).replace(/\.[a-z0-9]+$/i,''); const softNorm=s=>stripExt(String(s)).toLowerCase().replace(/[ _]+/g,'-').replace(/-+/g,'-');
function deriveTitleFromFilename(name){const b=stripExt(rawFile(name)).replace(/^[\d._-]+/,'').replace(/[_-]+/g,' ').trim();return b||stripExt(rawFile(name));}
const DATE_RX_YYYY=/^\s*(\d{4})[.\-_](\d{2})[.\-_](\d{2})(?=\D|$)/; const DATE_RX_YY=/^\s*(\d{2})[.\-_](\d{2})[.\-_](\d{2})(?=\D|$)/; const WITHIN_DAY_RX=/^\s*(?:\d{4}|\d{2})[.\-_]\d{2}[.\-_]\d{2}(?:[.\-_](\d+))?/;
function fallbackDateFromName(name){const s=String(name); let m=s.match(DATE_RX_YYYY); if(m){return new Date(Date.UTC(+m[1],+m[2]-1,+m[3]));} m=s.match(DATE_RX_YY); if(m){const yy=+m[1];const yyyy=(yy>=70?1900+yy:2000+yy);return new Date(Date.UTC(yyyy,+m[2]-1,+m[3]));} return null;}
function withinDayIndexFromName(name){ const m=String(name).match(WITHIN_DAY_RX); return m&&m[1]?parseInt(m[1],10):0; }
function bpmSortValue(t){ if(t.bpm!=null) return t.bpm; if(t.bpm_min!=null&&t.bpm_max!=null) return (t.bpm_min+t.bpm_max)/2; return 0; }
function bpmLabel(t){ if(t.bpm!=null) return `${t.bpm} BPM`; if(t.bpm_min!=null&&t.bpm_max!=null) return `${t.bpm_min}â€“${t.bpm_max} BPM`; return ''; }

const els={ audio:$('#audio'), list:$('#list'), sort:$('#sort'),
  toggle:$('#toggle'), prev:$('#prev'), next:$('#next'),
  seek:$('#seek'), vol:$('#vol'), nowTitle:$('#now-title'), nowSub:$('#now-sub'),
  tcur:$('#tcur'), tdur:$('#tdur'), cover:$('#cover'), menu:$('#menu'), toolbar:$('#toolbar')
};
const state={
  tracks:[], filtered:[], i:-1, playing:false,
  pageSize:60, renderCount:0, resolvedThumb:new Map(),
  searchQuery:'',
  favorites:new Set(JSON.parse(localStorage.getItem('vvip25:favs')||'[]')),
  favOrder: JSON.parse(localStorage.getItem('vvip25:favOrder')||'[]'),
  showWavButtons: localStorage.getItem('vvip25:showWav')==='1',
  showMovButtons: localStorage.getItem('vvip25:showMov')==='1',
  showTrinketButtons: localStorage.getItem('vvip25:showTrinkets')==='1',
  lightMode:      localStorage.getItem('vvip25:light')==='1',
  hideNameless:   localStorage.getItem('vvip25:hideNameless')==='1',
  thumbBases:new Set()
};
if (state.lightMode) document.body.classList.add('light');
els.vol.value = localStorage.getItem('vvip25:vol') ?? '0.9'; els.audio.volume = parseFloat(els.vol.value);

function iconPlay(){return `<svg viewBox="0 0 24 24" width="20" height="20"><polygon fill="${LOGO_COLOR}" points="8,5 20,12 8,19"/></svg>`;}
function iconPause(){return `<svg viewBox="0 0 24 24" width="20" height="20"><rect fill="${LOGO_COLOR}" x="6" y="5" width="4" height="14" rx="1"/><rect fill="${LOGO_COLOR}" x="14" y="5" width="4" height="14" rx="1"/></svg>`;}
function iconPrev(){return `<svg viewBox="0 0 24 24" width="20" height="20"><path d="M5 5v14" stroke="${LOGO_COLOR}" stroke-width="2" fill="none" stroke-linecap="round"/><polygon fill="${LOGO_COLOR}" points="6,12 19,5 19,19"/></svg>`;}
function iconNext(){return `<svg viewBox="0 0 24 24" width="20" height="20"><path d="M19 5v14" stroke="${LOGO_COLOR}" stroke-width="2" fill="none" stroke-linecap="round"/><polygon fill="${LOGO_COLOR}" points="5,5 18,12 5,19"/></svg>`;}
function setIcons(){ $('#prev').innerHTML=iconPrev(); $('#toggle').innerHTML=state.playing?iconPause():iconPlay(); $('#next').innerHTML=iconNext(); }

init();
async function init(){
  buildMenu();
  setIcons();

  let mres = await fetch(`/manifest.json?v=${ASSET_VERSION}`, { cache:'no-store' });
  if(!mres.ok) mres = await fetch(`./manifest.json?v=${ASSET_VERSION}`, { cache:'no-store' });
  if(!mres.ok){ els.list.innerHTML = `<div class="row"><div></div><div>manifest.json not found</div></div>`; return; }

  const data = await mres.json();
  state.tracks = data.map((t,idx)=>{
    const name = t.name || t.file || t.src?.split('/').pop() || `track-${idx}.mp3`;
    const base = stripExt(name), baseLower=base.toLowerCase();
    const mp3  = t.src || (BASE_MP3 + encodeURIComponent(name));
    const wav  = BASE_WAV + encodeURIComponent(base + '.wav');
    const mov  = t.mov_url ? String(t.mov_url) : (t.has_mov ? (BASE_VIDEO + encodeURIComponent(base + '.mov')) : null);
    const trinkets = t.trinkets_url ? String(t.trinkets_url) : (t.has_trinkets ? (BASE_TRINKETS + encodeURIComponent(base) + '/') : null);
    const thumbCandidate = BASE_THUMB + encodeURIComponent(baseLower + 'thumb.jpg');
    return { id:idx, name, base, baseLower, title:t.title||'', src:mp3, wav, video:mov, trinkets, thumbCandidate, length:t.length||0,
      bpm:t.bpm??null, bpm_min:t.bpm_min??null, bpm_max:t.bpm_max??null, date: t.date?new Date(t.date):fallbackDateFromName(name), details:t.details||'' };
  });

  await applyTitles(); await applyThumbs();

  // Preselect Gone Jotti
  const jottiIdx = state.tracks.findIndex(t => (t.title||'').toLowerCase().includes('gone jotti') || t.name.toLowerCase().includes('gone jotti'));
  applyFilterSort(true); renderList(); fillViewport();
  if (jottiIdx>=0){
    const filteredIdx = state.filtered.findIndex(t=>t.id===state.tracks[jottiIdx].id);
    select(filteredIdx>=0?filteredIdx:0);
  } else if(state.filtered.length){ select(0); }
}

function buildMenu(){
  const tb=$('#toolbar'); tb.innerHTML='';
  const row=document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; row.style.flexWrap='wrap'; row.style.alignItems='center'; tb.appendChild(row);

  const util=document.createElement('div'); util.className='panel'; util.style.display='none';
  util.innerHTML=`<div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
    <button class="tog ${state.hideNameless?'on':''}" id="togTitles" title="Hide untitled/date-only">ğŸ“</button>
    <button class="tog ${state.showWavButtons?'on':''}" id="togWav" title="Show WAV">ğŸšï¸</button>
    <button class="tog ${state.showMovButtons?'on':''}" id="togMov" title="Show MOV">ğŸ¬</button>
    <button class="tog ${state.showTrinketButtons?'on':''}" id="togTrk" title="Show Trinkets">ğŸ’</button>
    <button class="tog ${state.lightMode?'on':''}" id="togLight" title="Light">ğŸŒ</button>
  </div>`;
  tb.appendChild(util);

  const btnUtils=document.createElement('button'); btnUtils.className='btn'; btnUtils.textContent='âš™ï¸'; btnUtils.title='Settings'; row.appendChild(btnUtils);
  btnUtils.addEventListener('click',(e)=>{ e.preventDefault(); util.style.display = util.style.display==='block' ? 'none':'block'; keepMenuOpen(); });

  const aShop=document.createElement('a'); aShop.className='btn'; aShop.title='Shoppe'; aShop.textContent='ğŸ›ï¸'; aShop.href='/shoppe/'; aShop.target='_self'; row.appendChild(aShop);

  const sortSel=document.createElement('select'); sortSel.id='sort'; sortSel.title='Sort';
  sortSel.innerHTML=`<option value="date_desc">Newest</option><option value="date_asc">Oldest</option><option value="bpm_desc">BPM â†“</option><option value="bpm_asc">BPM â†‘</option><option value="len_desc">Longest</option><option value="len_asc">Shortest</option>`;
  row.appendChild(sortSel);

  $('#menu').open=true;

  util.querySelector('#togWav').addEventListener('click',()=>{ state.showWavButtons=!state.showWavButtons; localStorage.setItem('vvip25:showWav', state.showWavButtons?'1':'0'); util.querySelector('#togWav').classList.toggle('on',state.showWavButtons); rerenderBadges(); keepMenuOpen(); });
  util.querySelector('#togMov').addEventListener('click',()=>{ state.showMovButtons=!state.showMovButtons; localStorage.setItem('vvip25:showMov', state.showMovButtons?'1':'0'); util.querySelector('#togMov').classList.toggle('on',state.showMovButtons); rerenderBadges(); keepMenuOpen(); });
  util.querySelector('#togTrk').addEventListener('click',()=>{ state.showTrinketButtons=!state.showTrinketButtons; localStorage.setItem('vvip25:showTrinkets', state.showTrinketButtons?'1':'0'); util.querySelector('#togTrk').classList.toggle('on',state.showTrinketButtons); rerenderBadges(); keepMenuOpen(); });
  util.querySelector('#togLight').addEventListener('click',()=>{ state.lightMode=!state.lightMode; document.body.classList.toggle('light',state.lightMode); localStorage.setItem('vvip25:light', state.lightMode?'1':'0'); util.querySelector('#togLight').classList.toggle('on',state.lightMode); keepMenuOpen(); });

  document.addEventListener('change',(e)=>{ if(e.target && e.target.id==='sort'){ applyFilterSort(false,true); keepMenuOpen(); } }, {passive:true});
}
function keepMenuOpen(){ const m=$('#menu'); if(m) m.open=true; }

async function applyTitles(){
  try{
    let r=await fetch(`/titles.json?v=${ASSET_VERSION}`,{cache:'no-store'}); if(!r.ok) r=await fetch(`./titles.json?v=${ASSET_VERSION}`,{cache:'no-store'}); if(!r.ok) return;
    const json=await r.json();
    const map=new Map();
    const add=(k,v)=>{ if(!k||!v) return; const f=rawFile(String(k).toLowerCase()); const noExt=stripExt(f); const norm=softNorm(f); map.set(f,v); map.set(noExt,v); map.set(norm,v); };
    if(Array.isArray(json)) json.forEach(row=>add(row.key||row.src||row.name, row.title||row.t||row.display));
    else Object.entries(json).forEach(([k,v])=> add(k, typeof v==='string'?v:(v&&v.title)));
    let changed=false;
    for(const t of state.tracks){ const f=rawFile(t.name).toLowerCase(); const cands=[f,stripExt(f),softNorm(f)]; for(const c of cands){ if(map.has(c)){ if(map.get(c)!==t.title){ t.title=map.get(c); changed=true; } break; } } }
    if(changed) refreshTitles();
  }catch(_){}
}
async function applyThumbs(){
  try{
    let r=await fetch(`/thumbs.json?v=${ASSET_VERSION}`,{cache:'no-store'}); if(!r.ok) r=await fetch(`./thumbs.json?v=${ASSET_VERSION}`,{cache:'no-store'}); if(!r.ok) return;
    const data=await r.json(); const set=new Set();
    if(Array.isArray(data)) data.forEach(b=>set.add(String(b).toLowerCase())); else Object.keys(data).forEach(b=>{ if(data[b]) set.add(b.toLowerCase()); });
    state.thumbBases=set;
    // simple cascade: last seen thumb sticks forward in time
    const asc=[...state.tracks].sort((a,b)=> (a.date?.getTime()||0)-(b.date?.getTime()||0) || withinDayIndexFromName(a.name)-withinDayIndexFromName(b.name));
    let cur=DEFAULT_THUMB; for(const t of asc){ if(set.has(t.baseLower)) cur = BASE_THUMB + encodeURIComponent(t.baseLower + 'thumb.jpg'); state.resolvedThumb.set(t.id, cur); }
  }catch(_){}
}
const getThumb=t=>state.resolvedThumb.get(t.id)||DEFAULT_THUMB;

function applyFilterSort(first=false, keepIndex=false){
  let out=[...state.tracks];
  switch($('#sort')?.value||'date_desc'){
    case 'date_desc': out.sort((a,b)=> (b.date?.getTime()||0)-(a.date?.getTime()||0) || withinDayIndexFromName(b.name)-withinDayIndexFromName(a.name)); break;
    case 'date_asc' : out.sort((a,b)=> (a.date?.getTime()||0)-(b.date?.getTime()||0) || withinDayIndexFromName(a.name)-withinDayIndexFromName(b.name)); break;
    case 'bpm_desc': out.sort((a,b)=> bpmSortValue(b)-bpmSortValue(a)); break;
    case 'bpm_asc' : out.sort((a,b)=> bpmSortValue(a)-bpmSortValue(b)); break;
    case 'len_desc': out.sort((a,b)=> (b.length||0)-(a.length||0)); break;
    case 'len_asc' : out.sort((a,b)=> (a.length||0)-(b.length||0)); break;
  }
  if (state.hideNameless) out = out.filter(t=> !!t.title && t.title !== deriveTitleFromFilename(t.name));
  state.filtered = out;
  state.renderCount = Math.min(out.length, first?Math.max(60,state.pageSize):state.pageSize);
  if(!keepIndex) state.i = Math.min(state.i, state.renderCount-1);
}
function badgeHTML(t){
  const parts=[`<a class="btn" href="${t.src}" download title="Download MP3">MP3</a>`];
  if (state.showWavButtons) parts.push(`<a class="btn" href="${t.wav}" download title="Download WAV">WAV</a>`);
  if (state.showMovButtons) parts.push(t.video?`<a class="btn" href="${t.video}" target="_blank" rel="noopener" title="Open MOV">ğŸ¬</a>`:`<span class="btn" title="No MOV" style="opacity:.45;cursor:not-allowed">ğŸ¬</span>`);
  if (state.showTrinketButtons) parts.push(t.trinkets?`<a class="btn" href="${t.trinkets}" target="_blank" rel="noopener" title="Trinkets">ğŸ’</a>`:`<span class="btn" title="No trinkets" style="opacity:.45;cursor:not-allowed">ğŸ’</span>`);
  return `<div class="badge">${parts.join('')}</div>`;
}
function rowHTML(t,active){
  const thumb=getThumb(t), title=t.title || deriveTitleFromFilename(t.name);
  return `<div class="row" role="listitem" data-id="${t.id}">
    <div class="cover"><img src="${thumb}" alt="" loading="lazy" style="width:56px;height:56px;border-radius:8px;object-fit:cover;" onerror="this.onerror=null;this.src='${DEFAULT_THUMB}'"></div>
    <div><div class="title">${active?'â–¶ï¸ ':''}${title}</div><div class="sub">${t.name}${t.length?` Â· ${fmtDur(t.length)}`:''}${t.bpm?` Â· ${bpmLabel(t)}`:''}</div></div>
    ${badgeHTML(t)}
  </div>`;
}
function renderList(){
  if(!state.filtered.length){ els.list.innerHTML='<div class="row"><div></div><div>No results.</div></div>'; return; }
  const slice=state.filtered.slice(0,state.renderCount);
  els.list.innerHTML = slice.map(t=>rowHTML(t,(state.i>=0 && state.filtered[state.i]?.id===t.id))).join('');
}
function rerenderBadges(){ els.list.querySelectorAll('.row').forEach(row=>{ const id=+row.getAttribute('data-id'); const t=state.filtered.find(x=>x.id===id)||state.tracks.find(x=>x.id===id); row.querySelector('.badge').outerHTML=badgeHTML(t); }); }

function select(i){
  state.i=i; const t=state.filtered[i]; if(!t) return;
  els.audio.src=t.src; updateNow(); state.playing=false; setIcons();
  els.list.querySelectorAll('.row .title').forEach((el,idx)=>{ const id=+el.closest('.row').getAttribute('data-id'); const active = id===t.id; el.innerHTML = (active?'â–¶ï¸ ':'') + (state.tracks.find(x=>x.id===id)?.title || deriveTitleFromFilename(state.tracks.find(x=>x.id===id)?.name||'')); });
}
function updateNow(){
  const t=state.filtered[state.i]; if(!t) return;
  els.nowTitle.textContent=t.title || deriveTitleFromFilename(t.name);
  const bits=[t.name]; if(t.length) bits.push(fmtDur(t.length)); const b=bpmLabel(t); if(b) bits.push(b); els.nowSub.textContent=bits.join(' Â· ');
  const url=getThumb(t); $('#cover').innerHTML=`<img src="${url}" alt="" style="width:56px;height:56px;object-fit:cover;border-radius:8px" onerror="this.onerror=null;this.src='${DEFAULT_THUMB}'">`;
}

$('#toggle').addEventListener('click',()=>{ if (state.i<0 && state.filtered.length) select(0); if(state.playing){ els.audio.pause(); state.playing=false; } else { els.audio.play().then(()=>{ state.playing=true; }).catch(()=>{}); } setIcons(); });
$('#prev').addEventListener('click',()=>{ if(!state.filtered.length) return; let i=state.i-1; if(i<0) i=state.filtered.length-1; select(i); els.audio.play().catch(()=>{}); state.playing=true; setIcons(); });
$('#next').addEventListener('click',()=>{ if(!state.filtered.length) return; let i=state.i+1; if(i>=state.filtered.length) i=0; select(i); els.audio.play().catch(()=>{}); state.playing=true; setIcons(); });
els.audio.addEventListener('timeupdate',()=>{ const a=els.audio; if(!isFinite(a.duration)) return; $('#seek').max=Math.floor(a.duration); $('#seek').value=Math.floor(a.currentTime); $('#tcur').textContent=fmtDur(a.currentTime); $('#tdur').textContent=isFinite(a.duration)?fmtDur(a.duration):'0:00'; });
$('#seek').addEventListener('input',()=>{ els.audio.currentTime=Number($('#seek').value); });
$('#vol').addEventListener('input',()=>{ els.audio.volume=parseFloat($('#vol').value); localStorage.setItem('vvip25:vol', $('#vol').value); });

document.addEventListener('click',(e)=>{
  const row=e.target.closest?.('.row');
  if(row && !e.target.closest('a')){ const id=+row.getAttribute('data-id'); const idx=state.filtered.findIndex(t=>t.id===id); if(idx>=0){ select(idx); els.audio.play().catch(()=>{}); state.playing=true; setIcons(); } }
});

function fillViewport(){ /* simple */ }
function refreshTitles(){ renderList(); if(state.i>=0) updateNow(); }
</script>
</body>
</html>