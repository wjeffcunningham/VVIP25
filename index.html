<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VVIP25</title>
  <link rel="icon" type="image/png" sizes="64x64" href="/favicon-64.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon-192.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" href="/favicon.ico?v=3">
  <meta name="theme-color" content="#0b0b0c"/>
<style>
  :root {
    --bg:#0b0b0c;
    --fg:#eceff4;
    --muted:#9aa0a6;
    --card:#141416;
    --border:#26272b;
    --accent:#6ee7b7;
  }

.controls button svg {
  width: 18px;
  height: 18px;
  fill: #fdf6d0; /* gold */
}

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:var(--bg);
    color:var(--fg);
    font:16px/1.5 -apple-system,BlinkMacSystemFont,"Helvetica Neue",Helvetica,Arial,"Segoe UI",Roboto,Inter,system-ui,sans-serif;
  }
  .wrap{max-width:920px;margin:0 auto;padding:16px}
  html{-webkit-text-size-adjust:100%}
  input,select,button{font-size:16px}

  @media (max-width:560px){
    body{font-size:15px}
    header{gap:8px}
    #site-title{font-size:44px;-webkit-text-stroke:1.5px #fdf6d0}
    .wrap{padding:12px}
    .row{grid-template-columns:auto 1fr auto;padding:8px 10px;min-height:64px}
    .badge .pill{padding:3px 8px;font-size:11px}
  }

  header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    position:relative;
  }

  /* --- updated logo --- */
  #site-title{
    margin:0;
    font-size:64px;            /* larger */
    letter-spacing:.04em;      /* added kerning */
    font-weight:bold;
    font-family:"Helvetica Neue",Helvetica,Arial,sans-serif;
    color:transparent;
    -webkit-text-fill-color:transparent;
    -webkit-text-stroke:2px #fdf6d0;
  }

  .player{
    position:sticky;
    top:0;
    z-index:10;
    background:linear-gradient(180deg,rgba(11,11,12,.97),rgba(11,11,12,.92));
    backdrop-filter:saturate(120%) blur(8px);
    border-bottom:1px solid var(--border);
  }

  .now{
    display:grid;
    grid-template-columns:auto 1fr auto;
    gap:12px;
    align-items:center;
    padding:12px 0;
  }

  .cover{
    width:56px;height:56px;border-radius:8px;
    background:#1e1f24;display:grid;place-items:center;
    color:var(--muted);font-weight:700;border:1px solid var(--border);
  }

  .meta{min-width:0}
  .title{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .sub{color:var(--muted);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .controls{display:flex;align-items:center;gap:8px}
  button{
    appearance:none;
    background:var(--card);
    color:var(--fg);
    border:1px solid var(--border);
    border-radius:10px;
    padding:8px 12px;
    cursor:pointer;
  }
  button:disabled{opacity:.55;cursor:not-allowed}
  .range{display:flex;align-items:center;gap:8px}
  input[type="range"]{width:160px}

  .list{
    margin:12px 0 40px;
    border:1px solid var(--border);
    border-radius:14px;
    overflow:hidden;
  }

  .row{
    display:grid;
    grid-template-columns:56px 1fr auto;
    gap:12px;
    align-items:center;
    padding:10px 12px;
    border-top:1px solid var(--border);
    background:var(--card);
    min-height:78px;
  }
  .row:first-child{border-top:0}
  .row:hover{background:#17171b}

  .badge{
    display:flex;
    gap:10px;
    align-items:center;
    font-size:12px;
    justify-self:end;
  }
  .badge a{
    color:var(--fg);
    text-decoration:none;
    border:1px solid var(--border);
    padding:4px 8px;
    border-radius:8px;
  }
  .badge .muted{color:var(--muted)}

  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  select{
    background:var(--card);
    color:var(--fg);
    border:1px solid var(--border);
    border-radius:10px;
    padding:8px 10px;
  }

  .tog,.btn{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    height:36px;
    min-width:36px;
    padding:0 10px;
    border-radius:10px;
    border:1px solid var(--border);
    background:var(--card);
    text-decoration:none;
    color:var(--fg);
    line-height:1;
  }
  .tog{opacity:.6;transition:opacity .15s, box-shadow .15s}
  .tog.on{opacity:1;box-shadow:0 0 0 2px var(--accent) inset}

  /* --- gear menu --- */
  .gearwrap{position:relative;}
  #gearBtn.btn{
    width:40px;
    height:40px;
    padding:0;
    border-radius:10px;
    display:inline-grid;
    place-items:center;
  }
  #gearBtn svg{
    width:20px;
    height:20px;
    fill:#fdf6d0; /* ensure visible gear color */
  }
  .gearwrap .sheet{
    position:absolute;
    top:calc(100% + 8px);
    right:0;
    z-index:20;
    width:min(420px,calc(100vw - 32px));
    background:var(--card);
    border:1px solid var(--border);
    border-radius:10px;
    padding:10px;
    display:none;
    box-shadow:0 10px 24px rgba(0,0,0,.35);
  }
  .gearwrap.open .sheet{display:block;}
  .btn.icon{
    width:36px;
    height:36px;
    padding:0;
    display:inline-grid;
    place-items:center;
  }
  .btn.icon svg{
    width:18px;
    height:18px;
    fill:var(--fg);
  }

  .star {
  cursor: pointer;
  color: var(--muted);
  transition: filter .2s, color .2s;
}
.star.on {
  color: #fdf6d0;
  filter: drop-shadow(0 0 2px var(--accent)) brightness(1.2);
}

  /* Hide sort select by default; show only when '+' (formats) active */
  .toolbar select { display:none; }
  .toolbar.show-sort select { display:inline-block; }

  @supports (-webkit-touch-callout:none){
    .range[title="Volume"]{display:none !important}
  }

  @media (max-width:560px){
    .now{grid-template-columns:1fr;gap:8px}
    .cover{display:none}
    .controls{flex-wrap:wrap}
    .range input[type="range"]{width:120px}
    .row{grid-template-columns:1fr auto}
  }

  .version-buttons{
    display:inline-flex;
    gap:0.25em;
    margin-right:0.5em;
    vertical-align:middle;
  }
  .version-button{
    background:transparent;
    border:1px solid #999;
    border-radius:4px;
    font-size:0.75em;
    padding:0 0.3em;
    cursor:pointer;
    color:#555;
    transition:all 0.2s;
  }
  .version-button:hover{
    border-color:var(--accent,#000);
    color:var(--accent,#000);
  }
  .version-button.active{
    background:var(--accent,#000);
    color:#fff;
    border-color:var(--accent,#000);
  }

  /* --- VVIP25: thumbnail readability patch (Oct 2025) --- */
  @media (max-width:560px){
    .row{
      grid-template-columns:72px 1fr;
      gap:8px;
      padding:8px 10px;
    }
    .thumb{
      width:72px;
      height:72px;
      border-radius:8px;
    }
    .title{
      font-size:15px;
      font-weight:600;
      line-height:1.2;
      white-space:normal;
      overflow:hidden;
    }
    .subline{
      font-size:11px;
      color:var(--muted);
    }
  }
</style>
</head>
<body>
  <div class="player">
    <div class="wrap">
  <header>
  <h1 id="site-title">VVIP25</h1>
  <div id="gearwrap" class="gearwrap">
    <button id="gearBtn" class="btn" aria-label="Menu">
      <svg viewBox="0 0 24 24" width="20" height="20" fill="#fdf6d0" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 15.5A3.5 3.5 0 1 1 12 8.5a3.5 3.5 0 0 1 0 7zm8.94-3.03l1.38 1.06-1.26 2.18-1.63-.33a7.94 7.94 0 0 1-1.45.84l-.25 1.66h-2.52l-.25-1.66a7.94 7.94 0 0 1-1.45-.84l-1.63.33-1.26-2.18 1.38-1.06a7.94 7.94 0 0 1 0-1.68l-1.38-1.06 1.26-2.18 1.63.33c.46-.34.95-.63 1.45-.84l.25-1.66h2.52l.25 1.66c.5.21.99.5 1.45.84l1.63-.33 1.26 2.18-1.38 1.06c.07.55.07 1.13 0 1.68z"/>
      </svg>
    </button>
    <div class="sheet"><div class="toolbar" id="toolbar"></div></div>
  </div>
</header>

      <div class="now">
        <div class="cover" id="cover">V25</div>
        <div class="meta">
          <div class="title" id="now-title">—</div>
          <div class="sub" id="now-sub">Ready</div>
        </div>
        <div class="controls">
        <button id="prev" aria-label="Previous"></button>
<button id="toggle" aria-label="Play/Pause"></button>
<button id="next" aria-label="Next"></button>
          <div class="range">
            <span id="tcur">0:00</span>
            <input id="seek" type="range" min="0" max="100" value="0" step="1" aria-label="Seek" />
            <span id="tdur">0:00</span>
          </div>
          <div class="range" title="Volume">
            <span>🔊</span>
            <input id="vol" type="range" min="0" max="1" step="0.01" />
          </div>
        </div>
      </div>
    </div>
  </div>

  <main id="page-root" data-page="home">
    <div class="wrap">
      <div id="list" class="list" role="list"></div>
    </div>
  </main>

  <audio id="audio" preload="metadata"></audio>

<script>
/* ========= VVIPMEDIA — Core Player (Unified List) + Gear Menu ========= */

const ASSET_VERSION = 18;
const PREFERRED_TITLE = 'washed sand';

/* ---------- Config ---------- */
const BASE_MP3   = 'https://cdn.vvipmedia.net/ACCESS/';
const BASE_WAV   = 'https://cdn.vvipmedia.net/WAV/';

// ✅ Local thumbs — hosted with site (fast, no CORS)
const BASE_THUMB = 'assets/thumbs/';
const DEFAULT_THUMB = BASE_THUMB + 'default_thumb.jpg';

const BASE_VIDEO = 'https://cdn.vvipmedia.net/VIDEOS/';
const BASE_EXTRAS= 'https://cdn.vvipmedia.net/MEDIA/extras/';


/* ---------- Helpers ---------- */
const $ = s => document.querySelector(s);
function fmtDur(sec){sec=Number(sec||0);const m=Math.floor(sec/60),s=Math.floor(sec%60);return `${m}:${String(s).padStart(2,'0')}`;}
function debounce(fn,ms){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);};}
const stripExt=s=>String(s).replace(/\.[a-z0-9]+$/i,'');
function deriveTitleFromFilename(name){const b=stripExt(name).replace(/^[\d._-]+/,'').replace(/[_-]+/g,' ').trim();return b||stripExt(name);}
const DATE_RX_YY=/^\s*(\d{2})[.\-_](\d{2})[.\-_](\d{2})/;
function fallbackDateFromName(n){const m=n.match(DATE_RX_YY);if(!m)return null;const y=+m[1];return new Date(Date.UTC(y>=70?1900+y:2000+y,+m[2]-1,+m[3]));}
function bpmLabel(t){if(t.bpm!=null)return`${t.bpm} BPM`;if(t.bpm_min!=null&&t.bpm_max!=null)return`${t.bpm_min}–${t.bpm_max} BPM`;return'';}
function matchesTokens(t,toks){if(!toks.length)return true;const n=(t.name||'').toLowerCase(),ttl=(t.title||'').toLowerCase(),det=(t.details||'').toLowerCase();return toks.every(tok=>tok.startsWith('#')?det.includes(tok):n.includes(tok)||ttl.includes(tok)||det.includes(tok));}

/* ---------- Elements & State ---------- */
const els={
  audio:$('#audio'),list:$('#list'),toggle:$('#toggle'),
  prev:$('#prev'),next:$('#next'),seek:$('#seek'),vol:$('#vol'),
  nowTitle:$('#now-title'),nowSub:$('#now-sub'),cover:$('#cover'),
  tcur:$('#tcur'),tdur:$('#tdur'),toolbar:$('#toolbar'),
  favbar:null,favInput:null,favModeLabel:null
};
const state={
  tracks:[],filtered:[],i:-1,playing:false,pageSize:60,renderCount:0,
  thumbBases:new Set(),resolvedThumb:new Map(),
  favorites:new Set(JSON.parse(localStorage.getItem('vvip25:favs')||'[]')),
  favOrder:JSON.parse(localStorage.getItem('vvip25:favOrder')||'[]'),
  searchQuery:'',viewMode:'all',
  extras:{},showFormats:false,showWavButtons:false,showMovButtons:false
};

state.tracks.forEach(t => {
  const k = t.base.toLowerCase();
  if (lookup.has(k)) {
    const fullTitle = lookup.get(k) || t.title;
    const [main, alt] = fullTitle.split('//').map(s => s.trim());
    t.title = main;
    if (alt) t.altTitle = alt; // optional field for later
  }
});

/* ---------- Titles ---------- */
async function fetchTitles() {
  try {
    const r = await fetch('https://vvipmedia.net/titles.json', { cache: 'no-store' });
    if (!r.ok) throw new Error(`titles.json ${r.status}`);

    const raw = await r.json();
    const json = (raw && typeof raw === 'object' && !Array.isArray(raw))
      ? (raw.titles || raw.data || raw)
      : raw;

    // build a lowercase lookup
    const lookup = new Map();
    for (const [k, v] of Object.entries(json || {})) {
      const key = stripExt(k).toLowerCase();
      lookup.set(key, v.title || v || '');
    }

    // apply to tracks, respecting "A//B" alternate title rule
    state.tracks.forEach(t => {
      const k = t.base.toLowerCase();
      if (lookup.has(k)) {
        const fullTitle = lookup.get(k) || t.title;
        const [main, alt] = fullTitle.split('//').map(s => s.trim());
        t.title = main || t.title;
        if (alt) t.altTitle = alt; // optional field for later display
      }
    });

    console.log('Titles loaded:', lookup.size);
  } catch (err) {
    console.warn('Titles fetch failed:', err);
  }
}

/* ---------- Boot ---------- */
document.addEventListener('DOMContentLoaded', init);

async function init() {
  try {
    // Build interface elements first
    buildMenuUI();
    buildFavBar();
    setControlIcons();

    // ---------- Player Controls: button bindings ----------
    $('#toggle')?.addEventListener('click', () => {
      if (state.i < 0 && state.filtered.length) select(0);
      state.playing ? pause() : play();
    });

    $('#prev')?.addEventListener('click', () => {
      if (state.filtered.length) {
        const ni = (state.i - 1 + state.filtered.length) % state.filtered.length;
        select(ni);
        play();
      }
    });

    $('#next')?.addEventListener('click', () => {
      if (state.filtered.length) {
        const ni = (state.i + 1) % state.filtered.length;
        select(ni);
        play();
      }
    });

    // --- Load manifest safely ---
    const res = await fetch(`/manifest.json?v=${ASSET_VERSION}`, { cache: 'no-store' });
    if (!res.ok) throw new Error(`manifest.json not found (${res.status})`);
    const raw = await res.text();

    let data;
    try {
      data = JSON.parse(raw);
    } catch {
      throw new Error('manifest.json is not valid JSON');
    }

    // --- Parse track entries ---
    const tracks = Array.isArray(data) ? data : (data.tracks || []);
    if (!tracks.length) throw new Error('manifest.json contains no tracks');

    state.tracks = tracks.map((t, idx) => {
      const name = t.name || '';
      const base = stripExt(name);
      const baseLower = base.toLowerCase();
      const date = t.date ? new Date(t.date) : fallbackDateFromName(name);
      return {
        id: idx,
        name,
        base,
        baseLower,
        title: t.title || deriveTitleFromFilename(name),
        details: t.details || '',
        bpm: t.bpm,
        bpm_min: t.bpm_min,
        bpm_max: t.bpm_max,
        length: t.length || 0,
        src: `${BASE_MP3}${encodeURIComponent(name)}`,
        video: t.video,
        date,
        thumbCandidate: BASE_THUMB + encodeURIComponent(baseLower + 'thumb.jpg')
      };
    });

    console.log(`Loaded ${state.tracks.length} tracks`);

    // --- Supplementary data ---
    if (typeof fetchTitles === 'function') {
      await fetchTitles().catch(err => console.warn('Titles fetch failed:', err));
    } else {
      console.warn('fetchTitles() not defined — skipping title loading.');
    }

    await fetchThumbs().catch(err => console.warn('Thumbs fetch failed:', err));

    // --- Thumbnails + render ---
    computeThumbCascade();
    setView('all');
    preselectPreferred(PREFERRED_TITLE);

    console.log('Init completed successfully.');
  } catch (err) {
    console.error('Init failed:', err);
    const list = document.getElementById('list');
    if (list) {
      list.innerHTML = `
        <div class="row">
          <div style="color:#f88;padding:12px;">
            Load error: ${err.message || err}
          </div>
        </div>`;
    }
  }
}
/* ---------- View / Filter / Favs ---------- */
function buildFavBar(){
  const wrap=document.querySelector('main .wrap');
  const bar=document.createElement('div');
  bar.className='favbar';
  bar.innerHTML='<span id="favMode">Search</span><input id="favSearch" type="search" placeholder="Filter with #tags or text">';
  wrap.prepend(bar);
  els.favbar=bar; els.favInput=bar.querySelector('#favSearch'); els.favModeLabel=bar.querySelector('#favMode');
  els.favInput.addEventListener('input',debounce(()=>{
    const q=(els.favInput.value||'').trim().toLowerCase();
    state.searchQuery=q; setView(q?'search':'favorites');
  },120));
}
function setView(mode){state.viewMode=mode;applyFilterSort(true);}
function applyFilterSort(first=false){
  const toks=(state.searchQuery||'').split(/\s+/).filter(Boolean);
  let out=[...state.tracks];
  if(state.viewMode==='favorites'&&!toks.length)out=out.filter(t=>state.favorites.has(t.name));
  else if(state.viewMode==='search')out=out.filter(t=>matchesTokens(t,toks));
  out.sort((a,b)=>(b.date-a.date)||b.name.localeCompare(a.name));
  state.filtered=out;state.renderCount=Math.min(out.length,first?60:state.pageSize);
  renderList();
}

/* ---------- Thumbs + Row Click ---------- */
async function fetchThumbs() {
  try {
    // ✅ Local-safe: relative URL works on localhost and in production
    const url = `https://cdn.vvipmedia.net/ACCESS/thumbs.json?v=${ASSET_VERSION}`;
    const r = await fetch(url, { cache: 'no-store' });
    if (!r.ok) throw new Error(`thumbs.json not found (${r.status})`);

    const data = await r.json();
    const items = Array.isArray(data) ? data : Object.keys(data);

    state.thumbBases.clear();
    items.forEach(b => state.thumbBases.add(String(b).toLowerCase()));

    console.log(`✅ Loaded ${state.thumbBases.size} thumbnail names`);
  } catch (err) {
    console.warn('⚠️ fetchThumbs failed:', err);
  }
}

function computeThumbCascade() {
  console.log('🧩 Computing thumbnail cascade...');
  const asc = [...state.tracks].sort((a, b) =>
    (a.date - b.date) || a.name.localeCompare(b.name)
  );
  let cur = DEFAULT_THUMB;

  for (const t of asc) {
    const key = t.baseLower + 'thumb.jpg';
    if (state.thumbBases.has(key)) {
      cur = BASE_THUMB + encodeURIComponent(key);
      console.log(`🖼️ thumb switch → ${t.name} → ${cur}`);
    }
    state.resolvedThumb.set(t.id, cur);
  }

  // Ensure all tracks have a thumb
  for (const t of state.tracks)
    if (!state.resolvedThumb.has(t.id))
      state.resolvedThumb.set(t.id, DEFAULT_THUMB);

  console.log('✅ Cascade complete:', state.resolvedThumb.size, 'entries');
}

// ✅ Simple, fast: use the exact-case base name; let onerror fall back.
function getResolvedThumb(t) {
  // If you want the IJ tag override, keep it but use .jpg to match your file
  const details = (t.details || '').toLowerCase();
  if (details.includes('#ij')) return BASE_THUMB + 'IJPAUCthumb.jpg';

  // Build the expected local filename with original case
  return `${BASE_THUMB}${t.base}thumb.jpg`;
}

/* ---------- Row click handler ---------- */
// Clicking any row selects & plays that track (ignore stars/links)
document.addEventListener('click', e => {
  const row = e.target.closest('.row');
  if (!row || e.target.closest('a') || e.target.closest('.star')) return;
  const id = Number(row.dataset.id);
  const idx = state.filtered.findIndex(t => t.id === id);
  if (idx >= 0) {
    select(idx);
    play();
  }
});

/* ---------- Rendering ---------- */
function imgHTML(src){return `<img src="${src}" onerror="this.onerror=null;this.src='${DEFAULT_THUMB}'" style="width:56px;height:56px;border-radius:8px;object-fit:cover;">`;}
function favHTML(t){const on=state.favorites.has(t.name)?'on':'';return `<button class="star ${on}" data-fav="${t.name}">★</button>`;}
function badgeHTML(t){const p=[favHTML(t)];
  if(state.showFormats){p.push(`<a class="pill" href="${t.src}" download>MP3</a>`);p.push(`<a class="pill" href="${BASE_WAV+encodeURIComponent(t.base+'.wav')}" download>WAV</a>`);if(t.video)p.push(`<a class="pill" href="${t.video}" target="_blank">MOV</a>`);if(state.extras[t.baseLower])p.push(`<button class="pill gem" data-gem="${t.baseLower}">💎</button>`);}
  return `<div class="badge">${p.join('')}</div>`;}
function rowHTML(t){const sub=[bpmLabel(t),t.length?fmtDur(t.length):'',t.date? t.date.toISOString().slice(0,10):''].filter(Boolean).join(' · ');
  return `<div class="row" data-id="${t.id}"><div class="left">${imgHTML(getResolvedThumb(t))}</div><div class="middle"><div class="title">${t.title}</div><div class="sub">${sub}</div></div><div class="right">${badgeHTML(t)}</div></div>`;}
function renderList(){els.list.innerHTML=state.filtered.slice(0,state.renderCount).map(rowHTML).join('');}

/* ---------- Player Core ---------- */
function preselectPreferred(x){if(!x||!state.filtered.length)return;const idx=state.filtered.findIndex(t=>t.title.toLowerCase().includes(x));if(idx>=0)select(idx);}
function select(i){state.i=i;const t=state.filtered[i];els.audio.src=t.src;updateNowbar();}
function updateNowbar(){const t=state.filtered[state.i];if(!t)return;els.nowTitle.textContent=t.title;els.nowSub.textContent=[bpmLabel(t),fmtDur(t.length||0)].join(' · ');els.cover.innerHTML=imgHTML(getResolvedThumb(t));}
function play(){els.audio.play();state.playing=true;setControlIcons();}
function pause(){els.audio.pause();state.playing=false;setControlIcons();}
function setControlIcons(){
  const svgPrev  = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="#fdf6d0" d="M7 5a1 1 0 0 1 1 1v12a1 1 0 1 1-2 0V6a1 1 0 0 1 1-1zm11.4 1.2a1 1 0 0 1 .6.9v9.8a1 1 0 0 1-1.6.8l-8.2-4.9a1 1 0 0 1 0-1.7l8.2-4.9a1 1 0 0 1 1-.1z"/></svg>';
  const svgNext  = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="#fdf6d0" d="M17 5a1 1 0 0 1 1 1v12a1 1 0 1 1-2 0V6a1 1 0 0 1 1-1zM5.6 6.2a1 1 0 0 1 1 .1l8.2 4.9a1 1 0 0 1 0 1.7l-8.2 4.9A1 1 0 0 1 5 17V7.2a1 1 0 0 1 .6-.9z"/></svg>';
  const svgPlay  = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="#fdf6d0" d="M8 5v14l11-7z"/></svg>';
  const svgPause = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="#fdf6d0" d="M6 5h4v14H6zM14 5h4v14h-4z"/></svg>';
  if($('#prev'))   $('#prev').innerHTML = svgPrev;
  if($('#next'))   $('#next').innerHTML = svgNext;
  if($('#toggle')) $('#toggle').innerHTML = state.playing ? svgPause : svgPlay;
}

/* ---------- Gear + Toolbar ---------- */
function setGearOpen(o){$('#gearwrap')?.classList.toggle('open',!!o);}
document.addEventListener('click',e=>{
  const gw=$('#gearwrap');if(!gw)return;
  const btn=$('#gearBtn');
  if(btn.contains(e.target)){e.preventDefault();setGearOpen(!gw.classList.contains('open'));return;}
  if(!gw.contains(e.target))setGearOpen(false);
});

function buildMenuUI(){
  const tb=els.toolbar;if(!tb)return;tb.innerHTML='';
  const bInfo=document.createElement('button');bInfo.className='btn icon';bInfo.innerHTML='ℹ';bInfo.title='Info';bInfo.onclick=()=>alert('VVIP25 — 2025');tb.append(bInfo);

  const bPlus=document.createElement('button');bPlus.className='btn';bPlus.textContent='+';bPlus.title='Toggle formats';tb.append(bPlus);
  const updatePlus=()=>{bPlus.classList.toggle('on',state.showFormats);tb.classList.toggle('show-sort',state.showFormats);}
  bPlus.onclick=e=>{e.preventDefault();state.showFormats=!state.showFormats;state.showWavButtons=state.showFormats;state.showMovButtons=state.showFormats;updatePlus();renderList();};

  const bFav=document.createElement('button');bFav.className='btn';const refresh=()=>{const fav=(state.viewMode==='favorites'||state.viewMode==='search');bFav.textContent=fav?'🎵':'⭐';};refresh();
  bFav.onclick=e=>{e.preventDefault();if(state.viewMode==='all'){setView('favorites');}else{setView('all');}refresh();};
  tb.append(bFav);

  const yt=a('https://www.youtube.com/@VVVVIIPP25','📺','YouTube');
  const ig=a('https://www.instagram.com/vvipmediadotnet/','📷','Instagram');
  tb.append(yt,ig);

  // 🛍 toggle
  const bShop=document.createElement('button');bShop.className='btn icon';bShop.innerHTML='🛍️';bShop.title='Shop';tb.append(bShop);
  let shopActive=false;
  bShop.onclick=async e=>{
    e.preventDefault();shopActive=!shopActive;
    if(shopActive){try{const r=await fetch('/shoppe/index.html',{cache:'no-store'});const html=await r.text();const doc=new DOMParser().parseFromString(html,'text/html');const next=doc.querySelector('main#page-root');const cur=document.querySelector('main#page-root');if(next&&cur)cur.replaceWith(next);}catch{alert('Shop not available');}}
    else location.href='/';
  };

  const sort=document.createElement('select');sort.id='sort';sort.innerHTML=`<option value="date_desc">Newest</option><option value="date_asc">Oldest</option><option value="bpm_desc">BPM↓</option><option value="bpm_asc">BPM↑</option><option value="len_desc">Longest</option><option value="len_asc">Shortest</option>`;
  sort.onchange=()=>applyFilterSort(false,true);
  tb.append(sort);
  function a(h,t,l){const x=document.createElement('a');x.href=h;x.target='_blank';x.rel='noopener';x.className='btn icon';x.title=l;x.innerHTML=t;return x;}
}

/* ---------- Extras / Gems ---------- */
(async()=>{try{
  const r=await fetch(`/extras.json?v=${ASSET_VERSION}`,{cache:'no-store'});
  state.extras=await r.json();
}catch{}})();

document.addEventListener('click',e=>{
  const gem=e.target.closest('.gem');
  if(!gem) return;

  e.preventDefault();
  const key = gem.dataset.gem;
  const files = state.extras[key];
  if(!files) return;

  const row = gem.closest('.row');
  const next = row.nextElementSibling;
  if(next && next.classList.contains('extras-drawer')){
    next.remove();
    return;
  }

  const d = document.createElement('div');
  d.className = 'extras-drawer';
  d.style.cssText = `
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    padding:8px 12px;
    background:var(--card);
    border-top:1px solid var(--border);
  `;

  // ✅ Correct URL (no subfolder of same name)
  d.innerHTML = files.map(f => {
    const url = `${BASE_EXTRAS}${encodeURIComponent(f)}`;
    return /\.(jpg|jpeg|png|gif|webp)$/i.test(f)
      ? `<a href="${url}" target="_blank"><img src="${url}" style="width:64px;height:64px;object-fit:cover;border-radius:8px"></a>`
      : `<a href="${url}" target="_blank" class="pill">${f}</a>`;
  }).join('');

  row.after(d);
});

// ---------- Favorites click handler ----------
document.addEventListener('click', e => {
  const btn = e.target.closest('.star');
  if (!btn) return;

  const trackName = btn.dataset.fav;
  const wasFav = state.favorites.has(trackName);

  // Toggle
  if (wasFav) state.favorites.delete(trackName);
  else state.favorites.add(trackName);

  // Persist to localStorage
  localStorage.setItem('vvip25:favs', JSON.stringify([...state.favorites]));

  // Update visuals
  btn.classList.toggle('on', !wasFav);

  // If viewing favorites-only, refresh
  if (state.viewMode === 'favorites' && wasFav) applyFilterSort();
});

</script>
</body>
</html>