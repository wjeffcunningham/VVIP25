<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VVIP25</title>
  <link rel="icon" type="image/png" sizes="64x64" href="/favicon-64.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon-192.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" href="/favicon.ico?v=3">
  <meta name="theme-color" content="#0b0b0c"/>
  <style>
    :root{--bg:#0b0b0c;--fg:#eceff4;--muted:#9aa0a6;--card:#141416;--border:#26272b;--accent:#6ee7b7}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 -apple-system,BlinkMacSystemFont,"Helvetica Neue",Helvetica,Arial,"Segoe UI",Roboto,Inter,system-ui,sans-serif}
    .wrap{max-width:920px;margin:0 auto;padding:16px}

    html{-webkit-text-size-adjust:100%}
    input,select,button{font-size:16px}
    @media (max-width:560px){
      body{font-size:15px}
      header{gap:8px}
      #site-title{font-size:44px;-webkit-text-stroke:1.5px #fdf6d0}
      .wrap{padding:12px}
      .row{grid-template-columns:auto 1fr auto;padding:8px 10px;min-height:64px}
      .badge .pill{padding:3px 8px;font-size:11px}
    }

    header{display:flex;align-items:center;justify-content:space-between;gap:12px;position:relative}
    #site-title{margin:0;font-size:56px;font-weight:bold;font-family:"Helvetica Neue",Helvetica,Arial,sans-serif;color:transparent;-webkit-text-fill-color:transparent;-webkit-text-stroke:2px #fdf6d0}

    .player{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(11,11,12,.97),rgba(11,11,12,.92));backdrop-filter:saturate(120%) blur(8px);border-bottom:1px solid var(--border)}
    .now{display:grid;grid-template-columns:auto 1fr auto;gap:12px;align-items:center;padding:12px 0}
    .cover{width:56px;height:56px;border-radius:8px;background:#1e1f24;display:grid;place-items:center;color:var(--muted);font-weight:700;border:1px solid var(--border)}
    .meta{min-width:0}
    .title{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .sub{color:var(--muted);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .controls{display:flex;align-items:center;gap:8px}
    button{appearance:none;background:var(--card);color:var(--fg);border:1px solid var(--border);border-radius:10px;padding:8px 12px;cursor:pointer}
    button:disabled{opacity:.55;cursor:not-allowed}
    .range{display:flex;align-items:center;gap:8px}
    input[type="range"]{width:160px}
    .list{margin:12px 0 40px;border:1px solid var(--border);border-radius:14px;overflow:hidden}
    .row{display:grid;grid-template-columns:56px 1fr auto;gap:12px;align-items:center;padding:10px 12px;border-top:1px solid var(--border);background:var(--card);min-height:78px}
    .row:first-child{border-top:0}
    .row:hover{background:#17171b}
    .badge{display:flex;gap:10px;align-items:center;font-size:12px;justify-self:end}
    .badge a{color:var(--fg);text-decoration:none;border:1px solid var(--border);padding:4px 8px;border-radius:8px}
    .badge .muted{color:var(--muted)}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    select{background:var(--card);color:var(--fg);border:1px solid var(--border);border-radius:10px;padding:8px 10px}
    .tog,.btn{display:inline-flex;align-items:center;justify-content:center;height:36px;min-width:36px;padding:0 10px;border-radius:10px;border:1px solid var(--border);background:var(--card);text-decoration:none;color:var(--fg);line-height:1}
    .tog{opacity:.6;transition:opacity .15s, box-shadow .15s}
    .tog.on{opacity:1;box-shadow:0 0 0 2px var(--accent) inset}
    details.menu>summary{cursor:pointer;list-style:none;background:var(--card);border:1px solid var(--border);padding:8px 12px;border-radius:10px;user-select:none}
    .sheet{position:absolute;top:calc(100% + 8px);right:0;z-index:20;width:min(420px,calc(100vw - 32px));background:var(--card);border:1px solid var(--border);border-radius:10px;padding:10px;display:none;box-shadow:0 10px 24px rgba(0,0,0,.35)}
    details.menu[open]>.sheet{display:block}
    details.menu[open]>summary{border-bottom-left-radius:10px;border-bottom-right-radius:10px}

    @supports (-webkit-touch-callout:none){.range[title="Volume"]{display:none !important}}

    @media (max-width:560px){
      .now{grid-template-columns:1fr;gap:8px}
      .cover{display:none}
      .controls{flex-wrap:wrap}
      .range input[type="range"]{width:120px}
      .row{grid-template-columns:1fr auto}

.version-buttons {
  display: inline-flex;
  gap: 0.25em;
  margin-right: 0.5em;
  vertical-align: middle;
}

.version-button {
  background: transparent;
  border: 1px solid #999;
  border-radius: 4px;
  font-size: 0.75em;
  padding: 0 0.3em;
  cursor: pointer;
  color: #555;
  transition: all 0.2s;
}

.version-button:hover {
  border-color: var(--accent, #000);
  color: var(--accent, #000);
}

.version-button.active {
  background: var(--accent, #000);
  color: #fff;
  border-color: var(--accent, #000);
}

/* --- VVIP25: thumbnail readability patch (Oct 2025) --- */
@media (max-width: 560px) {
  .row {
    grid-template-columns: 72px 1fr; /* slightly larger thumb, tighter layout */
    gap: 8px;
    padding: 8px 10px;
  }

  .thumb {
    width: 72px;
    height: 72px;
    border-radius: 8px;
  }

  .title {
    font-size: 15px;
    font-weight: 600;
    line-height: 1.2;
    white-space: normal;
    overflow: hidden;
  }

  .subline {
    font-size: 11px;
    color: var(--muted);
  }
}
    }
  </style>
</head>
<body>
  <div class="player">
    <div class="wrap">
      <header>
        <h1 id="site-title">VVIP25</h1>
        <details class="menu" id="menu">
          <summary>‚ò∞ Menu</summary>
          <div class="sheet">
            <div class="toolbar" id="toolbar"></div>
          </div>
        </details>
      </header>

      <div class="now">
        <div class="cover" id="cover">V25</div>
        <div class="meta">
          <div class="title" id="now-title">‚Äî</div>
          <div class="sub" id="now-sub">Ready</div>
        </div>
        <div class="controls">
          <button id="prev" aria-label="Previous">‚èÆÔ∏è</button>
          <button id="toggle" aria-label="Play/Pause">‚ñ∂Ô∏è</button>
          <button id="next" aria-label="Next">‚è≠Ô∏è</button>
          <div class="range">
            <span id="tcur">0:00</span>
            <input id="seek" type="range" min="0" max="100" value="0" step="1" aria-label="Seek" />
            <span id="tdur">0:00</span>
          </div>
          <div class="range" title="Volume">
            <span>üîä</span>
            <input id="vol" type="range" min="0" max="1" step="0.01" />
          </div>
        </div>
      </div>
    </div>
  </div>

  <main id="page-root" data-page="home">
    <div class="wrap">
      <div id="list" class="list" role="list"></div>
    </div>
  </main>

  <audio id="audio" preload="metadata"></audio>

<script>
/* ========= VVIPMEDIA ‚Äî Core Player (Unified List) + SPA Router ========= */

const ASSET_VERSION = 18;
const PREFERRED_TITLE = 'washed sand';

/* ---------- Config ---------- */
const BASE_MP3   = 'https://media.vvipmedia.net/ACCESS/';
const BASE_WAV   = 'https://media.vvipmedia.net/WAV/';
const BASE_THUMB = 'https://media.vvipmedia.net/ACCESS/';
const BASE_VIDEO = 'https://media.vvipmedia.net/VIDEOS/';
const DEFAULT_THUMB = BASE_THUMB + 'default_thumb.jpg';

/* ---------- Cache hint ---------- */
(() => { try {
  const m=document.createElement('meta'); m.httpEquiv='Cache-Control'; m.content='no-store, max-age=0, must-revalidate';
  document.head.appendChild(m);
} catch(_){} })();

/* ---------- CSS polish injected via JS ---------- */
(() => {
  const css = `
    :root{--logo:#fdf6d0}
    .btn,.tog{display:inline-flex;align-items:center;justify-content:center;height:36px;min-width:36px;
      padding:0 12px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--fg);text-decoration:none;line-height:1;cursor:pointer}
    .tog{opacity:.75;transition:opacity .15s, box-shadow .15s}
    .tog.on{opacity:1;box-shadow:0 0 0 2px var(--accent) inset}
    .panel{display:none;margin-top:8px;border:1px solid var(--border);border-radius:10px;padding:8px}
    .row-links{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .pill{border:1px solid var(--border);border-radius:999px;padding:4px 10px;font-size:12px;text-decoration:none;color:var(--fg)}
    .star{cursor:pointer}
    .star.on{filter:drop-shadow(0 0 2px var(--accent)) brightness(1.2)}
    .controls button svg{width:18px;height:18px;fill:var(--logo)}
    /* Favorites/Search bar */
    .favbar{display:none;margin:10px 0 8px;gap:10px;align-items:center;flex-wrap:wrap}
    .favbar .mode{font-size:14px;color:var(--muted)}
    .favbar input[type="search"]{flex:1;min-width:200px;background:var(--card);color:var(--fg);
      border:1px solid var(--border);border-radius:10px;padding:8px 10px}
    body.light{--bg:#f7f7f8;--fg:#111;--muted:#4b5563;--card:#ffffff;--border:#d1d5db;--accent:#2563eb}
    body.light .player{background:linear-gradient(180deg,rgba(255,255,255,.96),rgba(255,255,255,.92))}
    body.light #site-title{-webkit-text-stroke:2px #111}
  `;
  const style=document.createElement('style'); style.textContent=css; document.head.appendChild(style);
})();

/* ---------- Helpers ---------- */
const $=s=>document.querySelector(s);
function fmtDur(sec){ sec=Number(sec||0); const m=Math.floor(sec/60), s=Math.floor(sec%60); return `${m}:${String(s).padStart(2,'0')}`; }
function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); } }
function escapeHTML(s){ return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
const rawFile=s=>(String(s).split('/').pop()||'');
const stripExt=s=>String(s).replace(/\.[a-z0-9]+$/i,'');
const softNorm=s=>stripExt(s).toLowerCase().replace(/[ _]+/g,'-').replace(/-+/g,'-');
function deriveTitleFromFilename(name){ const b=stripExt(rawFile(name)).replace(/^[\d._-]+/,'').replace(/[_-]+/g,' ').trim(); return b || stripExt(rawFile(name)); }
const primaryOnly = t => String(t||'').split('//')[0].trim();
const DATE_RX_YYYY=/^\s*(\d{4})[.\-_](\d{2})[.\-_](\d{2})(?=\D|$)/;
const DATE_RX_YY=/^\s*(\d{2})[.\-_](\d{2})[.\-_](\d{2})(?=\D|$)/;
const WITHIN_DAY_RX=/^\s*(?:\d{4}|\d{2})[.\-_]\d{2}[.\-_]\d{2}(?:[.\-_](\d+))?/;
function fallbackDateFromName(name){
  const s=String(name); let m=s.match(DATE_RX_YYYY);
  if(m){return new Date(Date.UTC(+m[1],+m[2]-1,+m[3]));}
  m=s.match(DATE_RX_YY); if(m){const yy=+m[1];const yyyy=(yy>=70?1900+yy:2000+yy);return new Date(Date.UTC(yyyy,+m[2]-1,+m[3]));}
  return null;
}
function withinDayIndexFromName(name){ const m=String(name).match(WITHIN_DAY_RX); return m&&m[1]?parseInt(m[1],10):0; }
function bpmSortValue(t){ if(t.bpm!=null) return t.bpm; if(t.bpm_min!=null&&t.bpm_max!=null) return (t.bpm_min+t.bpm_max)/2; return 0; }
function bpmLabel(t){ if(t.bpm!=null) return `${t.bpm} BPM`; if(t.bpm_min!=null&&t.bpm_max!=null) return `${t.bpm_min}‚Äì${t.bpm_max} BPM`; return ''; }
function matchesTokens(t,tokens){
  if(!tokens.length) return true;
  const hayName=(t.name||'').toLowerCase();
  const hayTitle=(t.title||'').toLowerCase();
  const hayDetails=(t.details||'').toLowerCase();
  return tokens.every(tok=>{
    if (tok.startsWith('#')) return hayDetails.includes(tok);
    return hayName.includes(tok) || hayTitle.includes(tok) || hayDetails.includes(tok);
  });
}

/* ---------- Elements & State ---------- */
const els = {
  audio:$('#audio'), list:$('#list'), sort:$('#sort'),
  toggle:$('#toggle'), prev:$('#prev'), next:$('#next'),
  seek:$('#seek'), vol:$('#vol'),
  nowTitle:$('#now-title'), nowSub:$('#now-sub'), cover:$('#cover'),
  tcur:$('#tcur'), tdur:$('#tdur'),
  menu:$('#menu'), toolbar:$('#toolbar'),
  favbar:null, favInput:null, favModeLabel:null, wrap:null
};

const state = {
  tracks:[], filtered:[], i:-1, playing:false,
  pageSize:60, renderCount:0,
  titlesLookup:new Map(), thumbBases:new Set(), resolvedThumb:new Map(),
  showTitles:true, showWavButtons:false, showMovButtons:false,
  favorites:new Set(JSON.parse(localStorage.getItem('vvip25:favs')||'[]')),
  favOrder: JSON.parse(localStorage.getItem('vvip25:favOrder')||'[]'),
  searchQuery:'',
  viewMode:'all', /* 'all' | 'favorites' | 'search' */
  light: localStorage.getItem('vvip25:light')==='1',
  extras:{}   // <-- ensure defined
};

els.vol.value = localStorage.getItem('vvip25:vol') ?? '0.9';
els.audio.volume = parseFloat(els.vol.value);
if (state.light) document.body.classList.add('light');

/* ---------- Boot ---------- */
init();
async function init(){
  buildMenuUI();
  buildFavBar();              // single search lives here
  setControlIcons();

  let res = await fetch(`/manifest.json?v=${ASSET_VERSION}`, {cache:'no-store'});
  if(!res.ok) res = await fetch(`./manifest.json?v=${ASSET_VERSION}`, {cache:'no-store'});
  if(!res.ok){ els.list && (els.list.innerHTML='<div class="row"><div></div><div>manifest.json missing</div></div>'); return; }

  const data = await res.json();
  state.tracks = data.map((t,idx)=>{
    const name = t.name || t.file || t.src?.split('/').pop() || `track-${idx}.mp3`;
    const base = stripExt(name), baseLower=base.toLowerCase();
    const dateObj = t.date ? new Date(t.date) : fallbackDateFromName(name);
    const mp3 = t.src || (BASE_MP3 + encodeURIComponent(name.toLowerCase()));
    const wav = BASE_WAV + encodeURIComponent(base + '.wav');
    const mov = t.has_mov ? (BASE_VIDEO + encodeURIComponent(base + '.mov')) : null;
    const thumbCandidate = BASE_THUMB + encodeURIComponent(baseLower + 'thumb.jpg');
    const details = t.details || '';
    return { id:idx, name, base, baseLower, title: t.title?String(t.title):'',
      bpm:t.bpm??null, bpm_min:t.bpm_min??null, bpm_max:t.bpm_max??null,
      details, length:t.length||0, date:dateObj||null, src:mp3, wav, video:mov, thumbCandidate };
  });

  // ===== Group multiple versions (v1, v2, or -2) =====
  (() => {
    const baseKey = n => n.toLowerCase().replace(/[\s\-_]?(v\d+|\-\d+)$/, '');
    const groups = new Map();
    for (const t of state.tracks) {
      const key = baseKey(t.baseLower);
      if (!groups.has(key)) groups.set(key, []);
      groups.get(key).push(t);
    }
    const merged = [];
    for (const [, arr] of groups.entries()) {
      if (arr.length === 1) { merged.push(arr[0]); continue; }
      arr.sort((a,b)=>{
        const va = +(a.baseLower.match(/(?:v|\-)(\d+)$/)?.[1]||0);
        const vb = +(b.baseLower.match(/(?:v|\-)(\d+)$/)?.[1]||0);
        return vb - va;
      });
      const latest = arr[0];
      latest.versions = arr.slice(1);
      merged.push(latest);
    }
    state.tracks = merged;
  })();

  // first render pass after grouping
  applyFilterSort(true);

  // hydrate titles & thumbs (non-blocking for initial paint)
  await fetchTitles().catch(()=>{});
  await fetchThumbs().catch(()=>{});

  // set initial view and try to preselect preferred
  setView('all');
  preselectPreferred(PREFERRED_TITLE);
}

/* ---------- View / Filter logic ---------- */
function setView(mode){
  state.viewMode = mode; // 'all' | 'favorites' | 'search'
  if (mode === 'all'){
      state.searchQuery='';
      if (els.favInput) els.favInput.value='';
      hideFavBar();
  } else {
      showFavBar();
  }
  applyFilterSort(true);
  renderList();
  fillViewport();
  if (els.menu) els.menu.open = false;
  updateFavModeLabel();
}

function updateFavModeLabel(){
  if(!els.favModeLabel) return;
  let label='All';
  if (state.viewMode==='favorites') label='Favorites';
  if (state.viewMode==='search') label=`Search${state.searchQuery ? `: ‚Äú${state.searchQuery}‚Äù` : ''}`;
  els.favModeLabel.textContent = label;
}

function buildFavBar(){
  const wrap = document.querySelector('main#page-root .wrap');
  els.wrap = wrap;
  const bar = document.createElement('div');
  bar.className='favbar';
  bar.innerHTML = `
    <span class="mode" id="favMode">Search</span>
    <input id="favSearch" type="search" placeholder="Filter with #tags or text" autocomplete="off" />
  `;
  wrap.insertBefore(bar, wrap.firstElementChild.nextElementSibling);
  els.favbar = bar;
  els.favInput = bar.querySelector('#favSearch');
  els.favModeLabel = bar.querySelector('#favMode');

  els.favInput.addEventListener('input', debounce(()=>{
    const q = (els.favInput.value||'').trim();
    state.searchQuery = q.toLowerCase();
    setView(q ? 'search' : 'favorites');
  }, 120));
}

function showFavBar(){ if(els.favbar) els.favbar.style.display='flex'; }
function hideFavBar(){ if(els.favbar) els.favbar.style.display='none'; }

function isNameless(t){ const derived=deriveTitleFromFilename(t.name); return !t.title || t.title===derived; }

function applyFilterSort(firstPaint=false, keepIndex=false){
  const tokens=(state.searchQuery||'').trim().toLowerCase().split(/\s+/).filter(Boolean);
  let out=[...state.tracks];

  switch(els.sort?.value||'date_desc'){
    case 'date_desc': out.sort((a,b)=>{ const da=a.date?.getTime()||0, db=b.date?.getTime()||0;
      if (db!==da) return db-da; return withinDayIndexFromName(b.name)-withinDayIndexFromName(a.name) || b.name.localeCompare(a.name); }); break;
    case 'date_asc':  out.sort((a,b)=>{ const da=a.date?.getTime()||0, db=b.date?.getTime()||0;
      if (da!==db) return da-db; return withinDayIndexFromName(a.name)-withinDayIndexFromName(b.name) || a.name.localeCompare(b.name); }); break;
    case 'bpm_desc':  out.sort((a,b)=> bpmSortValue(b)-bpmSortValue(a)); break;
    case 'bpm_asc':   out.sort((a,b)=> bpmSortValue(a)-bpmSortValue(b)); break;
    case 'len_desc':  out.sort((a,b)=> (b.length||0)-(a.length||0)); break;
    case 'len_asc':   out.sort((a,b)=> (a.length||0)-(b.length||0)); break;
  }

  if (state.viewMode === 'favorites' && !tokens.length){
    out = out.filter(t=>state.favorites.has(t.name));
  } else if (state.viewMode === 'search' && tokens.length){
    out = out.filter(t=>matchesTokens(t,tokens));
  }

  if (state.showTitles && (state.viewMode!=='search' || !tokens.length)){
    out = out.filter(t=>!isNameless(t));
  }

  state.filtered=out;
  const initialChunk=firstPaint ? Math.max(60,state.pageSize) : state.pageSize;
  state.renderCount=Math.min(state.filtered.length, initialChunk);
  if (!keepIndex) state.i=Math.min(state.i, state.renderCount-1);
  renderList(); setupInfiniteScroll(); fillViewport();
  updateFavModeLabel();
}

const displayName=t=> (state.showTitles && t.title) ? t.title : t.name;

/* ---------- Titles / Thumbs ---------- */
function buildTitleLookup(json){
  const map=new Map();
  const add=(k,titleRaw)=>{ if(!k||!titleRaw) return; const title=primaryOnly(titleRaw);
    const f=rawFile(String(k).toLowerCase()); const noExt=stripExt(f); const norm=softNorm(f);
    map.set(f,String(title)); map.set(noExt,String(title)); map.set(norm,String(title));
  };
  if (Array.isArray(json)){ for(const row of json){ add(row.key||row.src||row.name, row.title||row.t||row.display); } }
  else if (json && typeof json==='object'){ for(const [k,v] of Object.entries(json)){ add(k, typeof v==='string'?v:(v&&v.title)); } }
  return map;
}
function bestTitleForTrack(t,lookup){
  const f=rawFile(t.name).toLowerCase(), noExt=stripExt(f), norm=softNorm(f), fromSrc=t.src?rawFile(t.src).toLowerCase():'';
  const cands=[f,noExt,norm,fromSrc,stripExt(fromSrc),softNorm(fromSrc),t.base?.toLowerCase?.(),softNorm(t.base||'')].filter(Boolean);
  for(const c of cands){ if(lookup.has(c)) return lookup.get(c); } return '';
}
async function fetchTitles(){
  let r=await fetch(`/titles.json?v=${ASSET_VERSION}&t=${Date.now()}`,{cache:'no-store'});
  if(!r.ok) r=await fetch(`./titles.json?v=${ASSET_VERSION}&t=${Date.now()}`,{cache:'no-store'});
  if(!r.ok) return;
  const json=await r.json();
  const lookup=buildTitleLookup(json);
  let changed=false;
  for(const t of state.tracks){
    const from=bestTitleForTrack(t,lookup);
    const final=from || t.title || deriveTitleFromFilename(t.name);
    if (final!==t.title){ t.title=final; changed=true; }
  }
  if (changed){ applyFilterSort(false,true); refreshTitlesOnly(); }
}
async function fetchThumbs(){
  let r=await fetch(`/thumbs.json?v=${ASSET_VERSION}`,{cache:'no-store'});
  if(!r.ok) r=await fetch(`./thumbs.json?v=${ASSET_VERSION}`,{cache:'no-store'});
  if(!r.ok) return;
  const data=await r.json();
  const set=new Set();
  if(Array.isArray(data)) data.forEach(b=>set.add(String(b).toLowerCase()));
  else if(data && typeof data==='object') Object.keys(data).forEach(b=>{ if(data[b]) set.add(b.toLowerCase()); });
  state.thumbBases=set; computeThumbCascade(); rerenderVisibleRowsThumbs(); if(state.i>=0) updateNowbar();
}
function computeThumbCascade(){
  const asc=[...state.tracks].sort((a,b)=>{ const da=a.date?.getTime()||0, db=b.date?.getTime()||0;
    if(da!==db) return da-db; return withinDayIndexFromName(a.name)-withinDayIndexFromName(b.name) || a.name.localeCompare(b.name);
  });
  let currentThumb=DEFAULT_THUMB;
  for(const t of asc){ if(state.thumbBases.has(t.baseLower)) currentThumb=t.thumbCandidate; state.resolvedThumb.set(t.id,currentThumb); }
}
const getResolvedThumb=t=>state.resolvedThumb.get(t.id)||DEFAULT_THUMB;

/* ---------- Render ---------- */
function imgHTML(src){ const esc=s=>s.replace(/"/g,'&quot;');
  return `<img src="${esc(src)}" alt="" loading="lazy" style="width:56px;height:56px;border-radius:8px;object-fit:cover;" onerror="if(this.dataset.fbk!=='1'){this.dataset.fbk='1';this.onerror=null;this.src='${DEFAULT_THUMB}';}">`;
}
function favHTML(t){
  const on=state.favorites.has(t.name)?'on':'';
  const title=state.favorites.has(t.name)?'Remove from favorites':'Add to favorites';
  return `<button class="star ${on}" data-fav="${escapeHTML(t.name)}" title="${title}">‚òÖ</button>`;
}
function badgeHTML(t){
  const parts=[favHTML(t), `<a class="pill" href="${t.src}" download title="Download MP3">MP3</a>`];
  if (state.showWavButtons) parts.push(`<a class="pill" href="${BASE_WAV+encodeURIComponent(t.base+'.wav')}" download title="Download Lossless">WAV</a>`);
  if (state.showMovButtons && t.video) parts.push(`<a class="pill" href="${t.video}" target="_blank" rel="noopener" title="Open Video">MOV</a>`);
  if (state.showMovButtons && !t.video) parts.push('<span class="pill muted">MOV</span>');
  return `<div class="badge">${parts.join('')}</div>`;
}
function rowHTML(t, active) {
  const bpmTxt = bpmLabel(t);
  const thumbURL = getResolvedThumb(t);
  const subline = [bpmTxt, t.length ? fmtDur(t.length) : '', t.date ? t.date.toISOString().slice(0,10) : '']
    .filter(Boolean).join(' ¬∑ ');

  const versionButtons = t.versions && t.versions.length
    ? `<span class="version-buttons">${t.versions.map(v =>
        `<button class="version-button ${v===t.version ? 'active' : ''}" onclick="setVersion('${t.id}','${v}')">${v}</button>`
      ).join('')}</span>`
    : '';

  return `
    <div class="row ${active ? 'active' : ''}" data-id="${t.id}">
      <div class="left">
        <img class="thumb" src="${thumbURL}" alt="">
      </div>
      <div class="middle">
        <div class="track-title">
          ${versionButtons}
          <span class="title">${t.title}</span>
        </div>
        <div class="subline">${subline}</div>
      </div>
      <div class="right">
        ${badgeHTML(t)}
      </div>
    </div>
  `;
}
function setVersion(id, versionName) {
  const t = state.tracks.find(x => String(x.id) === String(id));
  if (!t) return;
  t.version = versionName;
  const match = t.versions?.find(v => v.name === versionName);
  if (match) t.src = BASE_MP3 + encodeURIComponent(match.name.toLowerCase());
  renderList();
}
function renderList(){
  if(!state.filtered.length){ if(els.list) els.list.innerHTML='<div class="row"><div></div><div>No results.</div></div>'; return; }
  if(!els.list) return;
  const slice=state.filtered.slice(0,state.renderCount);
  els.list.innerHTML = slice.map(t=>rowHTML(t,(state.i>=0 && state.filtered[state.i]?.id===t.id))).join('') + `<div id="sentinel" style="height:1px"></div>`;
}
function rerenderVisibleRowsThumbs(){ els.list?.querySelectorAll('.row').forEach(row=>{ const id=+row.getAttribute('data-id'); const t=state.tracks.find(x=>x.id===id); if(!t) return; const img=row.querySelector('.cover img'); if(img) img.src=getResolvedThumb(t); }); }
function rerenderVisibleRowsBadges(){
  document.querySelectorAll('.row').forEach(row=>{
    const id = +row.getAttribute('data-id');
    const t  = state.tracks.find(x=>x.id===id);
    if(!t) return;
    const badge = row.querySelector('.badge');
    if (badge) badge.outerHTML = badgeHTML(t);
  });
}
function refreshTitlesOnly(){
  document.querySelectorAll('.row').forEach(row=>{
    const id=+row.getAttribute('data-id'); const t=state.tracks.find(x=>x.id===id); if(!t) return;
    const titleEl=row.querySelector('.title'); const subEl=row.querySelector('.sub');
    if (titleEl){ const isActive=(state.i>=0 && state.filtered[state.i]?.id===id); titleEl.innerHTML=(isActive?'‚ñ∂Ô∏é ':'') + escapeHTML(displayName(t)); }
    if (subEl){ const bpmTxt=bpmLabel(t); const subline=[ bpmTxt, t.length?fmtDur(t.length):'', t.date? t.date.toISOString().slice(0,10):'' ].filter(Boolean).join(' ¬∑ '); subEl.textContent=subline; }
  });
  if (state.i>=0) updateNowbar();
  applyFilterSort(false,true);
}

/* ---------- Infinite scroll ---------- */
let sentinelObserver;
function setupInfiniteScroll(){
  const s=$('#sentinel'); if(!s) return;
  if(sentinelObserver) sentinelObserver.disconnect();
  if('IntersectionObserver' in window){
    sentinelObserver=new IntersectionObserver((entries)=>{ for(const e of entries){ if(e.isIntersecting) appendChunk(); } },{root:null,rootMargin:'1200px 0px',threshold:0});
    sentinelObserver.observe(s);
  }
  window.addEventListener('scroll', onScrollMaybeLoad, { passive:true });
  window.addEventListener('resize', debounce(fillViewport,120), { passive:true });
}
function appendChunk(){
  if (state.renderCount>=state.filtered.length) return;
  const prev=state.renderCount; state.renderCount=Math.min(state.filtered.length, state.renderCount+state.pageSize);
  const sentinel=$('#sentinel'); if(!sentinel) return;
  const frag=document.createDocumentFragment();
  for(let i=prev;i<state.renderCount;i++){
    const t=state.filtered[i]; const div=document.createElement('div'); div.innerHTML=rowHTML(t,(state.i>=0 && state.filtered[state.i]?.id===t.id)); frag.appendChild(div.firstChild);
  }
  els.list.insertBefore(frag, sentinel);
}
function atBottomBuffer(px=1200){ return (window.scrollY + window.innerHeight + px) >= document.documentElement.scrollHeight; }
function onScrollMaybeLoad(){ if (atBottomBuffer()) appendChunk(); }
function fillViewport(){
  let guard=0; while(guard++<10){ const scrollable=document.documentElement.scrollHeight>window.innerHeight+200;
    if (scrollable || state.renderCount>=state.filtered.length) break; appendChunk();
  }
}

/* ---------- Selection / Player ---------- */
function select(indexInFiltered){
  state.i=indexInFiltered;
  const t=state.filtered[indexInFiltered]; if(!t) return;
  els.audio.src=t.src; updateNowbar(); state.playing=false; updateToggle(); setControlIcons();
  els.list?.querySelectorAll('.row').forEach(row=>{
    const id=+row.getAttribute('data-id'); const titleEl=row.querySelector('.title'); if(!titleEl) return;
    const isActive=(state.filtered[state.i]?.id===id);
    const tr=state.tracks.find(x=>x.id===id)||t;
    titleEl.innerHTML=(isActive?'‚ñ∂Ô∏é ':'') + escapeHTML(displayName(tr));
  });
}
function preselectPreferred(titleLike){
  const want = String(titleLike||'').toLowerCase();
  if (!want) { if (state.filtered.length && state.i===-1) select(0); return; }
  let idx = state.filtered.findIndex(t => (t.title||'').toLowerCase().includes(want));
  if (idx < 0) idx = state.filtered.findIndex(t => (t.name||'').toLowerCase().includes(want));
  if (idx >= 0) select(idx);
  else if (state.filtered.length && state.i===-1) select(0);
}
function updateNowbar(){
  const t=state.filtered[state.i]; if(!t) return;
  els.nowTitle.textContent=displayName(t);
  const bpmTxt=bpmLabel(t);
  els.nowSub.textContent=[ bpmTxt, t.length?fmtDur(t.length):'', t.date? t.date.toISOString().slice(0,10):'' ].filter(Boolean).join(' ¬∑ ');
  const url=getResolvedThumb(t);
  els.cover.innerHTML=`<img src="${url.replace(/"/g,'&quot;')}" alt="" style="width:56px;height:56px;object-fit:cover;border-radius:8px" onerror="if(this.dataset.fbk!=='1'){this.dataset.fbk='1';this.onerror=null;this.src='${DEFAULT_THUMB}';}">`;
}
async function play(){ try{ await els.audio.play(); state.playing=true; updateToggle(); setControlIcons(); }catch(_){} }
function pause(){ els.audio.pause(); state.playing=false; updateToggle(); setControlIcons(); }
function updateToggle(){ const btn=$('#toggle'); if(btn) btn.setAttribute('data-state', state.playing ? 'pause' : 'play'); }
function jump(dir){ if(!state.filtered.length) return; let i=state.i+dir; if(i<0) i=state.filtered.length-1; if(i>=state.filtered.length) i=0; select(i); play(); }

/* ---------- Bespoke SVG icons ---------- */
function setControlIcons(){
  const svgPrev='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7 5a1 1 0 0 1 1 1v12a1 1 0 1 1-2 0V6a1 1 0 0 1 1-1zm11.4 1.2a1 1 0 0 1 .6.9v9.8a1 1 0 0 1-1.6.8l-8.2-4.9a1 1 0 0 1 0-1.7l8.2-4.9a1 1 0 0 1 1-.1z"/></svg>';
  const svgNext='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 5a1 1 0 0 1 1 1v12a1 1 0 1 1-2 0V6a1 1 0 0 1 1-1zM5.6 6.2a1 1 0 0 1 1 .1l8.2 4.9a1 1 0 0 1 0 1.7l-8.2 4.9A1 1 0 0 1 5 17V7.2a1 1 0 0 1 .6-.9z"/></svg>';
  const svgPlay='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.7 6.3a1 1 0 0 1 1.1-.1l8 4.8a1.3 1.3 0 0 1 0 2.2l-8 4.8a1 1 0 0 1-1.5-.9V7.3a1 1 0 0 1 .4-.9z"/></svg>';
  const svgPause='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8 6a1 1 0 0 1 1 1v10a1 1 0 1 1-2 0V7a1 1 0 0 1 1-1zm8 0a1 1 0 0 1 1 1v10a1 1 0 1 1-2 0V7a1 1 0 0 1 1-1z"/></svg>';
  if (els.prev)   els.prev.innerHTML = svgPrev;
  if (els.next)   els.next.innerHTML = svgNext;
  if (els.toggle) els.toggle.innerHTML = (state.playing ? svgPause : svgPlay);
}

/* ---------- Menu / UI ---------- */
function buildMenuUI(){
  const tb=els.toolbar; if(!tb) return; tb.innerHTML='';
  const row=document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; row.style.flexWrap='wrap'; row.style.alignItems='center'; tb.appendChild(row);

  // About + Utils + Links
  const btnAbout=document.createElement('button'); btnAbout.className='btn'; btnAbout.title='About'; btnAbout.textContent='üìú'; row.appendChild(btnAbout);
  btnAbout.addEventListener('click',(e)=>{ e.preventDefault(); alert("VVIPMEDIA ‚Äî 2025"); keepMenuOpen(); });

  const btnUtils=document.createElement('button'); btnUtils.className='btn'; btnUtils.title='Utilities'; btnUtils.textContent='üõ†Ô∏è'; row.appendChild(btnUtils);
  const util=document.createElement('div'); util.className='panel';
  util.innerHTML = `<div class="row-links">
    <button class="tog ${state.showTitles?'on':''}" id="togTitles" title="Song Titles (on/off)">üìù</button>
    <button class="tog ${state.showWavButtons?'on':''}" id="togWav" title="Show WAV buttons">üéöÔ∏è</button>
    <button class="tog ${state.showMovButtons?'on':''}" id="togMov" title="Show MOV buttons">üé¨</button>
    <button class="tog ${state.light?'on':''}" id="togLight" title="Light mode">üåû</button>
  </div>`;
  tb.appendChild(util);

  const btnLinks=document.createElement('button'); btnLinks.className='btn'; btnLinks.title='Links'; btnLinks.textContent='üîó'; row.appendChild(btnLinks);
  const links=document.createElement('div'); links.className='panel';
  links.innerHTML = `<div class="row-links">
    <a class="btn" href="https://www.youtube.com/@VVVVIIPP25" target="_blank" rel="noopener" title="YouTube">üì∫</a>
    <a class="btn" href="https://virtualvip.bandcamp.com/" target="_blank" rel="noopener" title="Bandcamp">üéß</a>
    <a class="btn" href="https://www.instagram.com/virtualvip24/" target="_blank" rel="noopener" title="Instagram">üì∑</a>
    <a class="btn" href="https://substack.com/home/post/p-170664918?source=queue" target="_blank" rel="noopener" title="Newsletter">üì∞</a>
  </div>`;
  tb.appendChild(links);

  // Main controls
  const btnMusic=document.createElement('button'); btnMusic.className='btn'; btnMusic.title='Music'; btnMusic.textContent='üéµ'; row.appendChild(btnMusic);
  const btnPlaylist=document.createElement('button'); btnPlaylist.className='btn'; btnPlaylist.title='Playlist'; btnPlaylist.textContent='‚≠ê'; row.appendChild(btnPlaylist);
  const aShop=document.createElement('a'); aShop.className='btn'; aShop.title='Shoppe'; aShop.textContent='üõçÔ∏è'; aShop.href='/shoppe/'; aShop.setAttribute('data-nav',''); row.appendChild(aShop);

  btnMusic.addEventListener('click',(e)=>{ e.preventDefault(); setView('all'); });
  btnPlaylist.addEventListener('click',(e)=>{ e.preventDefault(); if(!els.favbar) buildFavBar(); setView('favorites'); });

  const sortSel=document.createElement('select'); sortSel.id='sort'; sortSel.title='Sort';
  sortSel.innerHTML=`<option value="date_desc">Newest</option><option value="date_asc">Oldest</option><option value="bpm_desc">BPM ‚Üì</option><option value="bpm_asc">BPM ‚Üë</option><option value="len_desc">Longest</option><option value="len_asc">Shortest</option>`;
  row.appendChild(sortSel); els.sort=sortSel;

  btnUtils.addEventListener('click',(e)=>{ e.preventDefault();
    const show = util.style.display!=='block'; util.style.display = show?'block':'none'; if(show) links.style.display='none'; keepMenuOpen();
  });
  btnLinks.addEventListener('click',(e)=>{ e.preventDefault();
    const show = links.style.display!=='block'; links.style.display = show?'block':'none'; if(show) util.style.display='none'; keepMenuOpen();
  });

  util.querySelector('#togTitles').addEventListener('click', (e)=>{ state.showTitles=!state.showTitles; e.currentTarget.classList.toggle('on',state.showTitles); refreshTitlesOnly(); keepMenuOpen(); });
  util.querySelector('#togWav').addEventListener('click', (e)=>{ state.showWavButtons=!state.showWavButtons; e.currentTarget.classList.toggle('on',state.showWavButtons); rerenderVisibleRowsBadges(); keepMenuOpen(); });
  util.querySelector('#togMov').addEventListener('click', (e)=>{ state.showMovButtons=!state.showMovButtons; e.currentTarget.classList.toggle('on',state.showMovButtons); rerenderVisibleRowsBadges(); keepMenuOpen(); });
  util.querySelector('#togLight').addEventListener('click', (e)=>{ state.light=!state.light; document.body.classList.toggle('light',state.light); localStorage.setItem('vvip25:light', state.light?'1':'0'); e.currentTarget.classList.toggle('on',state.light); keepMenuOpen(); });
}
function keepMenuOpen(){ if (els.menu) els.menu.open = true; }

/* ---------- Events ---------- */
document.addEventListener('click',(e)=>{
  const favBtn=e.target.closest?.('.star');
  if (favBtn && favBtn.hasAttribute('data-fav')){
    const key=favBtn.getAttribute('data-fav'); const was=state.favorites.has(key);
    if (was){ state.favorites.delete(key); state.favOrder=state.favOrder.filter(n=>n!==key); }
    else { state.favorites.add(key); if(!state.favOrder.includes(key)) state.favOrder.push(key); }
    localStorage.setItem('vvip25:favs', JSON.stringify([...state.favorites]));
    localStorage.setItem('vvip25:favOrder', JSON.stringify(state.favOrder));
    favBtn.classList.toggle('on', !was);
    if (state.viewMode!=='all') applyFilterSort(false,true);
    e.preventDefault(); return;
  }
  const row=e.target.closest?.('.row');
  if(row && !e.target.closest('a')){
    const id=Number(row.getAttribute('data-id')); const idx=state.filtered.findIndex(t=>t.id===id);
    if(idx>=0){ select(idx); play(); }
  }
}, { passive:false });

document.addEventListener('change',(e)=>{ if (e.target && e.target.id==='sort'){ applyFilterSort(false,true); keepMenuOpen(); } }, { passive:true });

$('#toggle')?.addEventListener('click', ()=>{ if (state.i<0 && state.filtered.length) select(0); state.playing?pause():play(); });
$('#prev')?.addEventListener('click', ()=> jump(-1));
$('#next')?.addEventListener('click', ()=> jump(1));

els.audio.addEventListener('timeupdate', ()=>{ const a=els.audio; if(!isFinite(a.duration)) return; els.seek.max=Math.floor(a.duration); els.seek.value=Math.floor(a.currentTime); $('#tcur').textContent=fmtDur(a.currentTime); $('#tdur').textContent=isFinite(a.duration)?fmtDur(a.duration):'0:00'; });
els.seek.addEventListener('input', ()=>{ els.audio.currentTime=Number(els.seek.value); });
els.vol.addEventListener('input', ()=>{ els.audio.volume=parseFloat(els.vol.value); localStorage.setItem('vvip25:vol', els.vol.value); });
els.audio.addEventListener('ended', ()=> jump(1));

/* === PATCH: Version Pill + Extras Drawer (VVIP25, Oct 2025) === */
async function fetchExtras(){
  try {
    const r = await fetch(`/extras.json?v=${ASSET_VERSION}`, { cache: 'no-store' });
    if(!r.ok) return;
    const json = await r.json();
    state.extras = json;
  } catch(err){
    console.warn('extras.json not found', err);
    state.extras = {};
  }
}
(async()=>{ try{ await fetchExtras(); }catch(_){} })();

const oldBadgeHTML = badgeHTML;
badgeHTML = function(t){
  const parts=[ favHTML(t), `<a class="pill" href="${t.src}" download title="Download MP3">MP3</a>` ];
  if (state.showWavButtons)
    parts.push(`<a class="pill" href="${BASE_WAV+encodeURIComponent(t.base+'.wav')}" download title="Download Lossless">WAV</a>`);
  if (state.showMovButtons && t.video)
    parts.push(`<a class="pill" href="${t.video}" target="_blank" rel="noopener" title="Open Video">MOV</a>`);
  if (state.showMovButtons && !t.video)
    parts.push('<span class="pill muted">MOV</span>');

  // version pill
  if (t.versions && t.versions.length){
    const older = t.versions[0];
    const vnum  = older.baseLower.match(/v(\d+)$/)?.[1] || '1';
    const href  = BASE_MP3 + encodeURIComponent(older.name.toLowerCase());
    parts.push(`<a class="pill muted" href="${href}" title="Earlier version">v${vnum}</a>`);
  }

  // gem pill
  const hasExtras = state.extras && state.extras[t.baseLower];
  if (hasExtras)
    parts.push(`<button class="pill gem" data-gem="${t.baseLower}" title="Extras">üíé</button>`);

  return `<div class="badge">${parts.join('')}</div>`;
};

document.addEventListener('click', e=>{
  const gem = e.target.closest('.gem');
  if(!gem) return;
  e.preventDefault();
  const key = gem.dataset.gem;
  const files = state.extras?.[key];
  if(!files?.length) return;

  const row = gem.closest('.row');
  const existing = row.nextElementSibling;
  if (existing && existing.classList.contains('extras-drawer')){
    existing.remove();
    return;
  }

  const drawer = document.createElement('div');
  drawer.className = 'extras-drawer';
  drawer.style.cssText = `
    display:flex;flex-wrap:wrap;gap:8px;padding:8px 12px;
    background:var(--card);border-top:1px solid var(--border);
  `;
  drawer.innerHTML = files.map(f=>{
    const url = `${BASE_MP3}${encodeURIComponent(key)}/${encodeURIComponent(f)}`;
    const isImg = /\.(jpg|jpeg|png|gif|webp)$/i.test(f);
    return isImg
      ? `<a href="${url}" target="_blank"><img src="${url}" style="width:64px;height:64px;object-fit:cover;border-radius:8px"></a>`
      : `<a href="${url}" target="_blank" class="pill">${f}</a>`;
  }).join('');
  row.after(drawer);
});

/* ---------- SPA-lite Router (Shoppe only) ---------- */
(() => {
  const ROOT_SELECTOR = 'main#page-root';

  async function swapTo(url, push = true) {
    try {
      const res = await fetch(url, { credentials: 'same-origin' });
      if (!res.ok) throw new Error(res.status);
      const html = await res.text();
      const doc  = new DOMParser().parseFromString(html, 'text/html');
      const nextMain = doc.querySelector(ROOT_SELECTOR);
      const curMain  = document.querySelector(ROOT_SELECTOR);
      if (!nextMain || !curMain) return;
      curMain.replaceWith(nextMain);
      if (doc.title) document.title = doc.title;
      if (push) history.pushState(null, '', new URL(url, location.origin).pathname);
      if (nextMain?.dataset?.page === 'shoppe') loadShoppe(nextMain);
    } catch {
      location.href = url;
    }
  }

  document.addEventListener('click', e => {
    const a = e.target.closest('a[data-nav]');
    if (!a) return;
    if (a.origin !== location.origin) return;
    if (e.defaultPrevented || e.button !== 0 || e.metaKey || e.ctrlKey || e.shiftKey || e.altKey) return;
    e.preventDefault();
    if (els.menu) els.menu.open = false;
    swapTo(a.href);
  });

  window.addEventListener('popstate', () => swapTo(location.href, false));
})();

/* Shoppe loader */
async function loadShoppe(rootEl){
  const grid = rootEl.querySelector('[data-shoppe-grid]');
  if (!grid) return;
  grid.innerHTML = `<div class="shop-item"><div class="desc">Loading‚Ä¶</div></div>`;
  try {
    const res = await fetch(`/shoppe/shoppe.json?v=${ASSET_VERSION}`, { cache: 'no-store' });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const items = await res.json();
    if (!Array.isArray(items) || items.length === 0) {
      grid.innerHTML = `<div class="shop-item"><div class="desc">Nothing here yet ‚Äî check back soon.</div></div>`;
      return;
    }
    const html = items.map(it => {
      const img = it.image || it.img || '';
      const title = it.title || it.name || 'Untitled';
      const desc = it.desc || it.description || '';
      const price = (it.price != null) ? it.price : '';
      const href  = it.url || it.link || '#';
      const btn   = href === '#'
        ? `<span class="btn" aria-disabled="true">Coming soon</span>`
        : `<a class="btn" href="${href}" target="_blank" rel="noopener">Buy</a>`;
      return `
        <article class="shop-item">
          ${img ? `<img src="${img}" alt="">` : ''}
          <h3>${title}</h3>
          ${desc ? `<div class="desc">${desc}</div>` : ''}
          <div class="buy">
            <span class="price">${price ? `$${price}` : ''}</span>
            ${btn}
          </div>
        </article>
      `;
    }).join('');
    grid.innerHTML = html;
  } catch (err) {
    grid.innerHTML = `<div class="shop-item"><div class="desc">Failed to load shop items.</div></div>`;
    console.error('Shoppe load error:', err);
  }
}
</script>
</body>
</html>