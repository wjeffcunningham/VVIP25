<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VVIP25</title>
  <link rel="icon" type="image/png" sizes="64x64" href="/favicon-64.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon-192.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" href="/favicon.ico?v=3">
  <meta name="theme-color" content="#0b0b0c" />
  <style>
    :root{--bg:#0b0b0c;--fg:#eceff4;--muted:#9aa0a6;--card:#141416;--border:#26272b;--accent:#6ee7b7}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 -apple-system,BlinkMacSystemFont,"Helvetica Neue",Helvetica,Arial,"Segoe UI",Roboto,Inter,system-ui,sans-serif}
    .wrap{max-width:920px;margin:0 auto;padding:16px}

    header{display:flex;align-items:center;justify-content:space-between;gap:12px;position:relative}
    #site-title{margin:0;font-size:56px;font-weight:bold;font-family:"Helvetica Neue",Helvetica,Arial,sans-serif;color:transparent;-webkit-text-fill-color:transparent;-webkit-text-stroke:2px #fdf6d0}

    .player{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(11,11,12,.97),rgba(11,11,12,.92));backdrop-filter:saturate(120%) blur(8px);border-bottom:1px solid var(--border)}
    .now{display:grid;grid-template-columns:auto 1fr auto;gap:12px;align-items:center;padding:12px 0}
    .cover{width:56px;height:56px;border-radius:8px;background:#1e1f24;display:grid;place-items:center;color:var(--muted);font-weight:700;border:1px solid var(--border)}
    .meta{min-width:0}
    .title{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .sub{color:var(--muted);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .controls{display:flex;align-items:center;gap:8px}
    button{appearance:none;background:var(--card);color:var(--fg);border:1px solid var(--border);border-radius:10px;padding:8px 12px;cursor:pointer}
    button:disabled{opacity:.55;cursor:not-allowed}
    .range{display:flex;align-items:center;gap:8px}
    input[type="range"]{width:160px}
    .list{margin:12px 0 40px;border:1px solid var(--border);border-radius:14px;overflow:hidden}
    .row{display:grid;grid-template-columns:56px 1fr auto;gap:12px;align-items:center;padding:10px 12px;border-top:1px solid var(--border);background:var(--card);min-height:78px}
    .row:first-child{border-top:0}
    .row:hover{background:#17171b}
    .badge{display:flex;gap:10px;align-items:center;font-size:12px;justify-self:end}
    .badge a{color:var(--fg);text-decoration:none;border:1px solid var(--border);padding:4px 8px;border-radius:8px}
    .badge .muted{color:var(--muted)}
    .kbd{font:12px/1.2 ui-monospace,Menlo,Consolas;background:#1b1c20;border:1px solid #2a2b30;border-radius:6px;padding:2px 6px;color:#d7dae0}

    /* Toolbar + toggles */
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    select{background:var(--card);color:var(--fg);border:1px solid var(--border);border-radius:10px;padding:8px 10px}
    .tog,.btn{
      display:inline-flex;align-items:center;justify-content:center;
      height:36px;min-width:36px;padding:0 10px;
      border-radius:10px;border:1px solid var(--border);background:var(--card);
      text-decoration:none;color:var(--fg);line-height:1
    }
    .tog{opacity:.6;transition:opacity .15s, box-shadow .15s}
    .tog.on{opacity:1;box-shadow:0 0 0 2px var(--accent) inset}

    /* Hamburger (overlay) */
    details.menu{position:static}
    details.menu>summary{cursor:pointer;list-style:none;background:var(--card);border:1px solid var(--border);padding:8px 12px;border-radius:10px;user-select:none}
    .sheet{position:absolute;top:calc(100% + 8px);right:0;z-index:20;width:min(420px,calc(100vw - 32px));background:var(--card);border:1px solid var(--border);border-radius:10px;padding:10px;display:none;box-shadow:0 10px 24px rgba(0,0,0,.35)}
    details.menu[open]>.sheet{display:block}
    details.menu[open]>summary{border-bottom-left-radius:10px;border-bottom-right-radius:10px}

    /* Hide the volume control on iOS Safari */
    @supports (-webkit-touch-callout:none){.range[title="Volume"]{display:none !important}}

    @media (max-width:560px){
      .now{grid-template-columns:1fr;gap:8px}
      .cover{display:none}
      .controls{flex-wrap:wrap}
      .range input[type="range"]{width:120px}
      .row{grid-template-columns:1fr auto}
    }
  </style>
</head>
<body>
  <div class="player">
    <div class="wrap">
      <header>
        <h1 id="site-title">VVIP25</h1>
        <details class="menu" id="menu">
          <summary>â˜° Menu</summary>
          <div class="sheet">
            <div class="toolbar" id="toolbar">
              <select id="sort" title="Sort">
                <option value="date_desc">Newest</option>
                <option value="date_asc">Oldest</option>
                <option value="bpm_desc">BPM â†“</option>
                <option value="bpm_asc">BPM â†‘</option>
                <option value="len_desc">Longest</option>
                <option value="len_asc">Shortest</option>
              </select>
              <button class="tog on" id="togTitles" title="Song Titles (on/off)">ğŸ“</button>
              <button class="tog" id="togWav" title="Show WAV buttons">ğŸšï¸</button>
              <button class="tog" id="togMov" title="Show MOV buttons">ğŸ¬</button>
              <button class="btn" id="btnAbout" title="About">â„¹ï¸</button>
              <a class="btn" id="btnShop" href="/shop" target="_blank" rel="noopener" title="Shop">ğŸ›ï¸</a>
            </div>
          </div>
        </details>
      </header>

      <div class="now">
        <div class="cover" id="cover">V25</div>
        <div class="meta">
          <div class="title" id="now-title">â€”</div>
          <div class="sub" id="now-sub">Ready</div>
        </div>
        <div class="controls">
          <button id="prev" aria-label="Previous">â®ï¸</button>
          <button id="toggle" aria-label="Play/Pause">â–¶ï¸</button>
          <button id="next" aria-label="Next">â­ï¸</button>
          <div class="range">
            <span id="tcur">0:00</span>
            <input id="seek" type="range" min="0" max="100" value="0" step="1" aria-label="Seek" />
            <span id="tdur">0:00</span>
          </div>
          <div class="range" title="Volume">
            <span>ğŸ”Š</span>
            <input id="vol" type="range" min="0" max="1" step="0.01" />
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div id="list" class="list" role="list"></div>
  </div>

  <audio id="audio" preload="metadata"></audio>

<script>
/* ========= VVIP25 â€” Stabilized baseline (no clock/download/enhance) ========= */

const ASSET_VERSION = 11;

/* ---------- Config ---------- */
const BASE_MP3   = 'https://media.vvipmedia.net/ACCESS/';
const BASE_WAV   = 'https://media.vvipmedia.net/WAV/';
const BASE_THUMB = 'https://media.vvipmedia.net/ACCESS/';
const BASE_VIDEO = 'https://media.vvipmedia.net/VIDEOS/';
const DEFAULT_THUMB = BASE_THUMB + 'default_thumb.jpg';

/* ---------- Helpers ---------- */
const $ = sel => document.querySelector(sel);
function fmtDur(sec){ sec=Number(sec||0); const m=Math.floor(sec/60), s=Math.floor(sec%60); return `${m}:${String(s).padStart(2,'0')}`; }
function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); } }
function escapeHTML(s){ return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
const rawFile=s=>(String(s).split('/').pop()||'');
const stripExt=s=>String(s).replace(/\.[a-z0-9]+$/i,'');
function softNorm(s){ return stripExt(s).toLowerCase().replace(/[ _]+/g,'-').replace(/-+/g,'-'); }
function bpmLabel(t){ if(t.bpm!=null) return `${t.bpm} BPM`; if(t.bpm_min!=null&&t.bpm_max!=null) return `${t.bpm_min}â€“${t.bpm_max} BPM`; return ''; }

/* ---------- Elements ---------- */
const els = {
  audio:$('#audio'), list:$('#list'),
  sort:$('#sort'), toggle:$('#toggle'), prev:$('#prev'), next:$('#next'),
  seek:$('#seek'), vol:$('#vol'),
  nowTitle:$('#now-title'), nowSub:$('#now-sub'), tcur:$('#tcur'), tdur:$('#tdur'), cover:$('#cover'),
  menu:$('#menu'), toolbar:$('#toolbar')
};

/* ---------- State ---------- */
const state = {
  tracks:[], filtered:[], i:-1, playing:false,
  pageSize:60, renderCount:0,
  showTitles:false, showWavButtons:false, showMovButtons:false,
  favorites:new Set(JSON.parse(localStorage.getItem('vvip25:favs')||'[]')),
  favOrder: JSON.parse(localStorage.getItem('vvip25:favOrder')||'[]'),
  searchQuery:''
};

/* ---------- Minimal CSS patches (safe) ---------- */
(function injectCSS(){
  const css = `
  .btn,.tog{display:inline-flex;align-items:center;justify-content:center;height:36px;min-width:36px;padding:0 12px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--fg);text-decoration:none;line-height:1;cursor:pointer}
  .tog{opacity:.7;transition:opacity .15s, box-shadow .15s}
  .tog.on{opacity:1;box-shadow:0 0 0 2px var(--accent) inset}
  .panel{display:none;margin-top:8px;border:1px solid var(--border);border-radius:10px;padding:8px}
  .row{min-height:78px}
  .pill{border:1px solid var(--border);border-radius:999px;padding:4px 10px;font-size:12px;text-decoration:none;color:var(--fg)}
  .star{cursor:pointer}
  .star.on{filter:drop-shadow(0 0 2px var(--accent)) brightness(1.2)}
  `;
  const s=document.createElement('style'); s.textContent=css; document.head.appendChild(s);
})();

/* ---------- Boot ---------- */
init().catch(err=>console.error('init failed:', err));
async function init(){
  wirePlayer();
  buildMenu();   // simple, stable menu

  // volume
  els.vol.value = localStorage.getItem('vvip25:vol') ?? '0.9';
  els.audio.volume = parseFloat(els.vol.value);

  const res = await fetch(`./manifest.json?v=${ASSET_VERSION}`, {cache:'no-store'});
  if(!res.ok){ els.list.innerHTML = `<div class="row"><div></div><div>manifest.json missing</div></div>`; return; }
  const data = await res.json();

  // shape into track objects
  state.tracks = data.map((t,idx)=>{
    const name = t.name || t.file || rawFile(t.src||'track-'+idx+'.mp3');
    const base = stripExt(name);
    const hasDateTitle = typeof t.title === 'string' && /^\d{4}-\d{2}-\d{2}\b/.test(t.title); // treat date-only titles as "nameless"
    return {
      id:idx,
      name, base,
      title: t.title || '',
      bpm: t.bpm ?? null, bpm_min: t.bpm_min ?? null, bpm_max: t.bpm_max ?? null,
      details: t.details || '', length: t.length || 0,
      src: t.src || (BASE_MP3 + encodeURIComponent(name)),
      wav: BASE_WAV + encodeURIComponent(base + '.wav'),
      video: t.has_mov ? (BASE_VIDEO + encodeURIComponent(base + '.mov')) : null,
      hasDateTitle
    };
  });

  applyFilterSort(true);
  renderList();
  if (state.filtered.length && state.i === -1) select(0);
}

/* ---------- Filtering/Sorting ---------- */
function matchesSearch(t, tokens){
  if (!tokens.length) return true;
  const hay = (t.name + ' ' + (t.title||'') + ' ' + (t.details||'')).toLowerCase();
  return tokens.every(tok => hay.includes(tok));
}
function applyFilterSort(firstPaint=false){
  const tokens = state.searchQuery.trim().toLowerCase().split(/\s+/).filter(Boolean);
  let out = [...state.tracks];

  // favorites view
  const favMode = tokens.includes('#favorites');
  if (favMode) out = out.filter(t=>state.favorites.has(t.name));

  // when titles are ON, hide â€œdate-only titleâ€ tracks
  if (state.showTitles) out = out.filter(t=>!t.hasDateTitle);

  // remove special token and apply text search
  const pureTokens = tokens.filter(t=>t!=='#favorites');
  out = out.filter(t=>matchesSearch(t, pureTokens));

  // ordering
  switch(els.sort?.value||'date_desc'){
    case 'bpm_desc': out.sort((a,b)=>((b.bpm??(b.bpm_min+b.bpm_max)/2||0)- (a.bpm??(a.bpm_min+a.bpm_max)/2||0))); break;
    case 'bpm_asc':  out.sort((a,b)=>((a.bpm??(a.bpm_min+a.bpm_max)/2||0)- (b.bpm??(b.bpm_min+b.bpm_max)/2||0))); break;
    case 'len_desc': out.sort((a,b)=> (b.length||0)-(a.length||0)); break;
    case 'len_asc':  out.sort((a,b)=> (a.length||0)-(b.length||0)); break;
    default: // newest first based on filename (works for your date style)
      out.sort((a,b)=> b.name.localeCompare(a.name));
  }

  state.filtered = out;
  state.renderCount = Math.min(out.length, firstPaint ? 60 : state.renderCount || 60);
}

/* ---------- Render ---------- */
function imgHTML(src){
  const esc = s => s.replace(/"/g,'&quot;');
  return `<img src="${esc(src)}" alt="" loading="lazy" style="width:56px;height:56px;border-radius:8px;object-fit:cover;" onerror="if(this.dataset.fbk!=='1'){this.dataset.fbk='1';this.onerror=null;this.src='${DEFAULT_THUMB}';}">`;
}
function favHTML(t){
  const on = state.favorites.has(t.name) ? 'on' : '';
  const title = on ? 'Remove from favorites' : 'Add to favorites';
  return `<button class="star ${on}" data-fav="${escapeHTML(t.name)}" title="${title}">â˜…</button>`;
}
function badgeHTML(t){
  const bits = [favHTML(t), `<a class="pill" href="${t.src}" download>MP3</a>`];
  if (state.showWavButtons) bits.push(`<a class="pill" href="${BASE_WAV + encodeURIComponent(t.base + '.wav')}" download>WAV</a>`);
  if (state.showMovButtons && t.video) bits.push(`<a class="pill" href="${t.video}" target="_blank" rel="noopener">MOV</a>`);
  if (state.showMovButtons && !t.video) bits.push(`<span class="pill" style="opacity:.5">MOV</span>`);
  return `<div class="badge">${bits.join(' ')}</div>`;
}
function rowHTML(t, active){
  const sub = [ bpmLabel(t), t.length?fmtDur(t.length):'', t.details||'' ].filter(Boolean).join(' Â· ');
  return `<div class="row" role="listitem" data-id="${t.id}">
    <div class="cover" aria-hidden="true">${imgHTML(DEFAULT_THUMB)}</div>
    <div>
      <div class="title">${active?'â–¶ï¸ ':''}${escapeHTML(state.showTitles && !t.hasDateTitle && t.title ? t.title : t.name)}</div>
      <div class="sub">${escapeHTML(sub)}</div>
    </div>
    ${badgeHTML(t)}
  </div>`;
}
function renderList(){
  const slice = state.filtered.slice(0, state.renderCount);
  if (!slice.length){ els.list.innerHTML = '<div class="row"><div></div><div>No results.</div></div>'; return; }
  els.list.innerHTML = slice.map(t=>rowHTML(t,(state.i>=0 && state.filtered[state.i]?.id===t.id))).join('');
}

/* ---------- Selection / Player ---------- */
function select(idx){
  state.i = idx;
  const t = state.filtered[idx]; if (!t) return;
  els.audio.src = t.src;
  els.nowTitle.textContent = (state.showTitles && !t.hasDateTitle && t.title) ? t.title : t.name;
  els.nowSub.textContent = [bpmLabel(t), t.length?fmtDur(t.length):'', t.details||''].filter(Boolean).join(' Â· ');
  els.cover.innerHTML = imgHTML(DEFAULT_THUMB);
  state.playing = false; updateToggle();
  // update active chevron + star state
  document.querySelectorAll('.row').forEach(row=>{
    const id = Number(row.getAttribute('data-id'));
    const title = row.querySelector('.title');
    const tt = state.filtered.find(x=>x.id===id);
    const active = id === t.id;
    if (title) title.innerHTML = (active?'â–¶ï¸ ':'') + escapeHTML(state.showTitles && tt && !tt.hasDateTitle && tt.title ? tt.title : (tt?tt.name:'' ));
    const favBtn=row.querySelector('.star[data-fav]'); if (favBtn){ const key=favBtn.getAttribute('data-fav'); favBtn.classList.toggle('on', state.favorites.has(key)); }
  });
}
async function play(){ try{ await els.audio.play(); state.playing=true; updateToggle(); }catch(_){ /* ignore */ } }
function pause(){ els.audio.pause(); state.playing=false; updateToggle(); }
function updateToggle(){ const btn=$('#toggle'); if (btn) btn.textContent = state.playing ? 'â¸ï¸' : 'â–¶ï¸'; }
function jump(d){ if(!state.filtered.length) return; let i = state.i + d; if(i<0) i=state.filtered.length-1; if(i>=state.filtered.length) i=0; select(i); play(); }

/* ---------- Menu (simple & robust) ---------- */
function buildMenu(){
  const tb = els.toolbar; if (!tb) return; tb.innerHTML='';
  const row = document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; row.style.flexWrap='wrap'; row.style.alignItems='center'; tb.appendChild(row);

  // ğŸ“œ About
  const btnAbout = document.createElement('button'); btnAbout.className='btn'; btnAbout.title='About'; btnAbout.textContent='ğŸ“œ';
  btnAbout.onclick = e=>{ e.preventDefault(); e.stopPropagation(); alert("VVIP25 â€” Vancouver Music and Videography Project 2025"); keepMenuOpen(e); };
  row.appendChild(btnAbout);

  // ğŸµ Favorites playlist
  const btnFav = document.createElement('button'); btnFav.className='btn'; btnFav.title='My favorites'; btnFav.textContent='ğŸµ';
  btnFav.onclick = e=>{ e.preventDefault(); e.stopPropagation(); state.searchQuery='#favorites'; applyFilterSort(); renderList(); keepMenuOpen(e); };
  row.appendChild(btnFav);

  // ğŸ› ï¸ Utilities (toggles live here)
  const btnUtil = document.createElement('button'); btnUtil.className='btn'; btnUtil.title='Utilities'; btnUtil.textContent='ğŸ› ï¸';
  row.appendChild(btnUtil);

  // ğŸ”— Links
  const btnLinks = document.createElement('button'); btnLinks.className='btn'; btnLinks.title='Links'; btnLinks.textContent='ğŸ”—';
  row.appendChild(btnLinks);

  // ğŸ›ï¸ Shop
  const aShop = document.createElement('a'); aShop.className='btn'; aShop.title='Shop'; aShop.textContent='ğŸ›ï¸'; aShop.href='/shop'; aShop.target='_blank'; aShop.rel='noopener';
  row.appendChild(aShop);

  // Sort
  const sel = document.createElement('select'); sel.id='sort'; sel.title='Sort';
  sel.innerHTML = `<option value="date_desc">Newest</option><option value="date_asc">Oldest</option><option value="bpm_desc">BPM â†“</option><option value="bpm_asc">BPM â†‘</option><option value="len_desc">Longest</option><option value="len_asc">Shortest</option>`;
  row.appendChild(sel); els.sort = sel;

  // ğŸ” Search
  const btnSearch=document.createElement('button'); btnSearch.className='btn'; btnSearch.title='Search'; btnSearch.textContent='ğŸ”'; row.appendChild(btnSearch);
  const searchPanel=document.createElement('div'); searchPanel.className='panel'; searchPanel.innerHTML=`<input id="searchInput" placeholder="Searchâ€¦ (#favorites or text)" inputmode="search" style="width:100%;background:var(--card);color:var(--fg);border:1px solid var(--border);border-radius:10px;padding:8px 10px">`;
  tb.appendChild(searchPanel);
  const searchInput=searchPanel.querySelector('#searchInput');
  btnSearch.onclick = e=>{ e.preventDefault(); e.stopPropagation(); searchPanel.style.display = (searchPanel.style.display==='block'?'none':'block'); if (searchPanel.style.display==='block'){ searchInput.value = state.searchQuery; searchInput.focus(); } keepMenuOpen(e); };
  searchInput.addEventListener('input', debounce(()=>{ state.searchQuery = searchInput.value||''; applyFilterSort(); renderList(); }, 150));

  // Utilities panel
  const util=document.createElement('div'); util.className='panel';
  util.innerHTML = `<div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
    <button class="tog" id="togTitles" title="Titles ON hides date-only">ğŸ“</button>
    <button class="tog" id="togWav" title="Show WAV buttons">ğŸšï¸</button>
    <button class="tog" id="togMov" title="Show MOV buttons">ğŸ¬</button>
  </div>`;
  tb.appendChild(util);

  btnUtil.onclick = e=>{ e.preventDefault(); e.stopPropagation(); util.style.display = (util.style.display==='block'?'none':'block'); keepMenuOpen(e); };

  // Links panel
  const links=document.createElement('div'); links.className='panel';
  links.innerHTML = `<div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
    <a class="btn" href="https://www.youtube.com/@VVVVIIPP25" target="_blank" rel="noopener" title="YouTube">ğŸ“º</a>
    <a class="btn" href="https://virtualvip.bandcamp.com/" target="_blank" rel="noopener" title="Bandcamp">ğŸ§</a>
    <a class="btn" href="https://substack.com/home/post/p-170664918?source=queue" target="_blank" rel="noopener" title="Newsletter">ğŸ“°</a>
    <a class="btn" href="https://www.instagram.com/virtualvip24/" target="_blank" rel="noopener" title="Instagram">ğŸ“·</a>
  </div>`;
  tb.appendChild(links);
  btnLinks.onclick = e=>{ e.preventDefault(); e.stopPropagation(); links.style.display = (links.style.display==='block'?'none':'block'); keepMenuOpen(e); };

  // Toggle wiring
  const tTitles=util.querySelector('#togTitles');
  const tWav=util.querySelector('#togWav');
  const tMov=util.querySelector('#togMov');
  function sync(){ tTitles.classList.toggle('on',state.showTitles); tWav.classList.toggle('on',state.showWavButtons); tMov.classList.toggle('on',state.showMovButtons); }
  sync();
  tTitles.onclick = e=>{ e.preventDefault(); e.stopPropagation(); state.showTitles=!state.showTitles; applyFilterSort(); renderList(); sync(); keepMenuOpen(e); };
  tWav.onclick    = e=>{ e.preventDefault(); e.stopPropagation(); state.showWavButtons=!state.showWavButtons; renderList(); sync(); keepMenuOpen(e); };
  tMov.onclick    = e=>{ e.preventDefault(); e.stopPropagation(); state.showMovButtons=!state.showMovButtons; renderList(); sync(); keepMenuOpen(e); };

  // sort change
  sel.addEventListener('change', e=>{ applyFilterSort(); renderList(); keepMenuOpen(e); });

  // keep overlay open while clicking inside
  tb.addEventListener('click', keepMenuOpen);
}

function keepMenuOpen(e){ const menu=els.menu; if(!menu) return; if (e){ e.preventDefault?.(); e.stopPropagation?.(); } menu.open = true; }

/* ---------- Player wiring ---------- */
function wirePlayer(){
  $('#toggle')?.addEventListener('click', ()=>{ if (state.i<0 && state.filtered.length) select(0); state.playing?pause():play(); });
  els.prev?.addEventListener('click', ()=> jump(-1));
  els.next?.addEventListener('click', ()=> jump(1));

  els.audio.addEventListener('timeupdate', ()=>{
    const a=els.audio; if(!isFinite(a.duration)) return;
    els.seek.max=Math.floor(a.duration);
    els.seek.value=Math.floor(a.currentTime);
    els.tcur.textContent = fmtDur(a.currentTime);
    els.tdur.textContent = isFinite(a.duration) ? fmtDur(a.duration) : '0:00';
  });
  els.seek.addEventListener('input', ()=>{ els.audio.currentTime = Number(els.seek.value); });
  els.vol.addEventListener('input', ()=>{ els.audio.volume = parseFloat(els.vol.value); localStorage.setItem('vvip25:vol', els.vol.value); });

  // clicks: row select + favorites
  document.addEventListener('click',(e)=>{
    const favBtn=e.target.closest?.('.star');
    if (favBtn && favBtn.hasAttribute('data-fav')){
      const key=favBtn.getAttribute('data-fav'); const was=state.favorites.has(key);
      if (was){ state.favorites.delete(key); state.favOrder=state.favOrder.filter(n=>n!==key); }
      else { state.favorites.add(key); if(!state.favOrder.includes(key)) state.favOrder.push(key); }
      localStorage.setItem('vvip25:favs', JSON.stringify(Array.from(state.favorites)));
      localStorage.setItem('vvip25:favOrder', JSON.stringify(state.favOrder));
      favBtn.classList.toggle('on', !was);
      e.preventDefault(); e.stopPropagation(); return;
    }
    const row=e.target.closest?.('.row');
    if (row && !e.target.closest('a')){
      const id=Number(row.getAttribute('data-id'));
      const idx=state.filtered.findIndex(t=>t.id===id);
      if (idx>=0){ select(idx); play(); }
    }
  }, { passive:false });

  els.audio.addEventListener('ended', ()=> jump(1));
}
</script>
</body>
</html>