<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VVIP25</title>
  <link rel="icon" type="image/png" sizes="64x64" href="/favicon-64.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon-192.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" href="/favicon.ico?v=3">
  <meta name="theme-color" content="#0b0b0c"/>
<style>
  :root {
    --bg:#0b0b0c;
    --fg:#eceff4;
    --muted:#9aa0a6;
    --card:#141416;
    --border:#26272b;
    --accent:#6ee7b7;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:var(--bg);
    color:var(--fg);
    font:16px/1.5 -apple-system,BlinkMacSystemFont,"Helvetica Neue",Helvetica,Arial,"Segoe UI",Roboto,Inter,system-ui,sans-serif;
  }
  html{-webkit-text-size-adjust:100%}
  input,select,button{font-size:16px}
  .wrap{max-width:920px;margin:0 auto;padding:16px}

  header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    position:relative;
  }

  /* --- Site Title --- */
  #site-title{
    margin:0;
    font-size:68px;
    letter-spacing:.06em;
    font-weight:800;
    font-family:"Helvetica Neue",Helvetica,Arial,sans-serif;
    color:transparent;
    -webkit-text-fill-color:transparent;
    -webkit-text-stroke:2.25px #fdf6d0;
  }

  /* --- Player Core --- */
.player {
  position: relative;
  z-index: 10;
  background: var(--bg);
  border-bottom: none;
}
  /* --- Now Playing --- */
  .now{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:14px;
    padding:20px 0 28px;
    border-bottom: none !important;
  }

.cover {
  width: 520px;
  height: 520px;
  border-radius: 18px;
  position: relative;
  display: grid;
  place-items: center;
  overflow: visible;             /* stop Safari’s halo-causing mask blend */
  background: #000;
  border: none;
  box-shadow: none;
  outline: none;
  isolation: isolate;
  backface-visibility: hidden;
  -webkit-transform: translateZ(0);
  mask-image: radial-gradient(circle at center, #000 99.8%, transparent 100%);
  -webkit-mask-image: radial-gradient(circle at center, #000 99.8%, transparent 100%);
}

.now .cover img {
  position: absolute;
  top: 0; left: 0;
  width: 100.5%;
  height: 100.5%;
  border-radius: 18px;           /* reapply the curve directly to the image */
  object-fit: cover;
  background: #000;
  border: none;
  outline: none;
  transform: scale(1.001);
  backface-visibility: hidden;
}
  /* --- Desktop Now Playing Title --- */
  #now-title{
    font-family:"Helvetica Neue",Helvetica,Arial,sans-serif;
    font-size:68px;
    font-weight:800;
    letter-spacing:.06em;
    color:#fdf6d0;
    text-align:center;
    line-height:1.1;
    margin:0;
  }

  /* --- Sub Info: clean, no dots --- */
  #now-sub{
    color:var(--muted);
    font-size:14px;
    letter-spacing:.03em;
  }

  /* --- Controls --- */
  .controls{
    display:flex;
    justify-content:center;
    gap:18px;
    padding:10px 0 0;
  }
  .controls button svg{
    width:32px;
    height:32px;
    fill:#fdf6d0;
  }
  .range,[title="Volume"]{
    display:none!important;
  }

  /* --- Buttons --- */
  button{
    appearance:none;
    background:var(--card);
    color:var(--fg);
    border:1px solid var(--border);
    border-radius:10px;
    padding:8px 12px;
    cursor:pointer;
  }
  button:disabled{opacity:.55;cursor:not-allowed}

  /* Hide times + subtext under title */
#now-sub { display:none !important; }
.range, [title="Volume"], #tcur, #tdur { display:none !important; }

  /* --- List + Rows --- */
  .list{
    margin:0;
    border:none;
    border-top: 1px solid rgba(255,255,255,0.05);
  box-shadow: 0 -12px 20px rgba(0,0,0,0.3);
    border-radius:0;
    background:var(--bg);
  }

  .row{
    display:grid;
    grid-template-columns:80px 1fr auto;
    gap:14px;
    align-items:center;
    padding:12px 14px;
    border-top:1px solid var(--border);
    background:var(--card);
    min-height:90px;
  }
  .row:first-child{border-top:0}
  .row:hover{background:#17171b}
  .row img{
    width:80px;
    height:80px;
    border-radius:10px;
    object-fit:cover;
  }

  .badge{
    display:flex;
    gap:10px;
    align-items:center;
    font-size:12px;
    justify-self:end;
  }
  .badge a{
    color:var(--fg);
    text-decoration:none;
    border:1px solid var(--border);
    padding:4px 8px;
    border-radius:8px;
  }
  .badge .muted{color:var(--muted)}

  /* Force uniform right-alignment for star button */
.row .badge {
  justify-content: flex-end;
  min-width: 48px;
}

/* Keep the star perfectly aligned at the same spot even when formats hidden */
.row .badge .star {
  width: 32px;
  height: 32px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
  margin-left: auto;
}

/* --- Title row with time beside track title --- */
.title-row {
  display: flex;
  align-items: baseline;
  justify-content: space-between;
  gap: 12px;
  width: 100%;
}

#now-time {
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  font-size: 32px;
  font-weight: 700;
  color: #fdf6d0;
  opacity: 0.9;
  min-width: 72px;
  text-align: right;
}

/* --- Scrub / seek bar under track title --- */
#scrub {
  width: 100%;
  margin-top: 8px;
  -webkit-appearance: none;
  height: 6px;
  background: #1a1a1c;
  border-radius: 3px;
  outline: none;
}
#scrub::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 14px;
  height: 14px;
  border-radius: 50%;
  background: #fdf6d0;
  cursor: pointer;
}
#scrub::-moz-range-thumb {
  width: 14px;
  height: 14px;
  border-radius: 50%;
  background: #fdf6d0;
  cursor: pointer;
}

/* --- Responsive: on narrow screens, stack time below title --- */
@media (max-width:560px){
  .title-row {
    flex-direction: column;
    align-items: flex-start;
    gap: 4px;
  }
  #now-time {
    font-size: 20px;
    text-align: left;
    opacity: 0.8;
  }
}

  /* --- Toolbar / Menu --- */
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  select{
    background:var(--card);
    color:var(--fg);
    border:1px solid var(--border);
    border-radius:10px;
    padding:8px 10px;
  }

  .tog,.btn{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    height:36px;
    min-width:36px;
    padding:0 10px;
    border-radius:10px;
    border:1px solid var(--border);
    background:var(--card);
    color:var(--fg);
    text-decoration:none;
    line-height:1;
  }
  .tog{opacity:.6;transition:opacity .15s,box-shadow .15s}
  .tog.on{opacity:1;box-shadow:0 0 0 2px var(--accent) inset}
.gearwrap {
  position: relative;
}

#gearBtn.btn {
  width: 40px;
  height: 40px;
  padding: 0;
  border-radius: 10px;
  display: inline-grid;
  place-items: center;
}

#gearBtn svg path {
  stroke: #fdf6d0;
  stroke-width: 2.2;
  fill: none;
  stroke-linecap: round;
  stroke-linejoin: round;
}

/* --- Menu Sheet --- */
.gearwrap .sheet {
  position: absolute;
  top: calc(100% + 8px);
  left: 50%;
  transform: translateX(-50%);
  z-index: 20;
  width: auto;
  min-width: 260px;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 12px 10px;
  display: none;
  box-shadow: 0 10px 24px rgba(0, 0, 0, 0.35);
}

.gearwrap.open .sheet {
  display: block;
}

/* --- Toolbar: packed flex grid (desktop default) --- */
.toolbar {
  display: flex !important;
  flex-wrap: wrap;
  justify-content: center;
  align-items: center;
  gap: 8px 24px; /* row, column */
  padding: 6px 0;
}

/* --- Each icon --- */
.toolbar .btn.icon {
  width: 44px;
  height: 44px;
  padding: 0;
  display: grid;
  place-items: center;
  border-radius: 10px;
  background: var(--card);
  border: 1px solid var(--border);
  transition: background 0.2s, transform 0.2s;
}
.toolbar .btn.icon:hover {
  background: #1b1c20;
  transform: translateY(-2px);
}

.toolbar .btn.icon svg,
.toolbar .btn.icon {
  font-size: 30px !important;
  line-height: 1;
}

/* --- Responsive: fix mobile layout and spacing --- */
@media (max-width:560px){
  .gearwrap .sheet {
    right: 0;
    left: auto;
    transform: none;
    padding: 10px;
    min-width: 200px;
  }

  .toolbar {
    display: grid !important;
    grid-template-columns: repeat(3, 1fr);
    gap: 14px;
    justify-items: center;
    align-items: center;
    padding: 8px 0;
  }

  .toolbar .btn.icon {
    width: 48px;
    height: 48px;
    font-size: 28px;
    border-radius: 12px;
  }
}

/* --- Hide sort select by default; show only when + toggled --- */
.toolbar select#sort {
  display: none;
}
.toolbar.show-sort select#sort {
  display: inline-block;
}

/* --- Star buttons --- */
.star {
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
  color: var(--muted);
  background: transparent;
  border: none;
  border-radius: 10px;
  filter: none !important;
  box-shadow: none !important;
  backface-visibility: hidden;
  -webkit-transform: translateZ(0);
  will-change: filter, color;
  transition: filter 0.25s ease, color 0.25s ease, background 0.25s ease;
}

/* 1) Make sure containers don't clip the glow */
.row, .row .right, .row .badge { overflow: visible; }

/* 2) Star: base */
.star{
  position: relative;                 /* anchor pseudo-element */
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 32px; height: 32px;
  border: none; border-radius: 10px;
  background: var(--card);
  color: var(--muted);
  transition: color .25s ease, opacity .25s ease;
  /* no filter/box-shadow here to avoid GPU ghosting */
}

/* 3) Star glow rendered on a larger pseudo-element (no clipping) */
.star.on::after{
  content: "";
  position: absolute;
  /* expand beyond the button so the blur never hits the edge */
  inset: -8px;                         /* <-- increase if you want a bigger halo */
  border-radius: 14px;
  pointer-events: none;
  /* soft, stable halo using box-shadows (not filter) */
  box-shadow:
    0 0 10px rgba(110,231,183,.35),
    0 0 18px rgba(110,231,183,.25);
  opacity: 1;
  transition: opacity .25s ease;
}

.star.on{
  color: #fdf6d0;
}

/* cleanly fade the halo out on toggle-off */
.star:not(.on)::after{ opacity: 0; }

/* optional: during quick clicks, ensure no partial frames stick */
.star:active::after{ opacity: 0; }


/* --- Illuminated "+" button when toggled --- */
.btn.on {
  color: #fdf6d0;
  border-color: var(--accent);
  filter: drop-shadow(0 0 2px var(--accent)) brightness(1.2);
  background: rgba(110, 231, 183, 0.08); /* faint glow backdrop */
  transition: all 0.25s ease;
  will-change: filter, background;
}

/* --- Reset glow after illumination turns off --- */
.btn {
  transition: all 0.25s ease;
  filter: none !important;
  box-shadow: none !important;
  background: var(--card) !important;
  backface-visibility: hidden;
  -webkit-transform: translateZ(0); /* clears any GPU ghosting */
}


  /* --- Favbar (hidden by default) --- */
  .favbar{display:none;}
  body.show-search .favbar{
    display:flex;
    gap:8px;
    align-items:center;
    padding:12px 14px;
    background:var(--bg);
    border-bottom:1px solid var(--border);
  }
  .favbar input[type="search"]{
    flex:1;
    background:#141416;
    border:1px solid var(--border);
    border-radius:8px;
    color:var(--fg);
    padding:6px 10px;
    font-size:15px;
  }

  /* --- Version Buttons --- */
  .version-buttons{
    display:inline-flex;
    gap:.25em;
    margin-right:.5em;
    vertical-align:middle;
  }
  .version-button{
    background:transparent;
    border:1px solid #999;
    border-radius:4px;
    font-size:.75em;
    padding:0 .3em;
    cursor:pointer;
    color:#555;
    transition:all .2s;
  }
  .version-button:hover{
    border-color:var(--accent,#000);
    color:var(--accent,#000);
  }
  .version-button.active{
    background:var(--accent,#000);
    color:#fff;
    border-color:var(--accent,#000);
  }

  /* === RESPONSIVE: MOBILE + DESKTOP COMBINED === */

/* --- Mobile layout, title overlay, shimmer, stacked badges --- */
@media (max-width:560px){
  /* Core layout tweaks */
  #site-title{
    font-size:48px;
    -webkit-text-stroke:1.8px #fdf6d0;
    letter-spacing:.08em;
  }
  .wrap{padding:12px}
  .now{
    gap:12px;
    padding:12px 0;
  }
  .cover{
    width:84vw;
    max-width:520px;
    height:84vw;
    max-height:520px;
    margin:0 auto;
    border-radius:12px;
    position:relative;
  }

  /* Hide big desktop title, overlay small one on cover */
  #now-title{display:none!important;}

  .cover::after{
    content:attr(data-title);
    position:absolute;
    bottom:12px;
    left:0; right:0;
    text-align:center;
    font-family:"Helvetica Neue",Helvetica,Arial,sans-serif;
    font-weight:800;
    font-size:22px;
    color:#fdf6d0;
    text-shadow:0 0 6px rgba(0,0,0,0.4);
    opacity:.9;
    background:linear-gradient(90deg,#6ee7b7,#fdf6d0,#6ee7b7);
    background-size:200% 100%;
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
  }

  /* Shimmer when playing */
  body.playing .cover::after{
    animation:shimmerMobile 2s linear infinite;
  }

  @keyframes shimmerMobile{
    0%   {background-position:0% 50%;opacity:.9;}
    50%  {background-position:100% 50%;opacity:1;}
    100% {background-position:0% 50%;opacity:.9;}
  }

  /* Hide redundant small title & subtext */
  #now-title-mobile,
  #now-sub {display:none!important;}
  .now .meta .title{display:block;}

  /* Compact stacked badges */
  .badge {
    display:grid !important;
    grid-template-columns:repeat(2,1fr);
    gap:6px 8px;
    justify-items:center;
    align-items:center;
    width:100%;
    padding-top:4px;
  }

  .badge .pill,
  .badge .star {
    font-size:13px !important;
    padding:4px 6px !important;
    min-width:50px;
    height:auto;
    text-align:center;
    border-radius:6px;
  }

  .badge .pill.gem {
    font-size:15px !important;
  }

  .row .right {
    display:flex;
    justify-content:center;
    align-items:center;
  }
}

/* --- Desktop layout: left-aligned, large cover, shimmer title --- */
@media (min-width:561px){
  .now{
    align-items:flex-start;
    text-align:left;
  }
  .cover{
    margin:0;
    width:520px;
    height:520px;
    border-radius:18px;
  }
  #now-title{
    text-align:left;
    font-size:84px;
    margin-top:18px;
  }
  .controls{
    justify-content:flex-start;
  }

  /* Shimmer on desktop title when playing */
  body.playing #now-title {
    animation:shimmerDesktop 4s ease-in-out infinite;
  }
  @keyframes shimmerDesktop {
    0%   { text-shadow:0 0 6px rgba(253,246,208,0.2); opacity:.95; }
    25%  { text-shadow:0 0 10px rgba(110,231,183,0.4); opacity:1; }
    50%  { text-shadow:0 0 14px rgba(253,246,208,0.9); opacity:1; }
    75%  { text-shadow:0 0 10px rgba(110,231,183,0.4); opacity:1; }
    100% { text-shadow:0 0 6px rgba(253,246,208,0.2); opacity:.95; }
  }
}

/* --- FIX: Hide all mobile-only overlays and small titles on desktop --- */
@media (min-width:561px) {
  #now-title-mobile,
  .cover::after {
    display: none !important;
    content: none !important;
  }
}

</style>
</head>
<body>
  <div class="player">
    <div class="wrap">
  <header>
  <h1 id="site-title">VVIP25</h1>
  <div id="gearwrap" class="gearwrap">
    <button id="gearBtn" class="btn" aria-label="Menu">
   <svg viewBox="0 0 24 24" width="28" height="28" xmlns="http://www.w3.org/2000/svg">
  <path d="M3 6h18M3 12h18M3 18h18"
        stroke="#fdf6d0" stroke-width="2.4" stroke-linecap="round"/>
</svg>
    </button>
    <div class="sheet"><div class="toolbar" id="toolbar"></div></div>
  </div>
</header>

      <div class="now">
        <div class="cover" id="cover">V25</div>
  <div id="now-title-mobile"></div>
        <div class="meta">

<div class="meta">
  <div class="title-row">
    <div class="title" id="now-title">—</div>
    <div id="now-time">0:00</div>
  </div>
  <input type="range" id="scrub" min="0" max="100" value="0" step="0.1" aria-label="Seek bar">
  <div class="sub" id="now-sub">Ready</div>
</div>

        <div class="controls">
        <button id="prev" aria-label="Previous"></button>
<button id="toggle" aria-label="Play/Pause"></button>
<button id="next" aria-label="Next"></button>
          <div class="range">
            <span id="tcur">0:00</span>
            <input id="seek" type="range" min="0" max="100" value="0" step="1" aria-label="Seek" />
            <span id="tdur">0:00</span>
          </div>
          <div class="range" title="Volume">
            <span>🔊</span>
            <input id="vol" type="range" min="0" max="1" step="0.01" />
          </div>
        </div>
      </div>
    </div>
  </div>

  <main id="page-root" data-page="home">
    <div class="wrap">
      <div id="list" class="list" role="list"></div>
    </div>
  </main>

  <audio id="audio" preload="metadata"></audio>

<script>
/* ========= VVIPMEDIA — Core Player (Unified List) + Gear Menu ========= */

const ASSET_VERSION = 18;
const PREFERRED_TITLE = 'vic said';

/* ---------- Config ---------- */
const BASE_MP3   = 'https://cdn.vvipmedia.net/ACCESS/';
const BASE_WAV   = 'https://cdn.vvipmedia.net/WAV/';

// ✅ Local thumbs — hosted inside the repo
const BASE_THUMB = 'assets/thumbs/';
const DEFAULT_THUMB = BASE_THUMB + 'default_thumb.jpg';

const BASE_VIDEO = 'https://cdn.vvipmedia.net/VIDEOS/';
const BASE_EXTRAS= 'https://cdn.vvipmedia.net/MEDIA/extras/';

/* ---------- Helpers ---------- */
const $ = s => document.querySelector(s);
function fmtDur(sec){sec=Number(sec||0);const m=Math.floor(sec/60),s=Math.floor(sec%60);return `${m}:${String(s).padStart(2,'0')}`;}
function debounce(fn,ms){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);};}
const stripExt=s=>String(s).replace(/\.[a-z0-9]+$/i,'');
function deriveTitleFromFilename(name){const b=stripExt(name).replace(/^[\d._-]+/,'').replace(/[_-]+/g,' ').trim();return b||stripExt(name);}
const DATE_RX_YY=/^\s*(\d{2})[.\-_](\d{2})[.\-_](\d{2})/;
function fallbackDateFromName(n){const m=n.match(DATE_RX_YY);if(!m)return null;const y=+m[1];return new Date(Date.UTC(y>=70?1900+y:2000+y,+m[2]-1,+m[3]));}
function bpmLabel(t){if(t.bpm!=null)return`${t.bpm} BPM`;if(t.bpm_min!=null&&t.bpm_max!=null)return`${t.bpm_min}–${t.bpm_max} BPM`;return'';}
function matchesTokens(t,toks){if(!toks.length)return true;const n=(t.name||'').toLowerCase(),ttl=(t.title||'').toLowerCase(),det=(t.details||'').toLowerCase();return toks.every(tok=>tok.startsWith('#')?det.includes(tok):n.includes(tok)||ttl.includes(tok)||det.includes(tok));}

/* ---------- Elements & State ---------- */
const els={
  audio:$('#audio'),list:$('#list'),toggle:$('#toggle'),
  prev:$('#prev'),next:$('#next'),seek:$('#seek'),vol:$('#vol'),
  nowTitle:$('#now-title'),nowSub:$('#now-sub'),cover:$('#cover'),
  tcur:$('#tcur'),tdur:$('#tdur'),toolbar:$('#toolbar'),
  favbar:null,favInput:null,favModeLabel:null
};
const state={
  tracks:[],filtered:[],i:-1,playing:false,pageSize:60,renderCount:0,
  thumbBases:new Set(),resolvedThumb:new Map(),
  favorites:new Set(JSON.parse(localStorage.getItem('vvip25:favs')||'[]')),
  favOrder:JSON.parse(localStorage.getItem('vvip25:favOrder')||'[]'),
  searchQuery:'',viewMode:'all',
  extras:{},showFormats:false,showWavButtons:false,showMovButtons:false
};

state.tracks.forEach(t => {
  const k = t.base.toLowerCase();
  if (lookup.has(k)) {
    const fullTitle = lookup.get(k) || t.title;
    const [main, alt] = fullTitle.split('//').map(s => s.trim());
    t.title = main;
    if (alt) t.altTitle = alt; // optional field for later
  }
});

/* ---------- Titles ---------- */
async function fetchTitles() {
  try {
    const r = await fetch('https://vvipmedia.net/titles.json', { cache: 'no-store' });
    if (!r.ok) throw new Error(`titles.json ${r.status}`);

    const raw = await r.json();
    const json = (raw && typeof raw === 'object' && !Array.isArray(raw))
      ? (raw.titles || raw.data || raw)
      : raw;

    // build a lowercase lookup
    const lookup = new Map();
    for (const [k, v] of Object.entries(json || {})) {
      const key = stripExt(k).toLowerCase();
      lookup.set(key, v.title || v || '');
    }

    // apply to tracks, respecting "A//B" alternate title rule
    state.tracks.forEach(t => {
      const k = t.base.toLowerCase();
      if (lookup.has(k)) {
        const fullTitle = lookup.get(k) || t.title;
        const [main, alt] = fullTitle.split('//').map(s => s.trim());
        t.title = main || t.title;
        if (alt) t.altTitle = alt; // optional field for later display
      }
    });

    console.log('Titles loaded:', lookup.size);
  } catch (err) {
    console.warn('Titles fetch failed:', err);
  }
}

/* ---------- Boot ---------- */
document.addEventListener('DOMContentLoaded', init);

async function init() {
  try {
    // Build interface elements first
    buildMenuUI();
    buildFavBar();
    setControlIcons();

    // ---------- Player Controls: button bindings ----------
    $('#toggle')?.addEventListener('click', () => {
      if (state.i < 0 && state.filtered.length) select(0);
      state.playing ? pause() : play();
    });

    $('#prev')?.addEventListener('click', () => {
      if (state.filtered.length) {
        const ni = (state.i - 1 + state.filtered.length) % state.filtered.length;
        select(ni);
        play();
      }
    });

    $('#next')?.addEventListener('click', () => {
      if (state.filtered.length) {
        const ni = (state.i + 1) % state.filtered.length;
        select(ni);
        play();
      }
    });

    // --- Load manifest safely ---
    const res = await fetch(`/manifest.json?v=${ASSET_VERSION}`, { cache: 'no-store' });
    if (!res.ok) throw new Error(`manifest.json not found (${res.status})`);
    const raw = await res.text();

    let data;
    try {
      data = JSON.parse(raw);
    } catch {
      throw new Error('manifest.json is not valid JSON');
    }

    // --- Parse track entries ---
    const tracks = Array.isArray(data) ? data : (data.tracks || []);
    if (!tracks.length) throw new Error('manifest.json contains no tracks');

    state.tracks = tracks.map((t, idx) => {
      const name = t.name || '';
      const base = stripExt(name);
      const baseLower = base.toLowerCase();
      const date = t.date ? new Date(t.date) : fallbackDateFromName(name);
      return {
        id: idx,
        name,
        base,
        baseLower,
        title: t.title || deriveTitleFromFilename(name),
        details: t.details || '',
        bpm: t.bpm,
        bpm_min: t.bpm_min,
        bpm_max: t.bpm_max,
        length: t.length || 0,
        src: `${BASE_MP3}${encodeURIComponent(name)}`,
        video: t.video,
        date,
        thumbCandidate: BASE_THUMB + encodeURIComponent(baseLower + 'thumb.jpg')
      };
    });

    console.log(`Loaded ${state.tracks.length} tracks`);

    // --- Supplementary data ---
    if (typeof fetchTitles === 'function') {
      await fetchTitles().catch(err => console.warn('Titles fetch failed:', err));
    } else {
      console.warn('fetchTitles() not defined — skipping title loading.');
    }

    await fetchThumbs().catch(err => console.warn('Thumbs fetch failed:', err));

    // --- Thumbnails + render ---
    computeThumbCascade();
    setView('all');
    preselectPreferred(PREFERRED_TITLE);

    console.log('Init completed successfully.');
  } catch (err) {
    console.error('Init failed:', err);
    const list = document.getElementById('list');
    if (list) {
      list.innerHTML = `
        <div class="row">
          <div style="color:#f88;padding:12px;">
            Load error: ${err.message || err}
          </div>
        </div>`;
    }
  }
}
/* ---------- View / Filter / Favs ---------- */
function buildFavBar(){
  const wrap=document.querySelector('main .wrap');
  const bar=document.createElement('div');
  bar.className='favbar';
  bar.innerHTML='<span id="favMode">Search</span><input id="favSearch" type="search" placeholder="Filter with #tags or text">';
  wrap.prepend(bar);
  els.favbar=bar; els.favInput=bar.querySelector('#favSearch'); els.favModeLabel=bar.querySelector('#favMode');
  els.favInput.addEventListener('input',debounce(()=>{
    const q=(els.favInput.value||'').trim().toLowerCase();
    state.searchQuery=q; setView(q?'search':'favorites');
  },120));
}
function setView(mode){state.viewMode=mode;applyFilterSort(true);}
function applyFilterSort(first=false){
  const toks=(state.searchQuery||'').split(/\s+/).filter(Boolean);
  let out=[...state.tracks];
  if(state.viewMode==='favorites'&&!toks.length)out=out.filter(t=>state.favorites.has(t.name));
  else if(state.viewMode==='search')out=out.filter(t=>matchesTokens(t,toks));
  out.sort((a,b)=>(b.date-a.date)||b.name.localeCompare(a.name));
  
state.filtered = out;
state.renderCount = out.length; // <-- render everything
renderList();
}

/* ---------- Thumbs + Row Click ---------- */
async function fetchThumbs() {
  try {
    const r = await fetch('assets/thumbs/thumbs.json', { cache: 'no-store' });
    if (!r.ok) throw new Error(`thumbs.json not found (${r.status})`);
    const data = await r.json();
    state.thumbBases.clear();
    data.forEach(f => state.thumbBases.add(f.toLowerCase()));
    console.log(`✅ Loaded ${state.thumbBases.size} local thumbs`);
  } catch (err) {
    console.warn('⚠️ fetchThumbs failed, using hardcoded fallback');
    const thumbs = [
      '24.03.15.105thumb.jpg',
      '24.09.03.122thumb.jpg',
      '25.07.17.171thumb.jpg',
      'IJPAUCthumb.jpg'
    ];
    state.thumbBases.clear();
    thumbs.forEach(f => state.thumbBases.add(f.toLowerCase()));
  }
}

function computeThumbCascade() {
  console.log('🧩 Computing thumbnail cascade...');

  // Sort oldest → newest by date
  const asc = [...state.tracks].sort((a, b) =>
    (a.date - b.date) || a.name.localeCompare(b.name)
  );

  let currentThumb = DEFAULT_THUMB;

  for (const t of asc) {
    const key = t.baseLower + 'thumb.jpg';
    // ✅ Check if we have an actual local thumb file
    if (state.thumbBases.has(key)) {
      currentThumb = BASE_THUMB + key;
      console.log(`🖼️ thumb switch → ${t.name} → ${currentThumb}`);
    }

    // ✅ Assign that thumb to this track
    state.resolvedThumb.set(t.id, currentThumb);
  }

  console.log('✅ Cascade complete:', state.resolvedThumb.size, 'entries');
}

// ✅ Special IJ override
function getResolvedThumb(t) {
  const details = (t.details || '').toLowerCase();
  if (details.includes('#ij')) return BASE_THUMB + 'IJPAUCthumb.jpg';
  return state.resolvedThumb.get(t.id) || DEFAULT_THUMB;
}

/* ---------- Row click handler ---------- */
// Clicking any row selects & plays that track (ignore stars/links)
document.addEventListener('click', e => {
  const row = e.target.closest('.row');
  if (!row || e.target.closest('a') || e.target.closest('.star')) return;
  const id = Number(row.dataset.id);
  const idx = state.filtered.findIndex(t => t.id === id);
  if (idx >= 0) {
    select(idx);
    play();
  }
});

/* ---------- Rendering ---------- */
function imgHTML(src, isCover = false) {
  if (isCover) {
    // ✅ Full-size player cover image (fills .cover)
    return `<img src="${src}" alt="Cover" onerror="this.onerror=null;this.src='${DEFAULT_THUMB}'">`;
  } else {
    // ✅ Small track list thumbnail
    return `<img src="${src}" alt="Thumb" onerror="this.onerror=null;this.src='${DEFAULT_THUMB}'" style="width:56px;height:56px;border-radius:8px;object-fit:cover;">`;
  }
}

function favHTML(t) {
  const on = state.favorites.has(t.name) ? 'on' : '';
  return `<button class="star ${on}" data-fav="${t.name}">★</button>`;
}

function badgeHTML(t) {
  const p = [favHTML(t)];
  if (state.showFormats) {
    p.push(`<a class="pill" href="${t.src}" download>MP3</a>`);
    p.push(`<a class="pill" href="${BASE_WAV + encodeURIComponent(t.base + '.wav')}" download>WAV</a>`);
    if (t.video) p.push(`<a class="pill" href="${t.video}" target="_blank">MOV</a>`);
    if (state.extras[t.baseLower]) p.push(`<button class="pill gem" data-gem="${t.baseLower}">💎</button>`);
  }
  return `<div class="badge">${p.join('')}</div>`;
}

function rowHTML(t) {
  const sub = [bpmLabel(t), t.length ? fmtDur(t.length) : '', t.date ? t.date.toISOString().slice(0,10) : '']
    .filter(Boolean)
    .join(' · ');
  return `
    <div class="row" data-id="${t.id}">
      <div class="left">${imgHTML(getResolvedThumb(t))}</div>
      <div class="middle">
        <div class="title">${t.title}</div>
        <div class="sub">${sub}</div>
      </div>
      <div class="right">${badgeHTML(t)}</div>
    </div>`;
}

function renderList() {
  els.list.innerHTML = state.filtered.slice(0, state.renderCount).map(rowHTML).join('');
}

/* ---------- Player Core ---------- */
function preselectPreferred(x){
  if(!x||!state.filtered.length) return;
  const idx = state.filtered.findIndex(t => t.title.toLowerCase().includes(x));
  if(idx >= 0) select(idx);
}

function select(i){
  state.i = i;
  const t = state.filtered[i];
  els.audio.src = t.src;
  updateNowbar();
}

function updateNowbar(){
  const t = state.filtered[state.i];
  if(!t) return;

  // desktop title
  els.nowTitle.textContent = t.title;

  // sub info line
  els.nowSub.textContent = [bpmLabel(t), fmtDur(t.length || 0)].join(' · ');

  // cover image
  els.cover.innerHTML = imgHTML(getResolvedThumb(t), true);

  // ✅ also update mobile overlay title
  els.nowTitleMobile = document.getElementById('now-title-mobile');
  if (els.nowTitleMobile) els.nowTitleMobile.textContent = t.title;
}

function play(){
  try {
    const playPromise = els.audio.play();
    if (playPromise !== undefined) {
      playPromise
        .then(() => {
          state.playing = true;
          setControlIcons();
          document.body.classList.add('playing');
        })
        .catch(err => {
          console.warn('Autoplay blocked or failed:', err);
        });
    } else {
      state.playing = true;
      setControlIcons();
      document.body.classList.add('playing');
    }
  } catch (err) {
    console.error('play() error:', err);
  }
}

function pause(){
  els.audio.pause();
  state.playing = false;
  document.body.classList.remove('playing'); // ✅ stop shimmer
  setControlIcons();
}

function setControlIcons(){
  const svgPrev  = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="#fdf6d0" d="M7 5a1 1 0 0 1 1 1v12a1 1 0 1 1-2 0V6a1 1 0 0 1 1-1zm11.4 1.2a1 1 0 0 1 .6.9v9.8a1 1 0 0 1-1.6.8l-8.2-4.9a1 1 0 0 1 0-1.7l8.2-4.9a1 1 0 0 1 1-.1z"/></svg>';
  const svgNext  = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="#fdf6d0" d="M17 5a1 1 0 0 1 1 1v12a1 1 0 1 1-2 0V6a1 1 0 0 1 1-1zM5.6 6.2a1 1 0 0 1 1 .1l8.2 4.9a1 1 0 0 1 0 1.7l-8.2 4.9A1 1 0 0 1 5 17V7.2a1 1 0 0 1 .6-.9z"/></svg>';
  const svgPlay  = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="#fdf6d0" d="M8 5v14l11-7z"/></svg>';
  const svgPause = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="#fdf6d0" d="M6 5h4v14H6zM14 5h4v14h-4z"/></svg>';

  if($('#prev'))   $('#prev').innerHTML   = svgPrev;
  if($('#next'))   $('#next').innerHTML   = svgNext;
  if($('#toggle')) $('#toggle').innerHTML = state.playing ? svgPause : svgPlay;
}

/* --- Scrubbing + time display for track title --- */
document.addEventListener('DOMContentLoaded', () => {
  const audio = document.getElementById('audio');
  const scrub = document.getElementById('scrub');
  const nowTime = document.getElementById('now-time');
  if (!audio || !scrub || !nowTime) return;

  // Update position + time as track plays
  audio.addEventListener('timeupdate', () => {
    if (!audio.duration) return;
    scrub.value = (audio.currentTime / audio.duration) * 100;
    nowTime.textContent = fmtDur(audio.currentTime);
  });

  // Allow user to seek
  scrub.addEventListener('input', () => {
    if (!audio.duration) return;
    const pct = scrub.value / 100;
    audio.currentTime = audio.duration * pct;
  });
});

/* ---------- Gear + Toolbar ---------- */
function setGearOpen(o){$('#gearwrap')?.classList.toggle('open',!!o);}
document.addEventListener('click',e=>{
  const gw=$('#gearwrap');if(!gw)return;
  const btn=$('#gearBtn');
  if(btn.contains(e.target)){e.preventDefault();setGearOpen(!gw.classList.contains('open'));return;}
  if(!gw.contains(e.target))setGearOpen(false);
});

function buildMenuUI(){
  const tb = els.toolbar;
  if (!tb) return;
  tb.innerHTML = '';

  // --- Define link helper early so it's in scope ---
  function a(h, t, l) {
    const x = document.createElement('a');
    x.href = h;
    x.target = '_blank';
    x.rel = 'noopener';
    x.className = 'btn icon';
    x.title = l;
    x.innerHTML = t;
    return x;
  }

  // --- Info button ---
  const bInfo = document.createElement('button');
  bInfo.className = 'btn icon';
  bInfo.innerHTML = 'ℹ';
  bInfo.title = 'Info';
  bInfo.onclick = () =>
    alert('Welcome to VVIP PLAYER 1.1! Press the ★ next to tracks to add them to your playlist. 🎶 ');
  tb.append(bInfo);

  // --- Plus button (toggle formats) ---
  const bPlus = document.createElement('button');
  bPlus.className = 'btn';
  bPlus.textContent = '+';
  bPlus.title = 'Toggle formats';
  tb.append(bPlus);

  const updatePlus = () => {
    bPlus.classList.toggle('on', state.showFormats);
    tb.classList.toggle('show-sort', state.showFormats);
  };

  bPlus.onclick = e => {
    e.preventDefault();
    state.showFormats = !state.showFormats;
    state.showWavButtons = state.showFormats;
    state.showMovButtons = state.showFormats;
    updatePlus();
    renderList();
  };

  // --- Favorites toggle ---
  const bFav = document.createElement('button');
  bFav.className = 'btn';
  const refresh = () => {
    const fav = state.viewMode === 'favorites' || state.viewMode === 'search';
    bFav.textContent = fav ? '🎵' : '⭐';
  };
  refresh();

  bFav.onclick = e => {
    e.preventDefault();
    if (state.viewMode === 'all') setView('favorites');
    else setView('all');
    refresh();
  };
  tb.append(bFav);

  // --- External + shop links ---
  const yt = a('https://www.youtube.com/@VVVVIIPP25', '📺', 'YouTube');
  const ig = a('https://www.instagram.com/vvipmediadotnet/', '📷', 'Instagram');
  const bShop = document.createElement('a');
  bShop.className = 'btn icon';
  bShop.href = '/shoppe/index.html';
  bShop.title = 'Shop';
  bShop.innerHTML = '🛍️';
  tb.append(yt, ig, bShop);

  // --- Sort select ---
  const sort = document.createElement('select');
  sort.id = 'sort';
  sort.innerHTML = `
    <option value="date_desc">Newest</option>
    <option value="date_asc">Oldest</option>
    <option value="bpm_desc">BPM↓</option>
    <option value="bpm_asc">BPM↑</option>
    <option value="len_desc">Longest</option>
    <option value="len_asc">Shortest</option>`;
  sort.onchange = () => applyFilterSort(false, true);
  tb.append(sort);

  // --- Show welcome popup once ---
  try {
    const hasVisited = localStorage.getItem('vvip_visited');
    if (!hasVisited) {
      setTimeout(() => {
        alert('Welcome to 🎶VVIP MEDIA🎶! Star your faves to create a playlist; check menu for extras.');
      }, 400);
      localStorage.setItem('vvip_visited', 'true');
    }
  } catch (err) {
    console.warn('LocalStorage unavailable', err);
  }
}

/* ---------- Extras / Gems ---------- */
(async()=>{try{
  const r=await fetch(`/extras.json?v=${ASSET_VERSION}`,{cache:'no-store'});
  state.extras=await r.json();
}catch{}})();

document.addEventListener('click',e=>{
  const gem=e.target.closest('.gem');
  if(!gem) return;

  e.preventDefault();
  const key = gem.dataset.gem;
  const files = state.extras[key];
  if(!files) return;

  const row = gem.closest('.row');
  const next = row.nextElementSibling;
  if(next && next.classList.contains('extras-drawer')){
    next.remove();
    return;
  }

  const d = document.createElement('div');
  d.className = 'extras-drawer';
  d.style.cssText = `
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    padding:8px 12px;
    background:var(--card);
    border-top:1px solid var(--border);
  `;

  // ✅ Correct URL (no subfolder of same name)
  d.innerHTML = files.map(f => {
    const url = `${BASE_EXTRAS}${encodeURIComponent(f)}`;
    return /\.(jpg|jpeg|png|gif|webp)$/i.test(f)
      ? `<a href="${url}" target="_blank"><img src="${url}" style="width:64px;height:64px;object-fit:cover;border-radius:8px"></a>`
      : `<a href="${url}" target="_blank" class="pill">${f}</a>`;
  }).join('');

  row.after(d);
});

// ---------- Favorites click handler ----------
document.addEventListener('click', e => {
  const btn = e.target.closest('.star');
  if (!btn) return;

  const trackName = btn.dataset.fav;
  const wasFav = state.favorites.has(trackName);

  // Toggle
  if (wasFav) state.favorites.delete(trackName);
  else state.favorites.add(trackName);

  // Persist to localStorage
  localStorage.setItem('vvip25:favs', JSON.stringify([...state.favorites]));

  // Update visuals
  btn.classList.toggle('on', !wasFav);

  // If viewing favorites-only, refresh
  if (state.viewMode === 'favorites' && wasFav) applyFilterSort();
});

/* --- Toggle search bar visibility when playlist (⭐/🎵) clicked --- */
document.addEventListener('click', e => {
  const favBtn = e.target.closest('.btn');
  if (!favBtn) return;

  // Check if it's the favorites/playlist toggle
  if (favBtn.textContent.trim() === '⭐' || favBtn.textContent.trim() === '🎵') {
    document.body.classList.toggle('show-search');
  }
});

</script>
<script>
// --- Save playback state when leaving page ---
window.addEventListener('beforeunload', () => {
  try {
    const player = document.querySelector('audio');
    if (!player) return;
    localStorage.setItem('vvip25_src', player.src);
    localStorage.setItem('vvip25_time', player.currentTime);
    localStorage.setItem('vvip25_playing', !player.paused);
    localStorage.setItem('vvip25_title', document.querySelector('#now-title')?.textContent || '');
  } catch(e) {
    console.warn('Could not save player state', e);
  }
});
</script>

</body>
</html>