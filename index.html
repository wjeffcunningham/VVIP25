<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VVIP25</title>
  <link rel="icon" type="image/png" sizes="64x64" href="/favicon-64.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon-192.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" href="/favicon.ico?v=3">
  <meta name="theme-color" content="#0b0b0c" />
  <style>
    :root{--bg:#0b0b0c;--fg:#eceff4;--muted:#9aa0a6;--card:#141416;--border:#26272b;--accent:#6ee7b7}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 -apple-system,BlinkMacSystemFont,"Helvetica Neue",Helvetica,Arial,"Segoe UI",Roboto,Inter,system-ui,sans-serif}
    .wrap{max-width:920px;margin:0 auto;padding:16px}

    header{display:flex;align-items:center;justify-content:space-between;gap:12px;position:relative}
    #site-title{margin:0;font-size:56px;font-weight:bold;font-family:"Helvetica Neue",Helvetica,Arial,sans-serif;color:transparent;-webkit-text-fill-color:transparent;-webkit-text-stroke:2px #fdf6d0}

    .player{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(11,11,12,.97),rgba(11,11,12,.92));backdrop-filter:saturate(120%) blur(8px);border-bottom:1px solid var(--border)}
    .now{display:grid;grid-template-columns:auto 1fr auto;gap:12px;align-items:center;padding:12px 0}
    .cover{width:56px;height:56px;border-radius:8px;background:#1e1f24;display:grid;place-items:center;color:var(--muted);font-weight:700;border:1px solid var(--border)}
    .meta{min-width:0}
    .title{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .sub{color:var(--muted);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .controls{display:flex;align-items:center;gap:8px}
    button{appearance:none;background:var(--card);color:var(--fg);border:1px solid var(--border);border-radius:10px;padding:8px 12px;cursor:pointer}
    button:disabled{opacity:.55;cursor:not-allowed}
    .range{display:flex;align-items:center;gap:8px}
    input[type="range"]{width:160px}
    .list{margin:12px 0 40px;border:1px solid var(--border);border-radius:14px;overflow:hidden}
    .row{display:grid;grid-template-columns:56px 1fr auto;gap:12px;align-items:center;padding:10px 12px;border-top:1px solid var(--border);background:var(--card);min-height:78px}
    .row:first-child{border-top:0}
    .row:hover{background:#17171b}
    .badge{display:flex;gap:10px;align-items:center;font-size:12px;justify-self:end}
    .badge a{color:var(--fg);text-decoration:none;border:1px solid var(--border);padding:4px 8px;border-radius:8px}
    .badge .muted{color:var(--muted)}
    .kbd{font:12px/1.2 ui-monospace,Menlo,Consolas;background:#1b1c20;border:1px solid #2a2b30;border-radius:6px;padding:2px 6px;color:#d7dae0}

    /* Toolbar + toggles */
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    select{background:var(--card);color:var(--fg);border:1px solid var(--border);border-radius:10px;padding:8px 10px}
    .tog,.btn{
      display:inline-flex;align-items:center;justify-content:center;
      height:36px;min-width:36px;padding:0 10px;
      border-radius:10px;border:1px solid var(--border);background:var(--card);
      text-decoration:none;color:var(--fg);line-height:1
    }
    .tog{opacity:.6;transition:opacity .15s, box-shadow .15s}
    .tog.on{opacity:1;box-shadow:0 0 0 2px var(--accent) inset}

    /* Hamburger (overlay) */
    details.menu{position:static}
    details.menu>summary{cursor:pointer;list-style:none;background:var(--card);border:1px solid var(--border);padding:8px 12px;border-radius:10px;user-select:none}
    .sheet{position:absolute;top:calc(100% + 8px);right:0;z-index:20;width:min(420px,calc(100vw - 32px));background:var(--card);border:1px solid var(--border);border-radius:10px;padding:10px;display:none;box-shadow:0 10px 24px rgba(0,0,0,.35)}
    details.menu[open]>.sheet{display:block}
    details.menu[open]>summary{border-bottom-left-radius:10px;border-bottom-right-radius:10px}

    /* Hide the volume control on iOS Safari */
    @supports (-webkit-touch-callout:none){.range[title="Volume"]{display:none !important}}

    @media (max-width:560px){
      .now{grid-template-columns:1fr;gap:8px}
      .cover{display:none}
      .controls{flex-wrap:wrap}
      .range input[type="range"]{width:120px}
      .row{grid-template-columns:1fr auto}
    }
  </style>
</head>
<body>
  <div class="player">
    <div class="wrap">
      <header>
        <h1 id="site-title">VVIP25</h1>
        <details class="menu" id="menu">
          <summary>‚ò∞ Menu</summary>
          <div class="sheet">
            <div class="toolbar" id="toolbar">
              <select id="sort" title="Sort">
                <option value="date_desc">Newest</option>
                <option value="date_asc">Oldest</option>
                <option value="bpm_desc">BPM ‚Üì</option>
                <option value="bpm_asc">BPM ‚Üë</option>
                <option value="len_desc">Longest</option>
                <option value="len_asc">Shortest</option>
              </select>
              <button class="tog on" id="togTitles" title="Song Titles (on/off)">üìù</button>
              <button class="tog" id="togWav" title="Show WAV buttons">üéöÔ∏è</button>
              <button class="tog" id="togMov" title="Show MOV buttons">üé¨</button>
              <button class="btn" id="btnAbout" title="About">‚ÑπÔ∏è</button>
              <a class="btn" id="btnShop" href="/shop" target="_blank" rel="noopener" title="Shop">üõçÔ∏è</a>
            </div>
          </div>
        </details>
      </header>

      <div class="now">
        <div class="cover" id="cover">V25</div>
        <div class="meta">
          <div class="title" id="now-title">‚Äî</div>
          <div class="sub" id="now-sub">Ready</div>
        </div>
        <div class="controls">
          <button id="prev" aria-label="Previous">‚èÆÔ∏è</button>
          <button id="toggle" aria-label="Play/Pause">‚ñ∂Ô∏è</button>
          <button id="next" aria-label="Next">‚è≠Ô∏è</button>
          <div class="range">
            <span id="tcur">0:00</span>
            <input id="seek" type="range" min="0" max="100" value="0" step="1" aria-label="Seek" />
            <span id="tdur">0:00</span>
          </div>
          <div class="range" title="Volume">
            <span>üîä</span>
            <input id="vol" type="range" min="0" max="1" step="0.01" />
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div id="list" class="list" role="list"></div>
  </div>

  <audio id="audio" preload="metadata"></audio>

<script>
/* ========================== VVIP25 ‚Äî Phase 3 cleanup (menu + favorites UX) ==========================

Adds:
‚Ä¢ Favorites ‚òÖ visibly ‚Äúon‚Äù (filled star, accent color, aria-pressed) and instant toggle.
‚Ä¢ Favorites are stored with a selection ORDER; Playlist (üéµ) view shows them in that order.
‚Ä¢ Menu rebuilt per spec:
    Level 1: About (üé¥), Playlist (üéµ), Utilities (üõ†Ô∏è), Shop (üõçÔ∏è)
    Level 2 (Utilities): toggles + search live here.
‚Ä¢ Keeps prior fixes: cache-busting, mobile spacing, titles default OFF, hide ‚Äútitleless‚Äù when titles ON, notes/tags search.

====================================================================================================== */

  // ====== CONFIG ======
  const BASE_MP3   = 'https://media.vvipmedia.net/ACCESS/';
  const BASE_WAV   = 'https://media.vvipmedia.net/WAV/';
  const BASE_THUMB = 'https://media.vvipmedia.net/ACCESS/';
  const BASE_VIDEO = 'https://media.vvipmedia.net/VIDEOS/';
  const DEFAULT_THUMB = BASE_THUMB + 'default_thumb.jpg';

  // Bump to beat caches after any JSON/script change
  const ASSET_VERSION = 9;

  // ---- Light HTML no-store hint (browser-side only) ----
  (function injectNoStoreMeta(){
    try{
      const m = document.createElement('meta');
      m.httpEquiv = 'Cache-Control';
      m.content = 'no-store, max-age=0, must-revalidate';
      document.head.appendChild(m);
    }catch(_){}
  })();

  // ---- Mobile CSS & small layout fixes ----
  (function injectCSS(){
    const css = `
    .controls{flex-wrap:wrap;gap:10px}
    .controls .range{min-width:140px;flex:1}
    .controls .range input[type="range"]{width:100%}
    .controls button{min-width:44px}
    @media (max-width:560px){
      .controls{gap:6px}
      .controls button{flex:0 0 44px}
      .range span{min-width:34px;text-align:center}
    }
    /* Toolbar & submenu */
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .toolbar .btn,.toolbar .tog, .toolbar select{
      height:36px;min-width:36px;padding:0 10px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--fg)
    }
    details.submenu>summary{
      cursor:pointer;list-style:none;background:var(--card);
      border:1px solid var(--border);padding:8px 12px;border-radius:10px;user-select:none
    }
    details.submenu[open]>summary{border-bottom-left-radius:10px;border-bottom-right-radius:10px}
    details.submenu[open] .sheet-inner{display:block}
    .sheet-inner{display:none;padding:8px 0}
    .search-wrap{display:flex;gap:8px;align-items:center;margin-top:8px}
    .search-wrap input{
      flex:1;min-width:160px;background:var(--card);color:var(--fg);
      border:1px solid var(--border);border-radius:10px;padding:8px 10px
    }
    .pill{border:1px solid var(--border);border-radius:999px;padding:4px 10px;font-size:12px}
    .star{
      cursor:pointer;min-width:36px;height:28px;padding:0 8px;border:1px solid var(--border);
      border-radius:8px;background:var(--card);line-height:26px
    }
    .star.on{color:var(--accent);box-shadow:0 0 0 2px color-mix(in srgb, var(--accent) 40%, transparent) inset}
    `;
    const style = document.createElement('style');
    style.textContent = css;
    document.head.appendChild(style);
  })();

  // -------- Helpers --------
  const $ = sel => document.querySelector(sel);
  function fmtDur(sec){ sec=Number(sec||0); const m=Math.floor(sec/60), s=Math.floor(sec%60); return `${m}:${String(s).padStart(2,'0')}`; }
  function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); } }
  function escapeHTML(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
  function removeBpm(str){
    if (!str) return str;
    return String(str).replace(/\b\d+(?:\.\d+)?(?:\s*[‚Äì‚Äî-]\s*\d+(?:\.\d+)?)?\s*BPM\b/gi,'').replace(/\s{2,}/g,' ').trim();
  }
  function cleanToken(s){
    if (!s) return '';
    s = String(s).trim().replace(/^[¬∑‚Ä¢,;:\-]+|[¬∑‚Ä¢,;:\-]+$/g,'').replace(/\s*[.,;:]\s*$/,'');
    return s.trim();
  }
  function uniqJoin(parts){
    const seen = new Set(), out = [];
    for (let raw of parts){
      if (raw == null) continue;
      raw = cleanToken(removeBpm(raw));
      if (!raw) continue;
      const key = raw.toLowerCase();
      if (seen.has(key)) continue;
      seen.add(key);
      out.push(raw);
    }
    return out.join(' ¬∑ ');
  }
  const rawFile   = (s) => (String(s).split('/').pop() || '');
  const stripExt  = (s) => String(s).replace(/\.[a-z0-9]+$/i,'');
  const softNorm  = (s) => stripExt(s).toLowerCase().replace(/[ _]+/g,'-').replace(/-+/g,'-');
  function deriveTitleFromFilename(name){
    const b = stripExt(rawFile(name)).replace(/^[\d._-]+/,'').replace(/[_-]+/g,' ').trim();
    return b || stripExt(rawFile(name));
  }
  const primaryOnly = (t) => String(t||'').split('//')[0].trim(); // primary of "A//B"

  // --- "Nameless" title detection (title equals date/filename-ish) ---
  function isTitleless(t){
    const title = String(t.title||'').trim();
    if (!title) return true;
    const rxYYYY = /^\s*\d{4}[.\-_]\d{2}[.\-_]\d{2}(?:\b|$)/;
    const rxYY   = /^\s*\d{2}[.\-_]\d{2}[.\-_]\d{2}(?:\b|$)/;
    if (rxYYYY.test(title) || rxYY.test(title)) return true;
    const bareFile = stripExt(rawFile(t.name)).toLowerCase();
    if (title.toLowerCase() === bareFile) return true;
    if (title === deriveTitleFromFilename(t.name)) return true;
    return false;
  }

  // -------- Filename/date parsing (YYYY or YY + optional index) --------
  const DATE_RX_YYYY   = /^\s*(\d{4})[.\-_](\d{2})[.\-_](\d{2})(?=\D|$)/;
  const DATE_RX_YY     = /^\s*(\d{2})[.\-_](\d{2})[.\-_](\d{2})(?=\D|$)/;
  const WITHIN_DAY_RX  = /^\s*(?:\d{4}|\d{2})[.\-_]\d{2}[.\-_]\d{2}(?:[.\-_](\d+))?/;
  function fallbackDateFromName(name){
    const s = String(name);
    let m = s.match(DATE_RX_YYYY);
    if (m) {
      const yyyy = Math.max(1970, Math.min(2100, parseInt(m[1],10)));
      const mm   = Math.max(1, Math.min(12,  parseInt(m[2],10)));
      const dd   = Math.max(1, Math.min(31,  parseInt(m[3],10)));
      return new Date(Date.UTC(yyyy, mm-1, dd));
    }
    m = s.match(DATE_RX_YY);
    if (m) {
      const yy = parseInt(m[1],10);
      const yyyy = (yy >= 70 ? 1900+yy : 2000+yy);
      const mm   = Math.max(1, Math.min(12, parseInt(m[2],10)));
      const dd   = Math.max(1, Math.min(31, parseInt(m[3],10)));
      return new Date(Date.UTC(yyyy, mm-1, dd));
    }
    return null;
  }
  function withinDayIndexFromName(name){
    const m = String(name).match(WITHIN_DAY_RX);
    return m && m[1] ? parseInt(m[1],10) : 0;
  }

  function bpmSortValue(t){ if(t.bpm!=null) return t.bpm; if(t.bpm_min!=null&&t.bpm_max!=null) return (t.bpm_min+t.bpm_max)/2; return 0; }
  function bpmLabel(t){ if(t.bpm!=null) return `${t.bpm} BPM`; if(t.bpm_min!=null&&t.bpm_max!=null) return `${t.bpm_min}‚Äì${t.bpm_max} BPM`; return ''; }

  // -------- Els --------
  const els = {
    audio: $('#audio'),
    list: $('#list'),
    sort: $('#sort'),
    toggle: $('#toggle'),
    prev: $('#prev'),
    next: $('#next'),
    seek: $('#seek'),
    vol: $('#vol'),
    nowTitle: $('#now-title'),
    nowSub: $('#now-sub'),
    tcur: $('#tcur'),
    tdur: $('#tdur'),
    cover: $('#cover'),
    menu: $('#menu'),
    toolbar: $('#toolbar')
  };

  // -------- State --------
  const state = {
    tracks: [],
    filtered: [],
    i: -1,
    playing: false,
    pageSize: 60,
    renderCount: 0,
    titlesLookup: new Map(),
    thumbBases: new Set(),
    resolvedThumb: new Map(),
    showTitles: false,          // default OFF
    showWavButtons: false,
    showMovButtons: false,
    // Favorites: both a Set for membership checks and an Array for selection ORDER
    favorites: new Set(JSON.parse(localStorage.getItem('vvip25:favs')||'[]')),
    favOrder: JSON.parse(localStorage.getItem('vvip25:favs_order')||'[]'), // array of names in selection order
    searchQuery: '',
    view: 'all' // 'all' | 'favorites'
  };

  // Persisted volume
  els.vol.value = localStorage.getItem('vvip25:vol') ?? '0.9';
  els.audio.volume = parseFloat(els.vol.value);

  // Boot
  init();
  async function init(){
    // Build Menu UI first (so refs exist)
    buildMenuUI();

    // Fetch manifest
    const murl = `./manifest.json?v=${ASSET_VERSION}`;
    const mres = await fetch(murl, { cache: 'no-store' });
    if(!mres.ok){
      els.list.innerHTML = `<div class="row"><div></div><div>manifest.json missing</div></div>`;
      return;
    }
    const data = await mres.json();

    state.tracks = data.map((t,idx)=>{
      const name = t.name || t.file || t.src?.split('/').pop() || `track-${idx}.mp3`;
      const base = stripExt(name);
      const baseLower = base.toLowerCase();
      const dateObj = t.date ? new Date(t.date) : fallbackDateFromName(name);
      const labelDate = dateObj ? dateObj.toISOString().slice(0,10) : '';

      const mp3 = t.src || (BASE_MP3 + encodeURIComponent(name));
      const wav = BASE_WAV + encodeURIComponent(base + '.wav');
      const mov = t.has_mov ? (BASE_VIDEO + encodeURIComponent(base + '.mov')) : null;

      const thumbCandidate = BASE_THUMB + encodeURIComponent(baseLower + 'thumb.jpg');

      let notes = '';
      if (Array.isArray(t.notes)) notes = t.notes.join(' ');
      else if (typeof t.notes === 'string') notes = t.notes;

      return {
        id: idx,
        name, base, baseLower,
        title: t.title ? String(t.title) : '',
        bpm: t.bpm ?? null,
        bpm_min: t.bpm_min ?? null,
        bpm_max: t.bpm_max ?? null,
        details: t.details || '',
        length: t.length || 0,
        date: dateObj || null,
        labelDate,
        src: mp3,
        wav,
        video: mov,
        thumbCandidate,
        notes: notes || ''
      };
    });

    applyFilterSort(true);
    computeThumbCascade();
    renderList();
    fillViewport();
    if (state.filtered.length && state.i === -1) { select(0); }

    // Lazy extras
    (requestIdleCallback?.(fetchTitles, {timeout: 600}) || setTimeout(fetchTitles, 0));
    (requestIdleCallback?.(fetchThumbs, {timeout: 900}) || setTimeout(fetchThumbs, 50));
  }

  // --- Titles (with primaryOnly split) ---
  function buildTitleLookup(json){
    const map = new Map();
    const add = (k, titleRaw) => {
      if (!k || !titleRaw) return;
      const title = primaryOnly(titleRaw);
      const rawLower = String(k).toLowerCase();
      const justFile = rawFile(rawLower);
      const noExt = stripExt(justFile);
      const norm = softNorm(justFile);
      map.set(justFile, String(title));
      map.set(noExt,   String(title));
      map.set(norm,    String(title));
    };
    if (Array.isArray(json)) {
      for (const row of json || []) {
        if (!row) continue;
        const k = row.key || row.src || row.name;
        const t = row.title || row.t || row.display;
        add(k, t);
      }
    } else if (json && typeof json === 'object') {
      for (const [k,v] of Object.entries(json)) {
        const t = (typeof v === 'string') ? v : (v && typeof v.title === 'string' ? v.title : '');
        add(k, t);
      }
    }
    return map;
  }

  function bestTitleForTrack(t, lookup){
    const f = rawFile(t.name).toLowerCase();
    const noExt = stripExt(f);
    const norm = softNorm(f);
    const fromSrc = t.src ? rawFile(t.src).toLowerCase() : '';
    const candidates = [
      f, noExt, norm,
      fromSrc, stripExt(fromSrc), softNorm(fromSrc),
      t.base?.toLowerCase?.(), softNorm(t.base || '')
    ].filter(Boolean);
    for (const c of candidates){
      if (lookup.has(c)) return lookup.get(c);
    }
    return '';
  }

  async function fetchTitles(){
    const turl = `./titles.json?v=${ASSET_VERSION}`;
    try{
      const tres = await fetch(turl, { cache: 'no-store' });
      if (!tres.ok) return;
      const json = await tres.json();
      const lookup = buildTitleLookup(json);
      state.titlesLookup = lookup;

      let changed = false;
      for (const t of state.tracks){
        const fromTitles = bestTitleForTrack(t, lookup);
        const finalTitle = fromTitles || t.title || deriveTitleFromFilename(t.name);
        if (finalTitle !== t.title){
          t.title = finalTitle;
          changed = true;
        }
      }
      if (changed){
        applyFilterSort(false, /*keepIndex=*/true);
        refreshTitles();
      }
    }catch(_){}
  }

  // thumbs.json can be array of bases or object of base:true
  async function fetchThumbs(){
    try{
      const url = `./thumbs.json?v=${ASSET_VERSION}`;
      const r = await fetch(url, { cache: 'no-store' });
      if (!r.ok) return;
      const data = await r.json();
      const set = new Set();
      if (Array.isArray(data)) data.forEach(base => set.add(String(base).toLowerCase()));
      else if (data && typeof data === 'object') Object.keys(data).forEach(base => { if (data[base]) set.add(base.toLowerCase()); });
      state.thumbBases = set;

      computeThumbCascade();
      rerenderVisibleRowsThumbs();
      if (state.i>=0) updateNowbar();
    }catch(_){}
  }

  function computeThumbCascade(){
    const asc = [...state.tracks].sort((a,b)=>{
      const da=a.date?.getTime()||0, db=b.date?.getTime()||0;
      if (da!==db) return da-db;
      return withinDayIndexFromName(a.name)-withinDayIndexFromName(b.name) || a.name.localeCompare(b.name);
    });
    let currentThumb = DEFAULT_THUMB;
    for (const t of asc){
      if (state.thumbBases.has(t.baseLower)) currentThumb = t.thumbCandidate;
      state.resolvedThumb.set(t.id, currentThumb);
    }
  }
  const getResolvedThumb = t => state.resolvedThumb.get(t.id) || DEFAULT_THUMB;

  // ---- Filtering, search, sort ----
  function matchesSearch(t){
    const q = state.searchQuery.trim().toLowerCase();
    if (!q) return true;
    const tokens = q.split(/\s+/).filter(Boolean);
    const hayName  = (t.name||'').toLowerCase();
    const hayTitle = (t.title||'').toLowerCase();
    const hayNotes = (t.notes||'').toLowerCase();
    return tokens.every(tok=>{
      if (tok.startsWith('#')) return hayNotes.includes(tok);
      return hayName.includes(tok) || hayTitle.includes(tok) || hayNotes.includes(tok);
    });
  }

  function applyFavoritesOrdering(list){
    // Keep only favorites, in the order the user selected them (favOrder)
    const order = state.favOrder;
    const byName = new Map(list.map(t => [t.name, t]));
    const out = [];
    for (const name of order){
      if (state.favorites.has(name) && byName.has(name)) out.push(byName.get(name));
    }
    return out;
  }

  function applyFilterSort(firstPaint=false, keepIndex=false){
    let out = [...state.tracks].filter(t => {
      if (!matchesSearch(t)) return false;
      if (state.showTitles && isTitleless(t)) return false; // hide ‚Äútitleless‚Äù when titles ON
      return true;
    });

    if (state.view === 'favorites'){
      // Reduce to favorites and order by selection sequence
      out = applyFavoritesOrdering(out);
    } else {
      // Normal sort only when not in favorites view
      switch(els.sort?.value||'date_desc'){
        case 'date_desc':
          out.sort((a,b)=>{
            const da=a.date?.getTime()||0, db=b.date?.getTime()||0;
            if (db !== da) return db - da;
            return withinDayIndexFromName(b.name) - withinDayIndexFromName(a.name) || b.name.localeCompare(a.name);
          }); break;
        case 'date_asc':
          out.sort((a,b)=>{
            const da=a.date?.getTime()||0, db=b.date?.getTime()||0;
            if (da !== db) return da - db;
            return withinDayIndexFromName(a.name) - withinDayIndexFromName(b.name) || a.name.localeCompare(b.name);
          }); break;
        case 'bpm_desc':  out.sort((a,b)=> bpmSortValue(b) - bpmSortValue(a)); break;
        case 'bpm_asc':   out.sort((a,b)=> bpmSortValue(a) - bpmSortValue(b)); break;
        case 'len_desc':  out.sort((a,b)=> (b.length||0)-(a.length||0)); break;
        case 'len_asc':   out.sort((a,b)=> (a.length||0)-(b.length||0)); break;
      }
    }

    state.filtered = out;
    const initialChunk = firstPaint ? Math.max(60, state.pageSize) : state.pageSize;
    state.renderCount = Math.min(state.filtered.length, initialChunk);

    if (!keepIndex) state.i = Math.min(state.i, state.renderCount-1);
    renderList();
    setupInfiniteScroll();
    fillViewport();
  }

  const displayName = t => (state.showTitles && t.title) ? t.title : t.name;

  function imgHTML(src){
    const esc = s => s.replace(/"/g,'&quot;');
    return `<img src="${esc(src)}" alt="" loading="lazy"
      style="width:56px;height:56px;border-radius:8px;object-fit:cover;"
      onerror="if(this.dataset.fbk!=='1'){this.dataset.fbk='1';this.onerror=null;this.src='${DEFAULT_THUMB}';}">`;
  }

  function favHTML(t){
    const isOn = state.favorites.has(t.name);
    const glyph = isOn ? '‚òÖ' : '‚òÜ';
    const title = isOn ? 'Unfavourite' : 'Favourite';
    const pressed = isOn ? 'true' : 'false';
    return `<button class="star ${isOn?'on':''}" aria-pressed="${pressed}" data-fav="${escapeHTML(t.name)}" title="${title}">${glyph}</button>`;
  }

  function badgeHTML(t){
    const parts = [favHTML(t), `<a class="pill" href="${t.src}" download title="Download MP3">MP3</a>`];
    if (state.showWavButtons){
      parts.push(`<a class="pill" href="${BASE_WAV + encodeURIComponent(t.base + '.wav')}" download title="Download Lossless">WAV</a>`);
    }
    if (state.showMovButtons && t.video){
      parts.push(`<a class="pill" href="${t.video}" target="_blank" rel="noopener" title="Open Video">MOV</a>`);
    }
    if (state.showMovButtons && !t.video){
      parts.push('<span class="pill muted">MOV</span>');
    }
    return `<div class="badge">${parts.join('\n')}</div>`;
  }

  function rowHTML(t, active){
    const bpmTxt = bpmLabel(t);
    const thumbURL = getResolvedThumb(t);
    const subline = uniqJoin([
      state.showTitles ? '' : (t.title || ''),
      bpmTxt,
      t.length ? fmtDur(t.length) : '',
      t.details || '',
      t.notes ? t.notes : ''
    ]);
    return `<div class="row" role="listitem" data-id="${t.id}">
      <div class="cover" aria-hidden="true">${imgHTML(thumbURL)}</div>
      <div>
        <div class="title">${active ? '‚ñ∂Ô∏é ' : ''}${escapeHTML(displayName(t))}</div>
        <div class="sub">${escapeHTML(subline)}</div>
      </div>
      ${badgeHTML(t)}
    </div>`;
  }

  function renderList(){
    if(!state.filtered.length){
      els.list.innerHTML = '<div class="row"><div></div><div>No results.</div></div>';
      return;
    }
    const slice = state.filtered.slice(0, state.renderCount);
    els.list.innerHTML = slice.map(t=>{
      const active = (state.i>=0 && state.filtered[state.i]?.id===t.id);
      return rowHTML(t, active);
    }).join('') + `<div id="sentinel" style="height:1px"></div>`;
  }

  function rerenderVisibleRowsThumbs(){
    const rows = els.list.querySelectorAll('.row');
    rows.forEach(row=>{
      const id = Number(row.getAttribute('data-id'));
      const t = state.tracks.find(x=>x.id===id);
      if (!t) return;
      const img = row.querySelector('.cover img');
      if (img) img.src = getResolvedThumb(t);
    });
  }

  function rerenderVisibleRowsBadges(){
    const rows = document.querySelectorAll('.row');
    rows.forEach(row=>{
      const id = Number(row.getAttribute('data-id'));
      const t = state.tracks.find(x=>x.id===id);
      if (!t) return;
      const badge = row.querySelector('.badge');
      if (badge) badge.outerHTML = badgeHTML(t);
    });
  }

  function refreshTitles(){
    const rows = document.querySelectorAll('.row');
    rows.forEach(row=>{
      const id = Number(row.getAttribute('data-id'));
      const t = state.tracks.find(x=>x.id===id);
      if (!t) return;
      const titleEl = row.querySelector('.title');
      const subEl = row.querySelector('.sub');
      if (titleEl){
        const isActive = (state.i>=0 && state.filtered[state.i]?.id === id);
        titleEl.innerHTML = (isActive ? '‚ñ∂Ô∏é ' : '') + escapeHTML(displayName(t));
      }
      if (subEl){
        const bpmTxt = bpmLabel(t);
        const subline = uniqJoin([
          state.showTitles ? '' : (t.title || ''),
          bpmTxt,
          t.length ? fmtDur(t.length) : '',
          t.details || '',
          t.notes || ''
        ]);
        subEl.textContent = subline;
      }
    });
    if (state.i>=0) updateNowbar();
  }

  // --- Infinite scroll ---
  let sentinelObserver;
  function setupInfiniteScroll(){
    const sentinel = $('#sentinel');
    if (!sentinel) return;

    if (sentinelObserver) sentinelObserver.disconnect();
    if ('IntersectionObserver' in window){
      sentinelObserver = new IntersectionObserver((entries)=>{
        for (const e of entries){ if (e.isIntersecting) appendChunk(); }
      }, { root: null, rootMargin: '1200px 0px', threshold: 0 });
      sentinelObserver.observe(sentinel);
    }
    window.addEventListener('scroll', onScrollMaybeLoad, { passive: true });
    window.addEventListener('resize', debounce(fillViewport, 120), { passive: true });
  }

  function appendChunk(){
    if (state.renderCount >= state.filtered.length) return;
    const prev = state.renderCount;
    state.renderCount = Math.min(state.filtered.length, state.renderCount + state.pageSize);
    const sentinel = $('#sentinel'); if (!sentinel) return;

    const frag = document.createDocumentFragment();
    for (let i=prev;i<state.renderCount;i++){
      const t = state.filtered[i];
      const div = document.createElement('div');
      div.innerHTML = rowHTML(t, (state.i>=0 && state.filtered[state.i]?.id===t.id));
      frag.appendChild(div.firstChild);
    }
    els.list.insertBefore(frag, sentinel);
  }

  function atBottomBuffer(px=1200){ return (window.scrollY + window.innerHeight + px) >= document.documentElement.scrollHeight; }
  function onScrollMaybeLoad(){ if (atBottomBuffer()) appendChunk(); }

  function fillViewport(){
    let guard = 0;
    while (guard++ < 10) {
      const scrollable = document.documentElement.scrollHeight > window.innerHeight + 200;
      if (scrollable || state.renderCount >= state.filtered.length) break;
      appendChunk();
    }
  }

  function select(indexInFiltered){
    state.i = indexInFiltered;
    const t = state.filtered[indexInFiltered];
    if(!t) return;
    els.audio.src = t.src;
    updateNowbar();
    state.playing = false;
    updateToggle();

    const rendered = els.list.querySelectorAll('.row');
    rendered.forEach(row=>{
      const id = Number(row.getAttribute('data-id'));
      const isActive = (state.filtered[state.i]?.id === id);
      const titleEl = row.querySelector('.title');
      if (titleEl){
        const target = state.tracks.find(x=>x.id===id) || t;
        titleEl.innerHTML = (isActive ? '‚ñ∂Ô∏é ' : '') + escapeHTML(displayName(target));
      }
    });
  }

  function updateNowbar(){
    const t = state.filtered[state.i]; if(!t) return;
    els.nowTitle.textContent = displayName(t);
    const bpmTxt = bpmLabel(t);
    els.nowSub.textContent = uniqJoin([
      state.showTitles ? '' : (t.title || ''),
      bpmTxt,
      t.length ? fmtDur(t.length) : '',
      t.details || '',
      t.notes || ''
    ]);
    const url = getResolvedThumb(t);
    els.cover.innerHTML = `<img src="${url.replace(/"/g,'&quot;')}" alt=""
      style="width:56px;height:56px;object-fit:cover;border-radius:8px"
      onerror="if(this.dataset.fbk!=='1'){this.dataset.fbk='1';this.onerror=null;this.src='${DEFAULT_THUMB}';}">`;
  }

  async function play(){
    try{
      await els.audio.play();
      state.playing = true; updateToggle();
      if('mediaSession' in navigator){
        const t = state.filtered[state.i];
        navigator.mediaSession.metadata = new MediaMetadata({ title: displayName(t) });
        navigator.mediaSession.setActionHandler('previoustrack', ()=> jump(-1));
        navigator.mediaSession.setActionHandler('nexttrack', ()=> jump(1));
        navigator.mediaSession.setActionHandler('seekbackward', ()=> els.audio.currentTime = Math.max(0, els.audio.currentTime-10));
        navigator.mediaSession.setActionHandler('seekforward', ()=> els.audio.currentTime = Math.min(els.audio.duration||0, els.audio.currentTime+10));
      }
    }catch(_){}
  }
  function pause(){ els.audio.pause(); state.playing=false; updateToggle(); }
  function updateToggle(){ const btn=$('#toggle'); if(btn) btn.textContent = state.playing ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è'; }
  function jump(dir){
    if(!state.filtered.length) return;
    let i = state.i + dir;
    if(i < 0) i = state.filtered.length-1;
    if(i >= state.filtered.length) i = 0;
    select(i); play();
  }

  // ---------- MENU / UI wiring ----------
  function buildMenuUI(){
    const tb = els.toolbar;
    if (!tb) return;

    // Clear toolbar; rebuild Level 1 (About, Playlist, Utilities, Shop) + Sort
    tb.innerHTML = '';

    // Sort on the left (kept)
    const sortSel = document.createElement('select');
    sortSel.id = 'sort'; sortSel.title = 'Sort';
    sortSel.innerHTML = `
      <option value="date_desc">Newest</option>
      <option value="date_asc">Oldest</option>
      <option value="bpm_desc">BPM ‚Üì</option>
      <option value="bpm_asc">BPM ‚Üë</option>
      <option value="len_desc">Longest</option>
      <option value="len_asc">Shortest</option>`;
    tb.appendChild(sortSel);
    els.sort = sortSel;

    // Level 1 buttons
    const btnAbout = document.createElement('button');
    btnAbout.className = 'btn'; btnAbout.id='btnAbout'; btnAbout.title='About'; btnAbout.textContent='üé¥';
    const btnPlaylist = document.createElement('button');
    btnPlaylist.className = 'btn'; btnPlaylist.id='btnPlaylist'; btnPlaylist.title='Playlist (favorites)'; btnPlaylist.textContent='üéµ';
    const utilities = document.createElement('details');
    utilities.className = 'submenu';
    utilities.innerHTML = `<summary>üõ†Ô∏è Utilities</summary><div class="sheet-inner" id="utilInner"></div>`;
    const btnShop = document.createElement('a');
    btnShop.className='btn'; btnShop.id='btnShop'; btnShop.href='/shop'; btnShop.target='_blank'; btnShop.rel='noopener'; btnShop.title='Shop'; btnShop.textContent='üõçÔ∏è';

    tb.appendChild(btnAbout);
    tb.appendChild(btnPlaylist);
    tb.appendChild(utilities);
    tb.appendChild(btnShop);

    // Utilities content (toggles + search)
    const inner = utilities.querySelector('#utilInner');
    inner.innerHTML = `
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <button class="tog" id="togTitles" title="Song Titles (on/off)">üìù</button>
        <button class="tog" id="togWav" title="Show WAV buttons">üéöÔ∏è</button>
        <button class="tog" id="togMov" title="Show MOV buttons">üé¨</button>
      </div>
      <div class="search-wrap">
        <input id="searchInput" placeholder="Search‚Ä¶ use #tags (e.g. #mbv)" inputmode="search" />
      </div>
    `;

    const btnTitles = inner.querySelector('#togTitles');
    const btnWav    = inner.querySelector('#togWav');
    const btnMov    = inner.querySelector('#togMov');
    const searchInput = inner.querySelector('#searchInput');

    // Initial toggle states
    const setTog = (el,on)=> el.classList.toggle('on', !!on);
    setTog(btnTitles, state.showTitles);
    setTog(btnWav, state.showWavButtons);
    setTog(btnMov, state.showMovButtons);

    // Wire: About
    btnAbout.addEventListener('click', (e)=>{
      e.preventDefault(); e.stopPropagation();
      alert("VVIP25 ‚Äî Vancouver Music and Videography Project 2025");
      keepMenuOpen(e);
    });

    // Wire: Playlist (favorites view w/ selection order)
    btnPlaylist.addEventListener('click', (e)=>{
      e.preventDefault(); e.stopPropagation();
      state.view = (state.view === 'favorites') ? 'all' : 'favorites';
      applyFilterSort(false /*firstPaint*/, true /*keepIndex*/);
      keepMenuOpen(e);
    });

    // Wire: Toggles
    btnTitles.addEventListener('click', (e)=>{
      e.preventDefault(); e.stopPropagation();
      state.showTitles = !state.showTitles;
      setTog(btnTitles, state.showTitles);
      applyFilterSort(false /*firstPaint*/, true /*keepIndex*/);
      refreshTitles();
      keepMenuOpen(e);
    });
    btnWav.addEventListener('click', (e)=>{
      e.preventDefault(); e.stopPropagation();
      state.showWavButtons = !state.showWavButtons;
      setTog(btnWav, state.showWavButtons);
      rerenderVisibleRowsBadges();
      if (state.i>=0) updateNowbar();
      keepMenuOpen(e);
    });
    btnMov.addEventListener('click', (e)=>{
      e.preventDefault(); e.stopPropagation();
      state.showMovButtons = !state.showMovButtons;
      setTog(btnMov, state.showMovButtons);
      rerenderVisibleRowsBadges();
      if (state.i>=0) updateNowbar();
      keepMenuOpen(e);
    });

    // Wire: Search (lives inside Utilities)
    searchInput.value = state.searchQuery;
    searchInput.addEventListener('input', debounce(()=>{
      state.searchQuery = searchInput.value || '';
      applyFilterSort(false, /*keepIndex=*/true);
    }, 150));

    // Keep overlay open while interacting inside it
    tb.addEventListener('click', keepMenuOpen);
  }

  // Keep menu open helper (only for overlay)
  function keepMenuOpen(e){
    const menu = els.menu;
    if (!menu) return;
    if (e) { e.preventDefault?.(); e.stopPropagation?.(); }
    menu.open = true;
  }

  // ---------------- Events ----------------
  // Row click: select + play; favorites toggling with visible star update
  document.addEventListener('click', (e)=>{
    const favBtn = e.target.closest?.('.star');
    if (favBtn && favBtn.hasAttribute('data-fav')){
      const name = favBtn.getAttribute('data-fav');
      const isOn = state.favorites.has(name);
      if (isOn){
        // remove from Set and ordered array
        state.favorites.delete(name);
        state.favOrder = state.favOrder.filter(n => n !== name);
      } else {
        state.favorites.add(name);
        if (!state.favOrder.includes(name)) state.favOrder.push(name);
      }
      // persist
      localStorage.setItem('vvip25:favs', JSON.stringify(Array.from(state.favorites)));
      localStorage.setItem('vvip25:favs_order', JSON.stringify(state.favOrder));
      // live update glyph + style
      const nowOn = state.favorites.has(name);
      favBtn.classList.toggle('on', nowOn);
      favBtn.textContent = nowOn ? '‚òÖ' : '‚òÜ';
      favBtn.setAttribute('aria-pressed', nowOn ? 'true' : 'false');
      favBtn.title = nowOn ? 'Unfavourite' : 'Favourite';

      // If currently in playlist view, re-filter to reflect removal/addition
      if (state.view === 'favorites'){
        applyFilterSort(false, true);
      }
      e.preventDefault(); e.stopPropagation();
      return;
    }

    const row = e.target.closest?.('.row');
    if(row && !e.target.closest('a')){
      const id = Number(row.getAttribute('data-id'));
      const idx = state.filtered.findIndex(t=>t.id===id);
      if(idx>=0){ select(idx); play(); }
    }
  }, { passive: false });

  // Sort change (ignored in favorites view)
  document.addEventListener('change', (e)=>{
    if (e.target && e.target.id === 'sort'){
      if (state.view !== 'favorites'){
        applyFilterSort(false, /*keepIndex=*/true);
      }
      keepMenuOpen(e);
    }
  }, { passive: true });

  // Player controls ‚Äî never open menu here
  $('#toggle')?.addEventListener('click', ()=>{ if (state.i < 0 && state.filtered.length) select(0); state.playing ? pause() : play(); }, { passive: true });
  els.prev?.addEventListener('click', ()=> jump(-1), { passive: true });
  els.next?.addEventListener('click', ()=> jump(1), { passive: true });

  els.audio.addEventListener('timeupdate', ()=>{
    const a=els.audio; if(!isFinite(a.duration)) return;
    els.seek.max = Math.floor(a.duration);
    els.seek.value = Math.floor(a.currentTime);
    $('#tcur').textContent = fmtDur(a.currentTime);
    $('#tdur').textContent = isFinite(a.duration) ? fmtDur(a.duration) : '0:00';
  });
  els.seek.addEventListener('input', ()=>{ els.audio.currentTime = Number(els.seek.value); });
  els.vol.addEventListener('input', ()=>{ els.audio.volume = parseFloat(els.vol.value); localStorage.setItem('vvip25:vol', els.vol.value); });
  els.audio.addEventListener('ended', ()=> jump(1));

  // ---------------- Cache notes (for you) ----------------
  // ‚Äì We add ?v= and {cache:'no-store'} on JSON fetches.
  // ‚Äì In Cloudflare, BYPASS caching for (path "/" OR extension "html"); leave media cached.
</script>
</body>
</html>